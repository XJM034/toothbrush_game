# è®¾è®¡æ–‡æ¡£

ä¸‹é¢æ˜¯ä¸€ä»½**å¯ç›´æ¥ç”¨äºå¼€å·¥**çš„ã€Šåˆ·ç‰™æ¸¸æˆï¼ˆWeb MVPï¼‰è®¾è®¡æ–‡æ¡£ã€‹ï¼Œç›®æ ‡æ˜¯ï¼š**å…ˆç”¨ Web æœ€å¿«éªŒè¯**ï¼ˆMediaPipe Face Landmarker / Hand Landmarkerï¼Œç±»ä¼¼ Pokemon Smile çš„äº¤äº’èŠ‚å¥ï¼‰ï¼Œåç»­**åŒä¸€å¥—æ ¸å¿ƒé€»è¾‘å¹³æ»‘è¿ç§»åˆ° iOS/Android/æ¡Œé¢ç«¯**ï¼ˆMediaPipe Tasks è·¨å¹³å°ï¼‰ã€‚([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))

---

## 1. é¡¹ç›®ç›®æ ‡ä¸èŒƒå›´

### 1.1 ç›®æ ‡ï¼ˆMVPï¼‰

å®ç°å¦‚ä¸‹é—­ç¯ï¼š

1. è¿›å…¥æ¸¸æˆ â†’ é€‰æ‹©å¡é€šå¤´å¥—
2. ç‚¹å‡»å¼€å§‹ â†’ æ‰“å¼€æ‘„åƒå¤´ â†’ å¤´å¥—å®æ—¶è·Ÿéšäººè„¸
3. æç¤ºå¼ å˜´éœ²ç‰™ â†’ **è¯†åˆ«â€œéœ²å‡ºç‰™é½¿/å¼ å˜´åˆ°ä½â€æ‰å¯è¿›å…¥ä¸‹ä¸€æ­¥**
4. æç¤ºâ€œæ‰‹éƒ¨åˆ·ç‰™åŠ¨ä½œâ€ â†’ **å•æ‰‹æ¡æ‹³å¿«é€Ÿæ™ƒåŠ¨**è¯†åˆ«é€šè¿‡
5. é€šè¿‡ååˆ¤å®šâ€œå®Œæˆåˆ·ç‰™â€å¹¶åŠ ç§¯åˆ†

### 1.2 éç›®æ ‡ï¼ˆMVP å…ˆä¸åšï¼‰

- åˆ·ç‰™æ—¶é•¿åˆ†åŒº/ä¸Šä¸‹å·¦å³åˆ†åŒºåˆ·ç‰™è´¨é‡è¯„åˆ†ï¼ˆåç»­è¿­ä»£ï¼‰
- ç²¾å‡†â€œç‰™é½¿åƒç´ çº§å¯è§â€è¯†åˆ«ï¼ˆMVP ç”¨â€œå¼ å˜´åˆ°ä½/å£éƒ¨å¼€åˆâ€ä»£ç†ï¼›å¯æ‰©å±•ä¸ºè½»é‡åˆ†ç±»å™¨ï¼‰

---

## 2. æŠ€æœ¯é€‰å‹ä¸ä¾æ®

### 2.1 æ ¸å¿ƒ SDK

- **MediaPipe Tasks Vision**
    - **Face Landmarkerï¼ˆWeb JSï¼‰**ï¼šäººè„¸å…³é”®ç‚¹ + è¡¨æƒ…/Blendshapesï¼ˆç”¨äºå˜´éƒ¨å¼€åˆç­‰ä¿¡å·ï¼‰+ æ”¯æŒåšæ»¤é•œ/è™šæ‹Ÿå½¢è±¡çš„èƒ½åŠ›([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
    - **Hand Landmarkerï¼ˆWeb JSï¼‰**ï¼šæ‰‹éƒ¨ 21 å…³é”®ç‚¹ + handedness + world åæ ‡ï¼Œæœ‰åˆ©äºåšâ€œæ¡æ‹³ + æ™ƒåŠ¨é€Ÿåº¦â€åˆ¤æ–­([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/hand_landmarker?utm_source=chatgpt.com))

### 2.2 Web ç«¯æ¨ç†å½¢æ€

- MediaPipe å¯åœ¨æµè§ˆå™¨ä»¥ **WebAssembly** æ–¹å¼è·‘å®æ—¶ç®¡çº¿ï¼ˆé€‚åˆéšç§ã€ä½å»¶è¿Ÿã€å…åç«¯ï¼‰([è°·æ­Œå¼€å‘è€…åšå®¢](https://developers.googleblog.com/en/mediapipe-on-the-web/?utm_source=chatgpt.com))

### 2.3 å•†ç”¨ä¸è®¸å¯

- MediaPipe ä»“åº“è®¸å¯ä¸º **Apache 2.0**ï¼ˆå…è®¸å•†ç”¨ã€ä¿®æ”¹ä¸åˆ†å‘ï¼ŒæŒ‰è®¸å¯æ¡æ¬¾ä¿ç•™å£°æ˜å³å¯ï¼‰([GitHub](https://github.com/google-ai-edge/mediapipe/blob/master/LICENSE?utm_source=chatgpt.com))

---

## 3. ä½“éªŒä¸äº¤äº’æµç¨‹ï¼ˆçŠ¶æ€æœºï¼‰

### 3.1 çŠ¶æ€æœºå®šä¹‰

- `S0_SelectAvatar`ï¼šé€‰æ‹©å¤´å¥—ï¼ˆæœ¬åœ°èµ„æºåˆ—è¡¨ï¼‰
- `S1_CameraInit`ï¼šè¯·æ±‚æ‘„åƒå¤´æƒé™ã€åŠ è½½æ¨¡å‹
- `S2_FaceTracking`ï¼šå¤´å¥—å®æ—¶è·Ÿéšï¼ˆæŒç»­ï¼‰
- `S3_PromptTeeth`ï¼šæç¤ºâ€œå¼ å˜´éœ²ç‰™â€
- `S4_TeethConfirmed`ï¼šéœ²ç‰™/å¼ å˜´åˆ°ä½åˆ¤å®šé€šè¿‡ï¼ˆè¿›å…¥ä¸‹ä¸€æ­¥ï¼‰
- `S5_PromptBrushGesture`ï¼šæç¤ºâ€œå•æ‰‹æ¡æ‹³å¿«é€Ÿæ™ƒåŠ¨â€
- `S6_BrushGestureConfirmed`ï¼šåŠ¨ä½œé€šè¿‡ â†’ å®Œæˆä¸€æ¬¡åˆ·ç‰™
- `S7_Completed`ï¼šå±•ç¤ºç§¯åˆ†ã€åŠ¨æ•ˆã€ä¸‹ä¸€å±€/é€€å‡º

> å…³é”®ç‚¹ï¼šäººè„¸è·Ÿéšï¼ˆS2ï¼‰æ˜¯å¸¸é©»å­ç³»ç»Ÿï¼Œä¸è¦å’Œéœ²ç‰™/æ‰‹åŠ¿åˆ¤å®šè€¦åˆåœ¨ä¸€èµ·ï¼Œé¿å…çŠ¶æ€åˆ‡æ¢å¯¼è‡´æ»¤é•œæŠ–åŠ¨ã€‚
> 

---

## 4. ç³»ç»Ÿæ¶æ„ï¼ˆWeb MVPï¼‰

### 4.1 æ¨¡å—åˆ’åˆ†

**(A) UI å±‚**

- Avatar é€‰æ‹©é¡µï¼ˆå¤´å¥—åˆ—è¡¨ã€é¢„è§ˆï¼‰
- æ¸¸æˆä¸»ç•Œé¢ï¼ˆæ‘„åƒå¤´ç”»é¢ã€æç¤ºæ–‡æ¡ˆã€è¿›åº¦/ç§¯åˆ†ã€è°ƒè¯•å¼€å…³ï¼‰

**(B) è§†è§‰æ¨ç†å±‚ï¼ˆMediaPipeï¼‰**

- `FaceTracker`
    - è¾“å…¥ï¼šè§†é¢‘å¸§
    - è¾“å‡ºï¼šface landmarksã€blendshapesã€ï¼ˆå¯é€‰ï¼‰face transform matrixï¼ˆç”¨äºæ›´ç¨³çš„å¤´å¥—è´´åˆï¼‰([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
- `HandTracker`
    - è¾“å…¥ï¼šè§†é¢‘å¸§
    - è¾“å‡ºï¼šhand landmarksï¼ˆimage/worldï¼‰ã€handedness([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/hand_landmarker?utm_source=chatgpt.com))

**(C) åˆ¤å®šä¸æ¸¸æˆé€»è¾‘å±‚**

- `TeethGate`ï¼ˆéœ²ç‰™/å¼ å˜´åˆ°ä½é—¨æ§›ï¼‰
- `BrushGestureDetector`ï¼ˆæ¡æ‹³ + å¿«é€Ÿæ™ƒåŠ¨ï¼‰
- `GameStateMachine`ï¼ˆæ¨è¿›çŠ¶æ€ã€ç§¯åˆ†ã€èŠ‚å¥ï¼‰

**(D) æ¸²æŸ“å±‚**

- è§†é¢‘æ¸²æŸ“ `<video>`
- è¦†ç›–æ¸²æŸ“ `<canvas>`ï¼šå¤´å¥—ã€å…³é”®ç‚¹è°ƒè¯•ã€æç¤ºåœˆç­‰

### 4.2 æ•°æ®æµ

`getUserMedia()` â†’ VideoFrame â†’ (FaceLandmarker + HandLandmarker) â†’ ç»“æœ â†’ (TeethGate / BrushGestureDetector) â†’ StateMachine â†’ UI & Canvas Render

---

## 5. æ ¸å¿ƒç®—æ³•è®¾è®¡

## 5.1 å¤´å¥—å®æ—¶è·Ÿéšï¼ˆäººè„¸æ»¤é•œï¼‰

**ç›®æ ‡**ï¼šå¤´å¥—åœ¨æ¸¸æˆå…¨è¿‡ç¨‹è·Ÿéšäººè„¸ä½ç½®ã€å°ºåº¦ã€æ—‹è½¬ã€‚

**æ¨èå®ç°ï¼ˆMVP å¯é€‰éš¾åº¦ï¼‰ï¼š**

- ç®€ç‰ˆï¼ˆæœ€å¿«ï¼‰ï¼š
    - å–è„¸éƒ¨å…³é”®ç‚¹ï¼ˆä¾‹å¦‚çœ¼ç›/é¼»å°–/é¢å¤´é™„è¿‘ï¼‰è®¡ç®—ï¼š
        - ä½ç½®ï¼šé¼»å°–æˆ–ä¸¤çœ¼ä¸­å¿ƒ
        - å°ºåº¦ï¼šä¸¤çœ¼è·
        - æ—‹è½¬ï¼šä¸¤çœ¼è¿çº¿è§’åº¦ï¼ˆrollï¼‰
    - åœ¨ Canvas ä¸Šç»˜åˆ¶å¤´å¥— PNGï¼ˆ2D ä»¿å°„å˜æ¢ï¼‰
- ç¨³å®šç‰ˆï¼ˆæ›´ ARï¼‰ï¼š
    - ä½¿ç”¨ Face Mesh/Face Landmarker ä½“ç³»çš„**face transform / facial transformation matrix**åšæ›´ç¨³çš„è´´åˆï¼ˆæ›´æŠ—æŠ–ã€æŠ—è§’åº¦å˜åŒ–ï¼‰([GitHub](https://github.com/google-ai-edge/mediapipe/blob/master/docs/solutions/face_mesh.md?utm_source=chatgpt.com))

**æŠ—æŠ–å¤„ç†**

- å¯¹ä½ç½®ã€å°ºåº¦ã€è§’åº¦åšä¸€é˜¶ä½é€šæ»¤æ³¢ï¼ˆEMAï¼‰ï¼š
    - `smooth = lerp(prev, current, alpha)`ï¼Œalpha å»ºè®® 0.2~0.35
- å½“æ£€æµ‹ä¸¢å¤± faceï¼ˆN å¸§ï¼‰â†’ å¤´å¥—æ¸éšæˆ–é”å®šä¸Šä¸€å¸§å¹¶æç¤ºâ€œè¯·å¯¹å‡†é•œå¤´â€

---

## 5.2 â€œéœ²å‡ºç‰™é½¿â€åˆ¤å®šï¼ˆMVPï¼šå¼ å˜´åˆ°ä½ Gateï¼‰

> ç°å®é‡Œâ€œç‰™é½¿å¯è§â€ä¼šå—å…‰ç…§ã€è‚¤è‰²ã€å˜´å”‡é®æŒ¡å½±å“ã€‚MVP ç”¨â€œå£éƒ¨å¼€åˆåˆ°ä½â€ä½œä¸ºå‡†å…¥ï¼Œåç»­å†å‡çº§ä¸ºâ€œç‰™é½¿åƒç´ çº§å¯è§åˆ†ç±»â€ã€‚
> 

### æ–¹æ¡ˆ Aï¼ˆæ¨è MVPï¼‰ï¼šBlendshapes / Mouth Open ä¿¡å·

Face Landmarker æ”¯æŒè¾“å‡º**è¡¨æƒ…/Blendshapes**([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))

åšæ³•ï¼š

- é€‰æ‹©èƒ½ä»£è¡¨å¼ å˜´çš„ blendshapeï¼ˆä¾‹å¦‚ jawOpen / mouthOpen ç±»ï¼‰
- åˆ¤å®šï¼š`score > T_open` è¿ç»­ç¨³å®š `>= X ms` æ‰ç®—é€šè¿‡
    - å»ºè®®ï¼š`T_open = 0.45~0.6`ï¼ˆéœ€æœºå‹å®æµ‹ï¼‰
    - ç¨³å®šæ—¶é•¿ï¼š300~600msï¼ˆé˜²æ­¢ç¬é—´è¯¯è§¦ï¼‰

### æ–¹æ¡ˆ Bï¼ˆå¤‡é€‰/è¡¥å……ï¼‰ï¼šå…³é”®ç‚¹ Mouth Aspect Ratioï¼ˆMARï¼‰

åŸºäºå”‡éƒ¨å…³é”®ç‚¹è®¡ç®—ä¸Šä¸‹å”‡è·ç¦» / å˜´å®½ï¼Œå¾—åˆ°å¼€å£æ¯”å€¼ MARï¼š

- `MAR = (dist(upperLip, lowerLip) / dist(mouthLeft, mouthRight))`
- åˆ¤å®šï¼š`MAR > T_mar` ä¸”ç¨³å®š X ms

### å¤±è´¥ä¸å¼•å¯¼

- æœªé€šè¿‡ï¼šæç¤ºâ€œå¼ å¤§å˜´å·´ï¼Œéœ²å‡ºç‰™é½¿â€
- é€šè¿‡åï¼šé”å®šè¿›å…¥ä¸‹ä¸€çŠ¶æ€ï¼ˆé¿å…ä¸€ä¼šå„¿é—­å˜´åˆé€€å›é€ æˆä½“éªŒå·®ï¼‰
    - ä½†å¦‚æœåç»­ä½ å¸Œæœ›â€œåˆ·ç‰™è¿‡ç¨‹ä¸­å¿…é¡»æŒç»­å¼ å˜´â€ï¼Œå¯ä»¥åŠ â€œè½¯çº¦æŸâ€ï¼šä½äºé˜ˆå€¼åªæé†’ï¼Œä¸æ‰“æ–­ã€‚

### åç»­å‡çº§ï¼ˆæ›´åƒâ€œéœ²ç‰™â€è€Œéâ€œå¼ å˜´â€ï¼‰

- å– mouth ROIï¼ˆåŸºäºå…³é”®ç‚¹è£å‰ªï¼‰ï¼Œè·‘ä¸€ä¸ªè¶…è½»é‡äºŒåˆ†ç±»æ¨¡å‹ï¼ˆTeethVisible/Notï¼‰ï¼š
    - TFJS/ONNX Runtime Web éƒ½å¯
    - è®­ç»ƒæ•°æ®å¯å…ˆç”¨ä½ è‡ªå·±é‡‡é›† + å°‘é‡å¢å¼ºï¼ˆäº®åº¦/å¯¹æ¯”åº¦/æ¨¡ç³Šï¼‰

---

## 5.3 â€œåˆ·ç‰™åŠ¨ä½œâ€åˆ¤å®šï¼šå•æ‰‹æ¡æ‹³å¿«é€Ÿæ™ƒåŠ¨

### Step 1ï¼šå•æ‰‹æ£€æµ‹ä¸é”å®š

- Hand Landmarker æ”¯æŒå¤šæ‰‹è¾“å‡ºå’Œ handedness([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/hand_landmarker?utm_source=chatgpt.com))
    
    è§„åˆ™ï¼š
    
- ä¼˜å…ˆå–ç”»é¢ä¸­ç½®ä¿¡åº¦æœ€é«˜çš„é‚£åªæ‰‹
- è¦æ±‚è¿ç»­æ£€æµ‹åˆ°æ‰‹ `>= 300ms` æ‰è¿›å…¥â€œæ‰‹åŠ¿åˆ¤å®šâ€

### Step 2ï¼šæ¡æ‹³ï¼ˆFistï¼‰åˆ¤å®š

ç”¨ 21 ç‚¹æ‰‹å…³é”®ç‚¹åšè§„åˆ™åˆ¤å®šï¼ˆæ— éœ€æ¨¡å‹ï¼‰ï¼š

- å¯¹æ¯æ ¹æ‰‹æŒ‡ï¼Œåˆ¤æ–­æŒ‡å°–æ˜¯å¦â€œé è¿‘æŒå¿ƒ/æŒ‡æ ¹â€ï¼š
    - `dist(tip, mcp)` æˆ– `dist(tip, wrist)` å°äºé˜ˆå€¼ï¼ˆé˜ˆå€¼éšæ‰‹å¤§å°å½’ä¸€åŒ–ï¼‰
- ä¾‹å¦‚ï¼šè‡³å°‘ 4 æ ¹æ‰‹æŒ‡æ»¡è¶³â€œå·æ›²â€å³å¯è®¤ä¸ºæ¡æ‹³
- ä¹Ÿå¯åŠ â€œæ‹‡æŒ‡å·æ›²â€ä½œä¸ºæ›´ä¸¥æ ¼æ¡ä»¶ï¼ˆå‡å°‘å¼ å¼€æ‰‹è¯¯è§¦ï¼‰

### Step 3ï¼šå¿«é€Ÿæ™ƒåŠ¨ï¼ˆShakeï¼‰åˆ¤å®š

ç”¨ `wrist` æˆ– `palm center` çš„è½¨è¿¹é€Ÿåº¦ï¼š

- æ¯å¸§è®°å½• `pos(t)`ï¼ˆæ¨èç”¨ world åæ ‡æ›´ç¨³å®šï¼‰([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/hand_landmarker?utm_source=chatgpt.com))
- è®¡ç®—é€Ÿåº¦ï¼š`v = |pos(t)-pos(t-1)| / dt`
- åœ¨ä¸€ä¸ªæ»‘çª—å†…ï¼ˆä¾‹å¦‚ 800msï¼‰ç»Ÿè®¡ï¼š
    - `highSpeedFrames`ï¼ˆv > T_speed çš„å¸§æ•°ï¼‰
    - æˆ–è®¡ç®—èƒ½é‡ï¼š`sum(v^2)`
- åˆ¤å®šé€šè¿‡ï¼š
    - â€œæ¡æ‹³æˆç«‹â€ AND â€œ800ms å†… highSpeedFrames å æ¯” > 35%â€
    - åŒæ—¶å¯åŠ â€œæ–¹å‘æ¥å›å˜åŒ–æ¬¡æ•°ï¼ˆè¿‡é›¶æ¬¡æ•°ï¼‰â€ä»¥æ›´åƒâ€œæ™ƒåŠ¨â€è€Œä¸æ˜¯åŒ€é€Ÿç§»åŠ¨

### é˜²ä½œå¼Š/é²æ£’æ€§

- æ‰‹ç§»å‡ºç”»é¢ï¼šé‡ç½®æ»‘çª—
- å•çº¯æŠŠæ‹³å¤´é è¿‘é•œå¤´çŒ›ç§»åŠ¨ï¼šå¯åŠ å…¥â€œä½ç§»å¹…åº¦ä¸Šé™ + é«˜é¢‘å˜åŒ–â€ç»„åˆçº¦æŸ
- å…è®¸å·¦å³æ‰‹ï¼šhandedness ä¸ä½œé™åˆ¶

---

## 6. å…³é”®å·¥ç¨‹å®ç°ï¼ˆWebï¼‰

### 6.1 æŠ€æœ¯æ ˆå»ºè®®

- å‰ç«¯ï¼šVite + React + TypeScriptï¼ˆæˆ–çº¯ TSï¼‰
- æ¸²æŸ“ï¼šCanvas 2Dï¼ˆMVP è¶³å¤Ÿï¼‰ï¼›åç»­å¯ä¸Š WebGL/Three.js
- MediaPipeï¼š`@mediapipe/tasks-vision`ï¼ˆFaceLandmarker / HandLandmarkerï¼‰

### 6.2 æ€§èƒ½ç›®æ ‡ï¼ˆMVPï¼‰

- 30 FPS ä½“éªŒä¸ºä½³ï¼›æœ€ä½å¯æ¥å— 15 FPS
- æ¨ç†é¢‘ç‡å¯â€œé™é‡‡æ ·â€ï¼š
    - UI æ¸²æŸ“æ¯å¸§
    - Landmarker æ¯ 2 å¸§/3 å¸§è·‘ä¸€æ¬¡ï¼ˆæ ¹æ®è®¾å¤‡è‡ªé€‚åº”ï¼‰
- é™ä½è¾“å…¥åˆ†è¾¨ç‡ï¼ˆä¾‹å¦‚ 640x480ï¼‰æå‡é€Ÿåº¦

### 6.3 ç›¸æœºä¸éšç§

- ä»…æœ¬åœ°å¤„ç†ï¼ˆæµè§ˆå™¨ wasm æ¨ç†ï¼Œé»˜è®¤ä¸ä¸Šä¼ è§†é¢‘æµï¼‰([è°·æ­Œå¼€å‘è€…åšå®¢](https://developers.googleblog.com/en/mediapipe-on-the-web/?utm_source=chatgpt.com))
- UI æ˜ç¤ºï¼šéœ€è¦æ‘„åƒå¤´æƒé™ã€ç”¨é€”ã€æ˜¯å¦å½•åˆ¶ï¼ˆé»˜è®¤ä¸å½•åˆ¶ï¼‰
- è‹¥è¦åŸ‹ç‚¹ï¼šåªä¸Šä¼ â€œäº‹ä»¶æ•°æ®â€ï¼ˆé€šè¿‡/å¤±è´¥/è€—æ—¶/æœºå‹ï¼‰ï¼Œä¸ä¸Šä¼ å›¾åƒ

---

## 7. æ•°æ®ç»“æ„ä¸æ¥å£ï¼ˆå»ºè®®ï¼‰

### 7.1 æ¸¸æˆé…ç½®ï¼ˆå¯ JSONï¼‰

- `avatarAssets[]`ï¼š{ id, name, imgUrl, anchorPointsPreset? }
- é˜ˆå€¼é…ç½®ï¼š
    - `teethOpenThreshold`
    - `teethStableMs`
    - `fistThresholds`ï¼ˆæŒ‰å½’ä¸€åŒ–è·ç¦»ï¼‰
    - `shakeSpeedThreshold`
    - `shakeWindowMs`
    - `shakePassRatio`

### 7.2 è¿è¡Œæ—¶äº‹ä»¶ï¼ˆç”¨äºç§¯åˆ†/åŸ‹ç‚¹ï¼‰

- `EVENT_FACE_DETECTED / LOST`
- `EVENT_TEETH_GATE_PASS`
- `EVENT_FIST_DETECTED`
- `EVENT_SHAKE_PASS`
- `EVENT_GAME_COMPLETE`

---

## 8. æµ‹è¯•æ–¹æ¡ˆï¼ˆåŠ¡å®å¯è½åœ°ï¼‰

### 8.1 åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹

- å…‰ç…§ï¼šå¼ºå…‰/èƒŒå…‰/æ˜æš—
- äººè„¸ï¼šæˆ´çœ¼é•œ/å£ç½©ï¼ˆåº”å¤±è´¥å¹¶æç¤ºï¼‰/ä¸åŒè§’åº¦
- æ‰‹åŠ¿ï¼šç©ºæ‰‹æ™ƒåŠ¨ï¼ˆåº”å¤±è´¥ï¼‰/æ¡æ‹³æ…¢æ‘‡ï¼ˆåº”å¤±è´¥ï¼‰/æ¡æ‹³å¿«æ‘‡ï¼ˆé€šè¿‡ï¼‰
- å¤šäººå…¥é•œï¼šä¼˜å…ˆä¸»è„¸ï¼ˆæœ€å¤§è„¸æˆ–æœ€ä¸­å¿ƒè„¸ï¼‰

### 8.2 è°ƒè¯•å·¥å…·ï¼ˆå¼ºçƒˆå»ºè®®åšï¼‰

- Debug Overlayï¼šæ˜¾ç¤ºå…³é”®ç‚¹ã€å˜´éƒ¨å¼€åˆåˆ†æ•°ã€æ¡æ‹³åˆ¤å®šã€é€Ÿåº¦æ›²çº¿
- é˜ˆå€¼çƒ­æ›´æ–°ï¼šURL å‚æ•°æˆ–é¢æ¿å®æ—¶è°ƒå‚ï¼ˆæå¤§åŠ é€Ÿä½ æ‰¾é˜ˆå€¼ï¼‰

---

## 9. è¿­ä»£è·¯çº¿å›¾

### V0ï¼ˆ1~3 å¤©èƒ½è·‘ï¼‰

- FaceLandmarker è·Ÿè¸ª + å¤´å¥— overlay
- TeethGateï¼ˆå¼ å˜´åˆ°ä½ï¼‰
- HandLandmarker + fist + shake
- çŠ¶æ€æœº + ç§¯åˆ†

### V1ï¼ˆæ›´åƒ Pokemon Smileï¼‰

- åˆ·ç‰™æŒç»­æ—¶é—´ï¼ˆä¾‹å¦‚ 30sï¼‰+ è¿‡ç¨‹é¼“åŠ±
- æ›´ç²¾ç»†çš„â€œåˆ·ç‰™åŠ¨ä½œèŠ‚å¥â€è¯„åˆ†ï¼ˆé¢‘ç‡ã€æŒç»­æ€§ï¼‰
- éŸ³æ•ˆã€ç²’å­åŠ¨æ•ˆã€å¡é€šè§’è‰²åé¦ˆ

### V2ï¼ˆâ€œéœ²ç‰™â€å‡çº§ï¼‰

- mouth ROI + è½»é‡ TeethVisible åˆ†ç±»å™¨ï¼ˆæ˜¾è‘—æå‡â€œéœ²ç‰™â€è¯­ä¹‰å‡†ç¡®åº¦ï¼‰
- æ›´ä¸¥è°¨çš„é˜²ä½œå¼Šç­–ç•¥

---

## 10. è·¨å¹³å°è¿ç§»ç­–ç•¥ï¼ˆiOS / Android / æ¡Œé¢ï¼‰

- MediaPipe Solutions/Tasks æœ¬èº«å¼ºè°ƒå¤šå¹³å°å¯ç”¨([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/guide?utm_source=chatgpt.com))
- è¿ç§»é‡ç‚¹ä¸æ˜¯æ¨¡å‹ï¼Œè€Œæ˜¯ï¼š
    1. æ‘„åƒå¤´å¸§è·å–ä¸æ¸²æŸ“ï¼ˆå„å¹³å° API ä¸åŒï¼‰
    2. åŒä¸€å¥—åˆ¤å®šé€»è¾‘ï¼ˆå»ºè®®æŠ½æˆâ€œplatform-agnosticâ€æ¨¡å—ï¼šé˜ˆå€¼ã€æ»‘çª—ç»Ÿè®¡ã€çŠ¶æ€æœºï¼‰
    3. èµ„æºä¸æƒé™ï¼ˆç›¸æœºæƒé™ã€å‰åå°ã€æ€§èƒ½æ¡£ä½ï¼‰

---

# ä½ æ¥ä¸‹æ¥å¯ä»¥ç›´æ¥å¼€å¹²çš„â€œæœ€å°ä»»åŠ¡æ¸…å•â€

1. æ­ Web å·¥ç¨‹ï¼ˆVite/React/TSï¼‰+ æ‘„åƒå¤´é¢„è§ˆ
2. æ¥å…¥ FaceLandmarkerï¼šæ‹¿åˆ° landmarks + blendshapes([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
3. Canvas å åŠ å¤´å¥—ï¼ˆ2D ç‰ˆæœ¬å…ˆè·‘é€šï¼‰
4. TeethGateï¼šç”¨ jawOpen/mouthOpen åˆ†æ•° + ç¨³å®šæ—¶é—´é—¨æ§›
5. æ¥å…¥ HandLandmarkerï¼šæ‹¿æ‰‹å…³é”®ç‚¹ä¸ handedness([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/hand_landmarker?utm_source=chatgpt.com))
6. Fist + Shakeï¼šæ»‘çª—é€Ÿåº¦åˆ¤å®š
7. çŠ¶æ€æœºä¸²èµ·æ¥ + ç§¯åˆ†å±•ç¤º + debug é¢æ¿

---

## 2.X å·¥ç¨‹æ¡†æ¶ä¸å®ç°è·¯çº¿ï¼ˆæ–°å¢ï¼‰

### 2.X.1 Web MVP æ¨èæ¡†æ¶ï¼ˆç»“è®ºï¼‰

**æ¨èï¼šVite + React + TypeScript + Canvas 2Dï¼ˆOverlay æ¸²æŸ“ï¼‰**

é€‰æ‹©ç†ç”±ï¼š

- Vite æä¾›æå¿«çš„æœ¬åœ°å¯åŠ¨ä¸ HMRï¼Œé€‚åˆä½ è¿™ç§â€œæ‘„åƒå¤´å®æ—¶æ•ˆæœ + é˜ˆå€¼è°ƒå‚â€é«˜é¢‘è¿­ä»£å¼€å‘ã€‚([vitejs](https://vite.dev/?utm_source=chatgpt.com))
- React + TS ä¾¿äºç»„ç»‡â€œçŠ¶æ€æœºï¼ˆS0~S7ï¼‰/è°ƒè¯•é¢æ¿/é˜ˆå€¼é…ç½®/èµ„æºç®¡ç†â€ï¼Œå¹¶èƒ½ç”¨ TS ç±»å‹çº¦æŸè®© AI ç”Ÿæˆä»£ç æ›´ç¨³å®šã€‚
- MediaPipe Web JS å®˜æ–¹ä½¿ç”¨ `@mediapipe/tasks-vision` è·¯çº¿ï¼ˆnpm å®‰è£…æˆ– CDNï¼‰ï¼Œä¸ Vite å·¥ç¨‹åŒ–é›†æˆé¡ºæ»‘ã€‚([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))

> å¤‡é€‰ï¼šVite + Svelteï¼ˆæ›´è½»æ›´å¿«å†™ UIï¼‰ï¼Œä½†ç»¼åˆç”Ÿæ€ä¸é•¿æœŸæ‰©å±•æ€§ï¼ŒReact æ›´ç¨³ã€‚
> 

### 2.X.2 MediaPipe Web æ¥å…¥æ–¹å¼ï¼ˆè¡¥å……è½åœ°ï¼‰

- å®‰è£…æ–¹å¼ï¼šä¼˜å…ˆä½¿ç”¨ **NPM** å®‰è£… `@mediapipe/tasks-vision`ï¼ˆé”ç‰ˆæœ¬ã€å¯æ§ï¼‰([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
- æ¨¡å‹ä¸ wasmï¼š
    - Face Landmarker / Hand Landmarker æŒ‰å®˜æ–¹ç¤ºä¾‹åŠ è½½ wasm root ä¸ modelAssetPathã€‚([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
    - æ¨¡å‹æ–‡ä»¶å»ºè®®æ”¾åœ¨é¡¹ç›®é™æ€èµ„æºç›®å½•ï¼ˆå¦‚ `public/models/...`ï¼‰ï¼Œé¿å…è·¯å¾„åœ¨æ„å»ºåå˜åŒ–ã€‚

---

## 6.X è¿è¡Œç¯å¢ƒä¸â€œå®¹æ˜“æ¼æ‰çš„å‘â€ï¼ˆæ–°å¢æ£€æŸ¥æ¸…å•ï¼‰

### 6.X.1 æ‘„åƒå¤´æƒé™ä¸å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆå¿…é¡»è¡¥é½ï¼‰

- `getUserMedia()` **åªèƒ½åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆHTTPSï¼‰**æˆ–æœ¬åœ° `localhost` ä¸‹ç¨³å®šå·¥ä½œï¼›é HTTPS ç¯å¢ƒä¼šè¢«æµè§ˆå™¨é™åˆ¶/ç¦ç”¨ã€‚([MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia?utm_source=chatgpt.com))
    
    **ç»“è®º**ï¼šä½ çš„ Web MVP å³ä½¿åªæ˜¯æµ‹è¯•ï¼Œä¹Ÿè¦ç”¨ `https://`ï¼ˆæˆ– `localhost`ï¼‰è·‘ã€‚
    

### 6.X.2 iOS / Safari ç›¸å…³ï¼ˆå¼ºçƒˆå»ºè®®çº³å…¥ï¼‰

- iPhone ä¸Š `<video>` å»ºè®®åŠ  `playsinline`ï¼Œå¦åˆ™å¯èƒ½å¼ºåˆ¶å…¨å±æ’­æ”¾ï¼Œå½±å“ Canvas å åŠ ä¸äº¤äº’ä½“éªŒã€‚([webkit.org](https://webkit.org/blog/6784/new-video-policies-for-ios/?utm_source=chatgpt.com))
- è‡ªåŠ¨æ’­æ”¾/æ’­æ”¾ç­–ç•¥ï¼šåœ¨ç§»åŠ¨ç«¯ï¼ˆå°¤å…¶ iOSï¼‰ç»å¸¸éœ€è¦**ç”¨æˆ·æ‰‹åŠ¿**è§¦å‘æ’­æ”¾ï¼Œå»ºè®® UI æµç¨‹æŠŠâ€œå¼€å§‹æ¸¸æˆâ€æŒ‰é’®ä½œä¸ºç»Ÿä¸€çš„ç”¨æˆ·æ‰‹åŠ¿å…¥å£ã€‚([MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Permissions-Policy/autoplay?utm_source=chatgpt.com))

### 6.X.3 ä¸»çº¿ç¨‹é˜»å¡ä¸ Web Workerï¼ˆä¹‹å‰æ–‡æ¡£åº”è¡¥ä¸Šï¼‰

- Face/Hand Landmarker çš„ `detectForVideo()` è°ƒç”¨åœ¨ Web ä¸Šæ˜¯**åŒæ­¥ä¸”ä¼šé˜»å¡ UI çº¿ç¨‹**ï¼›å®˜æ–¹ä¹Ÿæ˜ç¡®å»ºè®®ç”¨ **Web Worker** æŠŠæ¨ç†æŒªåˆ°å­çº¿ç¨‹ä»¥å‡å°‘å¡é¡¿ã€‚([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
    
    **å»ºè®®ï¼ˆMVP æœ€å°å®ç°ï¼‰**ï¼š
    
- å…ˆä¸»çº¿ç¨‹è·‘é€šé—­ç¯ï¼›ä¸€æ—¦å‡ºç°æ˜æ˜¾æ‰å¸§/å¡ UIï¼Œå†æŠŠæ¨ç†å¾ªç¯ç§»å…¥ Workerï¼ˆä¿æŒ API/æ•°æ®ç»“æ„ä¸å˜ï¼Œè¿ç§»æˆæœ¬æœ€ä½ï¼‰ã€‚

### 6.X.4 Cross-Origin Isolationï¼ˆå¯é€‰ï¼Œä½†å»ºè®®æå‰å†™è¿›æ–‡æ¡£ï¼‰

å¦‚æœä½ åç»­æƒ³ç”¨ `SharedArrayBuffer`ï¼ˆä¾‹å¦‚æ›´æ¿€è¿›çš„å¤šçº¿ç¨‹/æ€§èƒ½æ–¹æ¡ˆï¼‰ï¼Œéœ€è¦é¡µé¢æ»¡è¶³ **cross-origin isolated** æ¡ä»¶ï¼š

- `Cross-Origin-Opener-Policy: same-origin`
- `Cross-Origin-Embedder-Policy: require-corp` æˆ– `credentialless`
    
    å¹¶å¯ç”¨ `window.crossOriginIsolated` æ£€æµ‹ã€‚([MDN Web Docs](https://developer.mozilla.org/docs/Web/API/Window/crossOriginIsolated?utm_source=chatgpt.com))
    

> MVP ä¸å¼ºåˆ¶å¼€å¯ï¼Œä½†å»ºè®®åœ¨â€œéƒ¨ç½²/è¿ç»´â€ç« èŠ‚æ ‡æ³¨ï¼šå¦‚æœæœªæ¥è¦åšæ€§èƒ½å‡çº§ï¼Œè¿™ä¸¤ç»„ Header å¯èƒ½è¦ä¸Šã€‚
> 

### 6.X.5 WebAssembly SIMD çš„ç°å®çº¦æŸï¼ˆè¡¥å……è¯´æ˜ï¼‰

- MediaPipe Web ä¾èµ– wasm æ€§èƒ½çº¢åˆ©ï¼›å¤šæ•°ç°ä»£æµè§ˆå™¨æ”¯æŒ WebAssemblyï¼ˆå«å›ºå®šå®½åº¦ SIMDï¼‰ï¼Œä½†ä»å¯èƒ½é‡åˆ°â€œæŸäº›å®‰å…¨æ¨¡å¼/é”å®šæ¨¡å¼ç¦ç”¨ SIMDâ€ç­‰æç«¯æƒ…å†µã€‚([V8](https://v8.dev/features/simd?utm_source=chatgpt.com))
    
    **æ–‡æ¡£å»ºè®®å†™æ³•**ï¼š
    
- â€œæ€§èƒ½ä¸å…¼å®¹æ€§ä»¥æœ€æ–° Chrome/Edge/Firefox/Safari ä¸ºåŸºå‡†ï¼›é‡åˆ°æç«¯æ¨¡å¼é™çº§åˆ°æ›´ä½å¸§ç‡æˆ–æç¤ºä¸æ”¯æŒã€‚â€

---

## 6.X.6 ä½ å¼€å·¥å‰æœ€åçš„â€œç¯å¢ƒé—æ¼è‡ªæ£€â€æ¸…å•ï¼ˆå»ºè®®ç›´æ¥ç…§æ­¤éªŒæ”¶ï¼‰

1. âœ… æœ¬åœ°å¼€å‘æ˜¯å¦åœ¨ `localhost` æˆ– HTTPSï¼Ÿï¼ˆå¦åˆ™æ‘„åƒå¤´ä¸ç¨³ï¼‰([MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia?utm_source=chatgpt.com))
2. âœ… `<video>` æ˜¯å¦è®¾ç½® `playsinline`ï¼ˆç§»åŠ¨ç«¯ä½“éªŒå…³é”®ï¼‰([webkit.org](https://webkit.org/blog/6784/new-video-policies-for-ios/?utm_source=chatgpt.com))
3. âœ… â€œå¼€å§‹æ¸¸æˆâ€æŒ‰é’®æ˜¯å¦ä½œä¸ºç”¨æˆ·æ‰‹åŠ¿å…¥å£ï¼ˆé¿å… autoplay é™åˆ¶ï¼‰([MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Permissions-Policy/autoplay?utm_source=chatgpt.com))
4. âœ… Face/Hand æ¨ç†æ˜¯å¦æŒ‰éœ€é™é‡‡æ ·ï¼ˆæ¯ 2~3 å¸§è·‘ä¸€æ¬¡ï¼‰
5. âœ… æ˜¯å¦é¢„ç•™ Worker åŒ–æ¥å£ï¼ˆdetectForVideo é˜»å¡é£é™©ï¼‰([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
6. âœ… æ¨¡å‹ä¸ wasm è·¯å¾„åœ¨ build åå¯ç”¨ï¼ˆé™æ€èµ„æºç›®å½•/è·¯å¾„ä¸å˜ï¼‰([Google AI for Developers](https://ai.google.dev/edge/mediapipe/solutions/vision/face_landmarker/web_js?utm_source=chatgpt.com))
7. âœ…ï¼ˆå¯é€‰ï¼‰è‹¥æœªæ¥è¦å¤šçº¿ç¨‹/SharedArrayBufferï¼šæ˜¯å¦å…·å¤‡ COOP/COEP é…ç½®èƒ½åŠ›([MDN Web Docs](https://developer.mozilla.org/docs/Web/API/Window/crossOriginIsolated?utm_source=chatgpt.com))

---

## 11. Web MVP å®é™…å®ç°æ€»ç»“ï¼ˆiOS è¿ç§»å‚è€ƒï¼‰

> æœ¬èŠ‚è®°å½• Web MVP çš„å®é™…å®ç°è·¯å¾„ã€å‚æ•°é…ç½®å’Œå…³é”®ä»£ç ç»“æ„ï¼Œä¾› iOS åŸç”Ÿå¼€å‘å‚è€ƒã€‚

### 11.1 é¡¹ç›®ç»“æ„

```
/toothbrush_demo/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ models/                    # MediaPipe æ¨¡å‹æ–‡ä»¶
â”‚       â”œâ”€â”€ face_landmarker.task   # äººè„¸æ£€æµ‹æ¨¡å‹ (~11MB)
â”‚       â””â”€â”€ hand_landmarker.task   # æ‰‹éƒ¨æ£€æµ‹æ¨¡å‹ (~8MB)
â”œâ”€â”€ img/                           # å¤´å¥—å›¾ç‰‡èµ„æº
â”‚   â”œâ”€â”€ cat.png
â”‚   â”œâ”€â”€ dog.png
â”‚   â””â”€â”€ rabbit.png
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mediapipe/                 # MediaPipe å°è£…å±‚
â”‚   â”‚   â”œâ”€â”€ FaceTracker.ts         # äººè„¸è¿½è¸ªå™¨
â”‚   â”‚   â””â”€â”€ HandTracker.ts         # æ‰‹éƒ¨è¿½è¸ªå™¨
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ detectors/             # æ‰‹åŠ¿æ£€æµ‹å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ TeethGate.ts       # éœ²ç‰™æ£€æµ‹
â”‚   â”‚   â”‚   â”œâ”€â”€ Fist.ts            # æ¡æ‹³æ£€æµ‹
â”‚   â”‚   â”‚   â”œâ”€â”€ Shake.ts           # æ™ƒåŠ¨æ£€æµ‹
â”‚   â”‚   â”‚   â””â”€â”€ BrushGesture.ts    # ç»¼åˆåˆ·ç‰™æ‰‹åŠ¿æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ game/
â”‚   â”‚   â”‚   â””â”€â”€ GameStateMachine.ts # æ¸¸æˆçŠ¶æ€æœº
â”‚   â”‚   â”œâ”€â”€ rendering/
â”‚   â”‚   â”‚   â”œâ”€â”€ AvatarRenderer.ts  # å¤´å¥—æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â””â”€â”€ DebugRenderer.ts   # è°ƒè¯•ä¿¡æ¯æ¸²æŸ“
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ geometry.ts        # å‡ ä½•è®¡ç®—å·¥å…·
â”‚   â”‚       â””â”€â”€ smoothing.ts       # EMA å¹³æ»‘ç®—æ³•
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ mediapipe.config.ts    # MediaPipe é…ç½®
â”‚   â”‚   â”œâ”€â”€ default.config.ts      # é»˜è®¤æ¸¸æˆé…ç½®
â”‚   â”‚   â””â”€â”€ avatar.config.ts       # å¤´å¥—é…ç½®
â”‚   â”œâ”€â”€ hooks/                     # React Hooks
â”‚   â”‚   â”œâ”€â”€ useCamera.ts           # æ‘„åƒå¤´ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ useMediaPipe.ts        # MediaPipe æ£€æµ‹å¾ªç¯
â”‚   â”‚   â””â”€â”€ useGameStateMachine.ts # æ¸¸æˆçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ components/                # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ GameScreen.tsx         # æ¸¸æˆä¸»å±å¹•
â”‚   â”‚   â”œâ”€â”€ GamePlayScreen.tsx     # æ¸¸æˆè¿›è¡Œä¸­å±å¹•
â”‚   â”‚   â””â”€â”€ AvatarSelector.tsx     # å¤´å¥—é€‰æ‹©å™¨
â”‚   â””â”€â”€ types/                     # TypeScript ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ mediapipe.types.ts     # MediaPipe ç»“æœç±»å‹
â”‚       â”œâ”€â”€ detector.types.ts      # æ£€æµ‹å™¨ç»“æœç±»å‹
â”‚       â””â”€â”€ game.types.ts          # æ¸¸æˆçŠ¶æ€ç±»å‹
â””â”€â”€ package.json
```

### 11.2 MediaPipe æ¨¡å‹ä¸é…ç½®

#### ä½¿ç”¨çš„æ¨¡å‹

| æ¨¡å‹ | æ–‡ä»¶ | å¤§å° | è¾“å‡º |
|------|------|------|------|
| Face Landmarker v1 | `face_landmarker.task` | ~11MB | 468 ä¸ªäººè„¸å…³é”®ç‚¹ + Blendshapes |
| Hand Landmarker v1 | `hand_landmarker.task` | ~8MB | 21 ä¸ªæ‰‹éƒ¨å…³é”®ç‚¹ + ä¸–ç•Œåæ ‡ |

#### MediaPipe é…ç½®å‚æ•°

```typescript
// src/config/mediapipe.config.ts
{
  wasmPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm',
  faceModelPath: '/models/face_landmarker.task',
  handModelPath: '/models/hand_landmarker.task',
  faceOptions: {
    numFaces: 1,
    minFaceDetectionConfidence: 0.5,
    minFacePresenceConfidence: 0.5,
    minTrackingConfidence: 0.5,
    outputFaceBlendshapes: true,      // é‡è¦ï¼šè¾“å‡ºè¡¨æƒ…ç³»æ•°
    outputFacialTransformationMatrixes: false
  },
  handOptions: {
    numHands: 1,
    minHandDetectionConfidence: 0.5,
    minHandPresenceConfidence: 0.5,
    minTrackingConfidence: 0.5
  }
}
```

#### iOS å¯¹åº”æ–¹æ¡ˆ

- iOS ä½¿ç”¨ **MediaPipe Tasks Swift/ObjC SDK**
- æ¨¡å‹æ–‡ä»¶ç›¸åŒï¼ˆ`.task` æ ¼å¼è·¨å¹³å°é€šç”¨ï¼‰
- é…ç½®å‚æ•°å¯ç›´æ¥è¿ç§»

### 11.3 æ£€æµ‹æ•°æ®æµ

```
æ‘„åƒå¤´ (640Ã—480 @ 30fps)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MediaPipe æ£€æµ‹å±‚                                        â”‚
â”‚  â”œâ”€ FaceTracker.detectForVideo()                        â”‚
â”‚  â”‚   â†’ landmarks[468], blendshapes, faceCenter,         â”‚
â”‚  â”‚     faceScale, faceRotation                          â”‚
â”‚  â””â”€ HandTracker.detectForVideo()                        â”‚
â”‚      â†’ landmarks[21], worldLandmarks, handedness        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰‹åŠ¿æ£€æµ‹å±‚ (BrushGesture)                               â”‚
â”‚  â”œâ”€ TeethGate.detect() â†’ éœ²ç‰™åˆ¤å®š                       â”‚
â”‚  â”œâ”€ Fist.detect() â†’ æ¡æ‹³åˆ¤å®š                            â”‚
â”‚  â””â”€ Shake.detect() â†’ æ™ƒåŠ¨åˆ¤å®š                           â”‚
â”‚  ç»¼åˆè¾“å‡º: stage, isBrushing, confidence                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸¸æˆçŠ¶æ€æœº (GameStateMachine)                           â”‚
â”‚  çŠ¶æ€: init â†’ ready â†’ playing â†’ brushing â†’ success      â”‚
â”‚  è¾“å‡º: gameState, score, remainingTime                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸²æŸ“å±‚                                                  â”‚
â”‚  â”œâ”€ è§†é¢‘å¸§ç»˜åˆ¶                                          â”‚
â”‚  â”œâ”€ AvatarRenderer â†’ å¤´å¥—å åŠ                            â”‚
â”‚  â””â”€ DebugRenderer â†’ è°ƒè¯•ä¿¡æ¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.4 æ ¸å¿ƒæ£€æµ‹ç®—æ³•ä¸å‚æ•°

#### 11.4.1 éœ²ç‰™æ£€æµ‹ (TeethGate)

**æ–‡ä»¶**: `src/core/detectors/TeethGate.ts`

**ç®—æ³•**:
- ä½¿ç”¨ `jawOpen` blendshape åˆ†æ•°
- é˜ˆå€¼åˆ¤å®š + ç¨³å®šæ€§æ£€æµ‹

**å®é™…å‚æ•°**:
```typescript
jawOpenThreshold = 0.4    // jawOpen >= 0.4 è¡¨ç¤ºå˜´å·´å¼ å¼€
requiredStableFrames = 5  // éœ€è¦è¿ç»­ 5 å¸§ (~167ms @ 30fps)
```

**iOS è¿ç§»è¦ç‚¹**:
- MediaPipe iOS SDK åŒæ ·è¾“å‡º blendshapes
- å…³é”® blendshape: `jawOpen`

#### 11.4.2 æ¡æ‹³æ£€æµ‹ (Fist)

**æ–‡ä»¶**: `src/core/detectors/Fist.ts`

**ç®—æ³•**:
- æ£€æµ‹æ‰‹æŒ‡æ˜¯å¦å¼¯æ›²ï¼ˆæŒ‡å°–åˆ°æŒ‡æ ¹è·ç¦» < æ‰‹è…•åˆ°æŒ‡æ ¹è·ç¦» Ã— 0.4ï¼‰
- ç»Ÿè®¡å¼¯æ›²æ‰‹æŒ‡æ•°é‡

**å®é™…å‚æ•°**:
```typescript
curledFingerThreshold = 3  // è‡³å°‘ 3 æ ¹æ‰‹æŒ‡å¼¯æ›²å³è®¤ä¸ºæ¡æ‹³

// æ‰‹éƒ¨å…³é”®ç‚¹ç´¢å¼• (MediaPipe Hand Landmarks)
fingerTipIndices = [4, 8, 12, 16, 20]   // å„æ‰‹æŒ‡é¡¶ç«¯
fingerBaseIndices = [2, 6, 10, 14, 18]  // å„æ‰‹æŒ‡åŸºéƒ¨
wristIndex = 0                           // æ‰‹è…•

// å¼¯æ›²åˆ¤å®š
fingerLength < wristToBase * 0.4  // æ‰‹æŒ‡é•¿åº¦ < æ‰‹è…•åˆ°åŸºéƒ¨è·ç¦»çš„ 40%
```

**iOS è¿ç§»è¦ç‚¹**:
- æ‰‹éƒ¨å…³é”®ç‚¹ç´¢å¼•è·¨å¹³å°ä¸€è‡´
- çº¯å‡ ä½•è®¡ç®—ï¼Œæ— éœ€ä¿®æ”¹

#### 11.4.3 æ™ƒåŠ¨æ£€æµ‹ (Shake)

**æ–‡ä»¶**: `src/core/detectors/Shake.ts`

**ç®—æ³•**:
- è¿½è¸ªæ‰‹æŒä¸­å¿ƒ (landmark 9) çš„è¿åŠ¨è½¨è¿¹
- è®¡ç®—å½’ä¸€åŒ–é€Ÿåº¦
- ç»Ÿè®¡é«˜é€Ÿå¸§å æ¯”

**å®é™…å‚æ•°**:
```typescript
speedThreshold = 0.02      // é€Ÿåº¦é˜ˆå€¼ï¼ˆç›¸å¯¹äº âˆš(widthÃ—height)ï¼‰
windowMs = 500             // æ»‘çª—æ—¶é•¿ 500ms
highSpeedRatio = 0.15      // éœ€è¦ 15% çš„å¸§è¶…è¿‡é€Ÿåº¦é˜ˆå€¼
requiredStableFrames = 4   // éœ€è¦è¿ç»­ 4 å¸§ (~133ms @ 30fps)
maxHistorySize = 15        // ä¿å­˜æœ€è¿‘ 15 å¸§æ•°æ®

// é€Ÿåº¦è®¡ç®—
speed = pixelDistance / âˆš(canvasWidth Ã— canvasHeight)
```

**iOS è¿ç§»è¦ç‚¹**:
- ä½¿ç”¨ world coordinates å¯è·å¾—æ›´ç¨³å®šçš„é€Ÿåº¦è®¡ç®—
- é€Ÿåº¦é˜ˆå€¼å¯èƒ½éœ€è¦æ ¹æ®å®é™…è®¾å¤‡è°ƒæ•´

#### 11.4.4 ç»¼åˆåˆ·ç‰™æ‰‹åŠ¿ (BrushGesture)

**æ–‡ä»¶**: `src/core/detectors/BrushGesture.ts`

**çŠ¶æ€æµè½¬**:
```
waiting â†’ teeth_open â†’ fist_ready â†’ brushing â†’ complete
                â†‘                                  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        (å¯è¿ç»­å¾—åˆ†)
```

**å…³é”®é€»è¾‘**:
```typescript
// éœ²ç‰™é”å®šæœºåˆ¶
teethLockTimeout = 3000    // 3ç§’æ²¡éœ²ç‰™åˆ™è§£é”
teethConfirmed = true/false // é”å®šçŠ¶æ€

// åˆ·ç‰™åŠ¨ä½œåˆ¤å®š
minBrushingDuration = 800  // éœ€è¦æŒç»­æ¡æ‹³+æ™ƒåŠ¨ 800ms

// é˜¶æ®µåˆ¤å®š
if (teethConfirmed) {
  if (isFist && isShaking) {
    if (brushingDuration >= 800ms) {
      stage = 'complete'  // å¾—åˆ†ï¼
    }
  }
}
```

### 11.5 æ¸¸æˆçŠ¶æ€æœº

**æ–‡ä»¶**: `src/core/game/GameStateMachine.ts`

**çŠ¶æ€å®šä¹‰**:
```typescript
type GameState = 'init' | 'ready' | 'playing' | 'brushing' | 'success' | 'gameover'
```

**çŠ¶æ€è½¬æ¢**:
```
init â”€â”€è‡ªåŠ¨â”€â”€> ready â”€â”€éœ²ç‰™â”€â”€> playing â”€â”€æ¡æ‹³+æ™ƒåŠ¨â”€â”€> brushing
                                  â†‘                      â”‚
                                  â”‚                      â”‚ (800ms)
                                  â”‚                      â†“
                              playing <â”€â”€500msâ”€â”€ success
                                  â”‚
                                  â”‚ (3ç§’æ²¡éœ²ç‰™)
                                  â†“
                                ready

                              (60ç§’å)
                                  â†“
                              gameover
```

**è®¡åˆ†è§„åˆ™**:
```typescript
scorePerBrush = 10        // æ¯æ¬¡åˆ·ç‰™åŸºç¡€åˆ†
bonusForAccuracy = 5      // å‡†ç¡®ç‡å¥–åŠ±ï¼ˆÃ— confidenceï¼‰
gameDuration = 60000      // æ¸¸æˆæ—¶é•¿ 60 ç§’
```

### 11.6 å¤´å¥—æ¸²æŸ“ (Face Filter)

**æ–‡ä»¶**: `src/core/rendering/AvatarRenderer.ts`

**å®šä½ç®—æ³•**:
```typescript
// 1. è·å–äººè„¸è¾¹ç•Œä¿¡æ¯
faceBounds = getFaceBoundsFromLandmarks(landmarks, width, height)
// è¿”å›: center, forehead, chin, eyeDistance, faceWidth, faceHeight, rotation

// 2. è®¡ç®—å¤´å¥—ç¼©æ”¾
baseScale = (faceBounds.faceWidth * 2.2) / avatarImage.width
finalScale = baseScale * avatarConfig.scale

// 3. è®¡ç®—ä½ç½®
// faceHoleOffset: è„¸æ´ç›¸å¯¹äºå›¾ç‰‡ä¸­å¿ƒçš„åç§»
// anchorOffset: é¢å¤–ä½ç½®è°ƒæ•´
targetX = faceCenter.x - faceHoleOffsetX + anchorOffsetX
targetY = faceCenter.y - faceHoleOffsetY + anchorOffsetY

// 4. åº”ç”¨å˜æ¢
ctx.translate(targetX, targetY)
ctx.rotate(rotation)
ctx.drawImage(avatar, -width/2, -height/2, width, height)
```

**äººè„¸å…³é”®ç‚¹ç´¢å¼•**:
```typescript
leftEyeIdx = 33      // å·¦çœ¼å¤–ä¾§
rightEyeIdx = 263    // å³çœ¼å¤–ä¾§
foreheadIdx = 10     // é¢å¤´ä¸­å¿ƒ
chinIdx = 152        // ä¸‹å·´
leftFaceIdx = 234    // å·¦è„¸è¾¹ç¼˜
rightFaceIdx = 454   // å³è„¸è¾¹ç¼˜
```

**å¤´å¥—é…ç½®ç¤ºä¾‹**:
```typescript
{
  id: 'dog',
  name: 'ğŸ¶ å°ç‹—',
  imgUrl: '/img/dog.png',
  faceHoleOffset: { x: 0, y: 0.25 },  // è„¸æ´åœ¨å›¾ç‰‡ä¸‹æ–¹ 25%
  anchorOffset: { x: 0, y: -0.15 },   // æ•´ä½“å‘ä¸Šç§»åŠ¨ 15%
  scale: 1.0
}
```

**EMA å¹³æ»‘å‚æ•°**:
```typescript
smoothingAlpha = 0.3  // å¹³æ»‘ç³»æ•°ï¼ˆè¶Šå°è¶Šå¹³æ»‘ï¼Œè¶Šå¤§è¶Šçµæ•ï¼‰

// å¹³æ»‘ç®—æ³•
smooth(prev, current, alpha) {
  return prev * (1 - alpha) + current * alpha
}
```

### 11.7 iOS è¿ç§»æ£€æŸ¥æ¸…å•

#### å¯ç›´æ¥å¤ç”¨çš„éƒ¨åˆ†
- [ ] MediaPipe æ¨¡å‹æ–‡ä»¶ (`.task` æ ¼å¼)
- [ ] æ‰‹åŠ¿æ£€æµ‹ç®—æ³•é€»è¾‘ï¼ˆTeethGate, Fist, Shakeï¼‰
- [ ] æ‰€æœ‰é˜ˆå€¼å‚æ•°
- [ ] æ¸¸æˆçŠ¶æ€æœºé€»è¾‘
- [ ] å¤´å¥—å®šä½ç®—æ³•
- [ ] EMA å¹³æ»‘ç®—æ³•

#### éœ€è¦å¹³å°é€‚é…çš„éƒ¨åˆ†
- [ ] æ‘„åƒå¤´å¸§è·å– (AVCaptureSession)
- [ ] MediaPipe SDK åˆå§‹åŒ– (Swift/ObjC API)
- [ ] æ¸²æŸ“å±‚ (Core Graphics / Metal)
- [ ] UI æ¡†æ¶ (SwiftUI / UIKit)

#### iOS MediaPipe é›†æˆå‚è€ƒ
```swift
// ç¤ºä¾‹ï¼šiOS MediaPipe Tasks åˆå§‹åŒ–
import MediaPipeTasksVision

let faceLandmarker = try FaceLandmarker(
  modelPath: "face_landmarker.task",
  options: FaceLandmarkerOptions(
    numFaces: 1,
    minFaceDetectionConfidence: 0.5,
    outputFaceBlendshapes: true
  )
)

let handLandmarker = try HandLandmarker(
  modelPath: "hand_landmarker.task",
  options: HandLandmarkerOptions(
    numHands: 1,
    minHandDetectionConfidence: 0.5
  )
)
```

### 11.8 æ€§èƒ½å‚è€ƒæ•°æ®

| æŒ‡æ ‡ | Web MVP å®æµ‹å€¼ | iOS å»ºè®®ç›®æ ‡ |
|------|---------------|-------------|
| æ£€æµ‹ FPS | 20-30 | 30 |
| æ¸²æŸ“ FPS | 30 | 60 |
| æ‘„åƒå¤´åˆ†è¾¨ç‡ | 640Ã—480 | 640Ã—480 |
| Face æ£€æµ‹å»¶è¿Ÿ | ~30ms | <20ms |
| Hand æ£€æµ‹å»¶è¿Ÿ | ~25ms | <15ms |
| å†…å­˜å ç”¨ | ~200MB | <150MB |

---