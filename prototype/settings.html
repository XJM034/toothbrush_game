<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="auth_guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <script src="supabase_client.js"></script>
    <title>è®¾ç½®ä¸­å¿ƒ - Brushing Master</title>
    <style>
        /* iOS-like wiggle animation */
        @keyframes wiggle {

            0%,
            100% {
                transform: rotate(-2deg);
            }

            50% {
                transform: rotate(2deg);
            }
        }

        .wiggle {
            animation: wiggle 0.15s ease-in-out infinite;
        }

        /* Horizontal bounce animation for scroll hints */
        @keyframes bounce-x {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(4px);
            }
        }

        .animate-bounce-x {
            animation: bounce-x 1s ease-in-out infinite;
        }

        /* Avatar selection grid */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            cursor: pointer;
            border: 4px solid var(--stroke-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.2s;
        }

        .avatar-option.selected {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px var(--secondary-green);
        }

        .avatar-option:active {
            transform: scale(1.05);
        }

        /* iOS-style context menu */
        .context-menu {
            position: fixed;
            z-index: 150;
            background: white;
            border-radius: 16px;
            border: 4px solid var(--stroke-dark);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            min-width: 160px;
        }

        .context-menu-item {
            padding: 14px 20px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            border-bottom: 2px solid #eee;
            transition: background 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:active {
            background: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #ff4757;
        }

        .context-menu-item.cancel {
            color: #999;
        }

        .context-menu-backdrop {
            position: fixed;
            inset: 0;
            z-index: 149;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Prevent long-press image preview on mobile */
        .profile-avatar img {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        /* Additional mobile text selection prevention */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>

<body class="app-shell safe-area-top pt-12 bg-[var(--bg-light)]">

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-16 left-1/2 -translate-x-1/2 z-[300] opacity-0 scale-95 transition-all duration-300 pointer-events-none">
        <div class="kawaii-card bg-[var(--accent-yellow)] px-6 py-3 flex items-center gap-3 border-[#333]">
            <i class="fas fa-exclamation-circle text-[#333] text-xl" id="toast-icon"></i>
            <span class="font-black text-sm" id="toast-message">æç¤ºä¿¡æ¯</span>
        </div>
    </div>


    <header class="px-6 flex items-center justify-between mb-8 flex-shrink-0">
        <button class="kawaii-button kawaii-button-yellow p-3 rounded-full w-10 h-10 flex items-center justify-center"
            onclick="location.href='home.html'">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="text-2xl font-black uppercase">è®¾ç½®ä¸­å¿ƒ</h1>
        <div class="w-10"></div>
    </header>

    <div class="app-scroll px-6 pb-20 space-y-8">

        <!-- Profiles Section -->
        <section>
            <h3 class="font-black text-sm text-gray-400 mb-4 uppercase tracking-widest">ç”¨æˆ·å­˜æ¡£</h3>
            <div class="relative">
                <div class="flex gap-4 overflow-x-auto pt-3 pl-2 pb-3 items-end scroll-container"
                    id="profiles-container">
                    <!-- Loading skeleton - will be replaced by JS -->
                    <div class="flex gap-4 animate-pulse" id="profiles-skeleton">
                        <div class="flex-shrink-0 flex flex-col items-center gap-2" style="padding-top: 10px;">
                            <div class="w-16 h-16 bg-gray-200 rounded-3xl"></div>
                            <div class="w-12 h-3 bg-gray-200 rounded"></div>
                        </div>
                        <div class="flex-shrink-0 flex flex-col items-center gap-2" style="padding-top: 10px;">
                            <div class="w-16 h-16 bg-gray-200 rounded-3xl"></div>
                            <div class="w-10 h-3 bg-gray-200 rounded"></div>
                        </div>
                    </div>
                </div>
                <!-- Scroll Hint with animated arrow -->
                <div
                    class="scroll-hint-right absolute right-0 top-0 bottom-2 w-10 bg-gradient-to-l from-[#F8F9FA] to-transparent pointer-events-none flex items-center justify-end pr-1 transition-opacity duration-300">
                    <i class="fas fa-chevron-right text-gray-400 text-xs animate-bounce-x"></i>
                </div>
            </div>
            <!-- Long-press hint -->
            <p class="text-xs text-gray-400 mt-2 text-center">
                <i class="fas fa-hand-pointer mr-1"></i>é•¿æŒ‰å¤´åƒå¯ç¼–è¾‘æˆ–åˆ é™¤ç”¨æˆ·
            </p>
        </section>

        <!-- Reminders Section -->
        <section>
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-black text-sm text-gray-400 uppercase tracking-widest">åˆ·ç‰™æé†’</h3>
                <span class="text-xs font-black text-primary-cyan">æœ€å¤š 3 ä¸ª</span>
            </div>
            <!-- Swipe hint -->
            <p class="text-xs text-gray-400 mb-4">
                <i class="fas fa-hand-point-left mr-1"></i>å·¦æ»‘å¡ç‰‡å¯åˆ é™¤æé†’
            </p>
            <div class="space-y-4" id="reminders-container">
                <!-- Reminders will be rendered by JS -->
            </div>
        </section>

        <!-- App Info -->
        <section class="space-y-4">
            <!-- Default Duration -->
            <div class="kawaii-card py-4 cursor-pointer active:bg-gray-50 transition-colors"
                onclick="toggleDurationSelector()">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-black uppercase">é»˜è®¤åˆ·ç‰™æ—¶é•¿</span>
                    <span class="font-black text-[var(--primary-green)]" id="current-duration">2 åˆ†é’Ÿ</span>
                </div>
                <div class="hidden mt-4 pt-4 border-t-2 border-gray-200" id="duration-selector">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="duration-option kawaii-card text-center py-3 px-1 cursor-pointer" data-duration="1">
                            <span class="font-black text-xs whitespace-nowrap">1 åˆ†é’Ÿ</span>
                        </div>
                        <div class="duration-option kawaii-card text-center py-3 px-1 cursor-pointer border-[var(--accent-yellow)] border-[4px]"
                            data-duration="2">
                            <span class="font-black text-xs whitespace-nowrap">2 åˆ†é’Ÿ</span>
                        </div>
                        <div class="duration-option kawaii-card text-center py-3 px-1 cursor-pointer" data-duration="3">
                            <span class="font-black text-xs whitespace-nowrap">3 åˆ†é’Ÿ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ -->
            <div class="kawaii-card py-4 cursor-pointer active:bg-gray-50 transition-colors" onclick="toggleFAQ()">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-black uppercase">åˆ·ç‰™å¸¸è§é—®é¢˜ (FAQ)</span>
                    <i class="fas fa-chevron-down text-gray-300 transition-transform" id="faq-icon"></i>
                </div>
                <div class="hidden mt-4 pt-4 border-t-2 border-gray-200 space-y-4" id="faq-content">
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">ğŸ“± å¦‚ä½•å¼€å§‹åˆ·ç‰™æ¸¸æˆï¼Ÿ</div>
                        <p class="text-xs text-gray-600">ç‚¹å‡»ä¸»é¡µçš„"å¼€å§‹åˆ·ç‰™!"æŒ‰é’®ï¼Œé€‰æ‹©åˆ·ç‰™æ—¶é•¿ï¼ˆ1-3åˆ†é’Ÿï¼‰ï¼Œç„¶åç‚¹å‡»å¼€å§‹å³å¯ã€‚åˆ·ç‰™æ—¶éœ€è¦å¯¹å‡†å±å¹•å±•ç¤ºçš„ç‰™é½¿åŒºåŸŸå“¦ï¼</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">ğŸª™ é‡‘å¸æœ‰ä»€ä¹ˆç”¨ï¼Ÿæ€ä¹ˆè·å¾—ï¼Ÿ</div>
                        <p class="text-xs text-gray-600">é‡‘å¸å¯ä»¥ç”¨æ¥å…‘æ¢æ–°çš®è‚¤ï¼æ¯æ¬¡å®Œæˆåˆ·ç‰™æ¸¸æˆä¼šè·å¾—1-8æšé‡‘å¸ï¼Œåˆ·ç‰™æ—¶é—´è¶Šé•¿ã€å‡»è´¥ç»†èŒè¶Šå¤šï¼Œé‡‘å¸è¶Šå¤šã€‚</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">ğŸ® çš®è‚¤æ€ä¹ˆè§£é”ï¼Ÿ</div>
                        <p class="text-xs text-gray-600">å‰å¾€ã€Œæ”¶è—å¤¹ã€é¡µé¢ï¼Œç‚¹å‡»é”å®šçš„çš®è‚¤å³å¯æŸ¥çœ‹ä»·æ ¼ã€‚æ”’å¤Ÿé‡‘å¸åç‚¹å‡»"ç¡®è®¤å…‘æ¢"å³å¯è§£é”ï¼çŒ«å¤´é¹°æ˜¯å…è´¹é»˜è®¤çš®è‚¤ã€‚</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">â­ ç§¯åˆ†å’Œé‡Œç¨‹ç¢‘æ˜¯ä»€ä¹ˆï¼Ÿ</div>
                        <p class="text-xs text-gray-600">ç§¯åˆ†è®°å½•ä½ çš„æ€»æ¸¸æˆè¿›åº¦ã€‚è¾¾æˆ100ã€500ã€1000ç­‰é‡Œç¨‹ç¢‘ä¼šæœ‰ç‰¹åˆ«æ ‡è®°ã€‚è¿ç»­åˆ·ç‰™è¿˜æœ‰é¢å¤–ç§¯åˆ†å¥–åŠ±ï¼</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">ğŸ”¥ è¿ç»­åˆ·ç‰™æœ‰ä»€ä¹ˆå¥–åŠ±ï¼Ÿ</div>
                        <p class="text-xs text-gray-600">æ¯å¤©åšæŒåˆ·ç‰™å¯ä»¥ç´¯ç§¯è¿ç»­å¤©æ•°ï¼è¿ç»­7å¤©ã€30å¤©ã€60å¤©éƒ½æœ‰å¯¹åº”æˆå°±è§£é”ï¼ŒåŒæ—¶æ¯å¤©è¿˜æœ‰é¢å¤–ç§¯åˆ†åŠ æˆã€‚</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å¦‚ä½•æ·»åŠ å¤šä¸ªç”¨æˆ·ï¼Ÿ</div>
                        <p class="text-xs text-gray-600">åœ¨ã€Œç”¨æˆ·å­˜æ¡£ã€åŒºåŸŸç‚¹å‡»"+"æŒ‰é’®å³å¯æ·»åŠ æ–°ç”¨æˆ·ï¼ˆæœ€å¤š5ä¸ªï¼‰ã€‚é•¿æŒ‰å¤´åƒå¯ä»¥ç¼–è¾‘æˆ–åˆ é™¤ç”¨æˆ·ã€‚æ¯ä¸ªç”¨æˆ·çš„è¿›åº¦ç‹¬ç«‹ä¿å­˜ã€‚</p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4">
                        <div class="font-black text-sm mb-2">ğŸ“¸ å¦‚ä½•ä½¿ç”¨æ‹ç…§è£…é¥°åŠŸèƒ½ï¼Ÿ</div>
                        <p class="text-xs text-gray-600">åˆ·ç‰™å®Œæˆåå¯ä»¥ç»™ç…§ç‰‡æ·»åŠ è´´çº¸è£…é¥°ï¼ç‚¹å‡»è´´çº¸æ·»åŠ ï¼Œæ‹–åŠ¨è°ƒæ•´ä½ç½®ï¼Œç¼–è¾‘å®Œæˆåå¯ä»¥ä¿å­˜æˆ–åˆ†äº«ã€‚</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- é€€å‡ºç™»å½• -->
        <section class="mt-4">
            <button onclick="confirmLogout()"
                class="kawaii-card w-full py-4 cursor-pointer active:bg-red-50 transition-colors border-red-400 touch-manipulation">
                <div class="flex justify-center items-center gap-3">
                    <i class="fas fa-sign-out-alt text-red-500 text-lg"></i>
                    <span class="text-sm font-black uppercase text-red-500">é€€å‡ºç™»å½•</span>
                </div>
            </button>
        </section>

    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-black text-center mb-4" id="user-modal-title">æ·»åŠ æ–°ç”¨æˆ·</h2>
                <input type="text" id="new-user-name" placeholder="è¾“å…¥ç”¨æˆ·å" inputmode="text" autocapitalize="words"
                    enterkeyhint="done"
                    class="w-full kawaii-card bg-gray-50 py-3 px-4 text-center font-black mb-4 focus:outline-none focus:border-[var(--accent-yellow)] focus:border-[4px]">

                <!-- Avatar Selection -->
                <p class="text-xs font-black text-gray-400 uppercase mb-3 text-center">é€‰æ‹©å¤´åƒ</p>
                <div class="avatar-grid justify-center mb-6" id="avatar-grid">
                    <!-- Avatars will be rendered by JS -->
                </div>

                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closeAddUserModal()">å–æ¶ˆ</button>
                    <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-sm"
                        onclick="confirmAddUser()">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- iOS-style Context Menu (appears on long-press) -->
    <div id="context-menu-backdrop" class="context-menu-backdrop hidden" onclick="cancelEditMode()"></div>
    <div id="context-menu" class="context-menu hidden">
        <div class="context-menu-item danger" onclick="handleRemoveUser()">ç§»é™¤ç”¨æˆ·</div>
        <div class="context-menu-item" onclick="openEditUserModal()">ç¼–è¾‘ä¿¡æ¯</div>
        <div class="context-menu-item cancel" onclick="cancelEditMode()">å–æ¶ˆ</div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="delete-user-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-black text-center mb-4">ç¡®è®¤åˆ é™¤</h2>
                <p class="text-center text-gray-600 mb-6">ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ã€‚</p>
                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closeDeleteUserModal()">å–æ¶ˆ</button>
                    <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-sm bg-red-500 border-red-700"
                        onclick="confirmDeleteUser()">åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-sign-out-alt text-red-500 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-black">ç¡®è®¤é€€å‡º</h2>
                </div>
                <p class="text-center text-gray-600 mb-6">ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ</p>
                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closeLogoutModal()">å–æ¶ˆ</button>
                    <button class="flex-1 kawaii-button kawaii-button-red py-3 text-sm"
                        onclick="executeLogout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal (Native Input) -->
    <div id="time-picker-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-black text-center mb-6" id="time-picker-title">è®¾ç½®æé†’æ—¶é—´</h2>

                <!-- Native Time Input with Custom Styling -->
                <div class="flex justify-center mb-6">
                    <div class="kawaii-card bg-gray-50 p-4 w-full">
                        <input type="time" id="native-time-picker"
                            class="w-full text-center text-3xl font-black bg-transparent outline-none" value="07:30">
                    </div>
                </div>

                <!-- Quick Time Presets -->
                <div class="grid grid-cols-4 gap-2 mb-6">
                    <button
                        class="kawaii-card bg-yellow-50 py-2 text-xs font-black active:scale-95 transition-transform"
                        onclick="setQuickTime('07:00')">7:00</button>
                    <button
                        class="kawaii-card bg-yellow-50 py-2 text-xs font-black active:scale-95 transition-transform"
                        onclick="setQuickTime('08:00')">8:00</button>
                    <button class="kawaii-card bg-blue-50 py-2 text-xs font-black active:scale-95 transition-transform"
                        onclick="setQuickTime('19:00')">19:00</button>
                    <button class="kawaii-card bg-blue-50 py-2 text-xs font-black active:scale-95 transition-transform"
                        onclick="setQuickTime('20:00')">20:00</button>
                </div>

                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closeTimePickerModal()">å–æ¶ˆ</button>
                    <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-sm"
                        onclick="confirmTimePicker()">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reminder Edit Modal -->
    <div id="reminder-edit-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <h2 class="text-xl font-black text-center mb-6" id="reminder-edit-title">ç¼–è¾‘æé†’</h2>

                <!-- Name Input -->
                <div class="mb-6">
                    <label class="text-xs font-black text-gray-400 uppercase block mb-2">æé†’åç§°</label>
                    <input type="text" id="edit-reminder-name" placeholder="è¾“å…¥æé†’åç§°" inputmode="text"
                        autocapitalize="sentences" enterkeyhint="done"
                        class="w-full kawaii-card bg-gray-50 py-3 px-4 text-center font-black focus:outline-none focus:border-[var(--accent-yellow)] focus:border-[4px]">
                </div>

                <!-- Time Picker -->
                <div class="mb-6">
                    <label class="text-xs font-black text-gray-400 uppercase block mb-2 text-center">æé†’æ—¶é—´</label>
                    <div class="flex justify-center items-center gap-3">
                        <div class="flex flex-col items-center">
                            <button class="text-xl text-gray-400 mb-1" onclick="adjustEditTime('hour', 1)"><i
                                    class="fas fa-chevron-up"></i></button>
                            <div class="kawaii-card bg-gray-50 w-16 py-3 flex items-center justify-center">
                                <span class="text-2xl font-black" id="edit-picker-hour">07</span>
                            </div>
                            <button class="text-xl text-gray-400 mt-1" onclick="adjustEditTime('hour', -1)"><i
                                    class="fas fa-chevron-down"></i></button>
                        </div>
                        <span class="text-2xl font-black">:</span>
                        <div class="flex flex-col items-center">
                            <button class="text-xl text-gray-400 mb-1" onclick="adjustEditTime('minute', 1)"><i
                                    class="fas fa-chevron-up"></i></button>
                            <div class="kawaii-card bg-gray-50 w-16 py-3 flex items-center justify-center">
                                <span class="text-2xl font-black" id="edit-picker-minute">30</span>
                            </div>
                            <button class="text-xl text-gray-400 mt-1" onclick="adjustEditTime('minute', -1)"><i
                                    class="fas fa-chevron-down"></i></button>
                        </div>
                        <div class="flex flex-col items-center">
                            <button class="text-xl text-gray-400 mb-1" onclick="toggleEditAmPm()"><i
                                    class="fas fa-chevron-up"></i></button>
                            <div
                                class="kawaii-card bg-[var(--accent-yellow)] w-14 py-3 flex items-center justify-center">
                                <span class="text-lg font-black" id="edit-picker-ampm">AM</span>
                            </div>
                            <button class="text-xl text-gray-400 mt-1" onclick="toggleEditAmPm()"><i
                                    class="fas fa-chevron-down"></i></button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closeReminderEditModal()">å–æ¶ˆ</button>
                    <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-sm"
                        onclick="confirmReminderEdit()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== PREVENT CONTEXT MENU ON MOBILE =====
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('selectstart', (e) => e.preventDefault());

        // ===== DATA MANAGEMENT =====
        // è·å–å½“å‰ç”¨æˆ·çš„ localStorage key
        function getStorageKey() {
            const user = BrushingMasterDB.getCurrentUser();
            if (user && user.id) {
                return `brushingMasterSettings_${user.id}`;
            }
            return 'brushingMasterSettings';
        }

        const defaultData = {
            profiles: [],  // é»˜è®¤ä¸ºç©ºï¼Œè®©ç”¨æˆ·ä»æ•°æ®åº“åˆ›å»º
            reminders: [
                { id: 1, name: 'æ—©æ™¨åˆ·ç‰™', time: '07:30 AM', icon: 'fa-sun', iconColor: 'text-yellow-500', enabled: true },
                { id: 2, name: 'ç¡å‰åˆ·ç‰™', time: '08:00 PM', icon: 'fa-moon', iconColor: 'text-blue-500', enabled: true }
            ],
            defaultDuration: 2
        };

        function getData() {
            const key = getStorageKey();
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : { ...defaultData };
        }

        function saveData(data) {
            const key = getStorageKey();
            localStorage.setItem(key, JSON.stringify(data));
        }

        // ===== PROFILES =====
        // Available avatars (using user-provided images)
        const availableAvatars = [
            { id: 'owl', name: 'çŒ«å¤´é¹°', file: 'Avatar_ima/çŒ«å¤´é¹°_åœ£è¯å¸½.png' },
            { id: 'cat', name: 'å¸ƒå¶çŒ«', file: 'Avatar_ima/å¸ƒå¶çŒ«å¡é€šå¤´åƒ.png' },
            { id: 'dog', name: 'ç‹—ç‹—', file: 'Avatar_ima/ç‹—ç‹—å¤´åƒ.png' },
            { id: 'rabbit', name: 'å…”å­', file: 'Avatar_ima/å…”å­å¤´åƒ.png' },
            { id: 'panda', name: 'ç†ŠçŒ«', file: 'Avatar_ima/ç†ŠçŒ«å¤´åƒ_é»‘è‰²æè¾¹.png' },
            { id: 'fox', name: 'ç‹ç‹¸', file: 'Avatar_ima/ç‹ç‹¸å¤´åƒ.png' },
            { id: 'bear', name: 'ç†Š', file: 'Avatar_ima/ç†Šå¤´åƒ.png' },
            { id: 'snake', name: 'å°è›‡', file: 'Avatar_ima/å°è›‡_çº¢è‰²å°å˜´.png' }
        ];
        let selectedAvatar = availableAvatars[0].id;
        let isEditMode = false;
        let editingProfileId = null;
        let longPressTimer = null;
        let wiggleProfileId = null;

        function getAvatarPath(avatarId) {
            const avatar = availableAvatars.find(a => a.id === avatarId);
            if (avatar) return avatar.file;
            // Fallback to first avatar
            return availableAvatars[0].file;
        }

        function renderProfiles() {
            const data = getData();
            const container = document.getElementById('profiles-container');
            let html = '';

            data.profiles.forEach(profile => {
                const isActive = profile.active === true;
                const activeStyle = isActive ? 'box-shadow: 0 0 0 4px #7ed56f !important;' : '';
                const opacityClass = isActive ? '' : 'opacity-50';
                const wiggleClass = (wiggleProfileId !== null && String(wiggleProfileId) === String(profile.id)) ? 'wiggle' : '';

                // Get avatar path
                const avatarSrc = getAvatarPath(profile.avatar);

                html += `
                    <div class="flex-shrink-0 flex flex-col items-center gap-2 relative ${wiggleClass}" 
                         style="padding-top: 10px; padding-right: 10px;"
                         data-profile-id="${profile.id}">
                        <div class="w-16 h-16 kawaii-card p-0 flex items-center justify-center overflow-hidden cursor-pointer profile-avatar" 
                             style="${activeStyle} -webkit-backface-visibility: hidden; -webkit-transform: translate3d(0, 0, 0);"
                             data-profile-id="${profile.id}"
                             onclick="handleProfileClick('${profile.id}')">
                            <div class="w-full h-full bg-white flex items-center justify-center overflow-hidden ${opacityClass}" style="border-radius: 20px;">
                                <img src="${avatarSrc}" class="w-10 h-10 object-contain" alt="avatar">
                            </div>
                        </div>
                        <span class="text-xs font-black uppercase">${profile.name}</span>
                    </div>
                `;
            });

            // Always show add user button (grayed out if at max)
            const isAtMax = data.profiles.length >= 5;
            const opacityClass = isAtMax ? 'opacity-40' : '';
            html += `
                <div id="add-user-btn" class="flex-shrink-0 flex flex-col items-center gap-2 cursor-pointer ${opacityClass}" style="padding-top: 10px;" onclick="handleAddUserClick()">
                    <div class="w-16 h-16 border-4 border-dashed border-[#333] rounded-3xl flex items-center justify-center text-gray-300">
                        <i class="fas fa-plus"></i>
                    </div>
                    <span class="text-xs font-black uppercase">æ·»åŠ ç”¨æˆ·</span>
                </div>
            `;

            container.innerHTML = html;
            initLongPressHandlers();
        }

        function handleProfileClick(id) {
            if (wiggleProfileId === id) {
                // Already in wiggle mode, do nothing on click
                return;
            }
            selectProfile(id);
        }

        async function selectProfile(id) {
            const data = getData();
            data.profiles.forEach(p => p.active = (String(p.id) === String(id)));
            saveData(data);
            renderProfiles();

            // è·å–é€‰ä¸­çš„æ¡£æ¡ˆ
            const selectedProfile = data.profiles.find(p => String(p.id) === String(id));

            // ç«‹å³æ›´æ–°ç¼“å­˜ï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œç¡®ä¿è¿”å›ä¸»é¡µæ—¶æ˜¾ç¤ºæ­£ç¡®ï¼‰
            if (selectedProfile) {
                const immediateCache = {
                    id: selectedProfile.dbId || selectedProfile.id,
                    profile_name: selectedProfile.name,
                    avatar_id: selectedProfile.avatar || 'owl',
                    total_xp: selectedProfile.total_xp || 0,
                    diamonds: selectedProfile.diamonds || 0,
                    streak_days: selectedProfile.streak_days || 0,
                    total_sessions: selectedProfile.total_sessions || 0,
                    total_brush_minutes: selectedProfile.total_brush_minutes || 0
                };
                localStorage.setItem('cachedActiveProfile', JSON.stringify(immediateCache));
                console.log('âœ… æ¡£æ¡ˆç¼“å­˜å·²ç«‹å³æ›´æ–°ï¼ˆæœ¬åœ°æ•°æ®ï¼‰');
            }

            // åŒæ—¶åŒæ­¥åˆ°æ•°æ®åº“ï¼ˆåå°æ‰§è¡Œï¼Œä¸é˜»å¡ç”¨æˆ·æ“ä½œï¼‰
            try {
                const user = BrushingMasterDB.getCurrentUser();
                if (user) {
                    // å°†æœ¬åœ° ID è½¬æ¢ä¸ºæ•°æ®åº“ profile ID
                    // æ£€æŸ¥è¯¥ profile æ˜¯å¦åœ¨æ•°æ®åº“ä¸­å­˜åœ¨
                    const allDbProfiles = await BrushingMasterDB.getAllProfiles(user.id);

                    let dbProfile = null;
                    if (selectedProfile && selectedProfile.dbId) {
                        // ä½¿ç”¨æ•°æ®åº“IDæ¿€æ´»
                        dbProfile = await BrushingMasterDB.setActiveProfile(user.id, selectedProfile.dbId);
                        localStorage.setItem('activeProfileId', selectedProfile.dbId);
                        console.log('å·²åŒæ­¥åˆ°æ•°æ®åº“: æ¿€æ´»æ¡£æ¡ˆ', selectedProfile.name);
                    } else if (allDbProfiles.length > 0) {
                        // å°è¯•åŒ¹é…åç§°
                        const matchingDbProfile = allDbProfiles.find(p => p.profile_name === selectedProfile?.name);
                        if (matchingDbProfile) {
                            dbProfile = await BrushingMasterDB.setActiveProfile(user.id, matchingDbProfile.id);
                            localStorage.setItem('activeProfileId', matchingDbProfile.id);
                            // ä¿å­˜æ˜ å°„
                            selectedProfile.dbId = matchingDbProfile.id;
                            saveData(data);
                            console.log('å·²åŒæ­¥åˆ°æ•°æ®åº“: æ¿€æ´»æ¡£æ¡ˆ', matchingDbProfile.profile_name);
                        }
                    }

                    // ä½¿ç”¨æ•°æ®åº“æ•°æ®æ›´æ–°ç¼“å­˜ï¼ˆæ›´å‡†ç¡®çš„æ•°æ®ï¼‰
                    if (dbProfile) {
                        const cacheData = {
                            id: dbProfile.id,
                            profile_name: dbProfile.profile_name,
                            avatar_id: dbProfile.avatar_id,
                            total_xp: dbProfile.total_xp || 0,
                            diamonds: dbProfile.diamonds || 0,
                            streak_days: dbProfile.streak_days || 0,
                            total_sessions: dbProfile.total_sessions || 0,
                            total_brush_minutes: dbProfile.total_brush_minutes || 0
                        };
                        localStorage.setItem('cachedActiveProfile', JSON.stringify(cacheData));
                        console.log('âœ… æ¡£æ¡ˆç¼“å­˜å·²æ›´æ–°ï¼ˆæ•°æ®åº“æ•°æ®ï¼‰');
                    }
                }
            } catch (error) {
                console.error('åŒæ­¥æ¡£æ¡ˆåˆ°æ•°æ®åº“å¤±è´¥:', error);
            }
        }

        // Long-press handlers for edit mode
        function initLongPressHandlers() {
            const avatars = document.querySelectorAll('.profile-avatar');
            avatars.forEach(avatar => {
                const profileId = avatar.dataset.profileId; // ä¸ç”¨ parseIntï¼Œæ”¯æŒ UUID

                // Touch events
                avatar.addEventListener('touchstart', (e) => {
                    // Add visual feedback immediately
                    avatar.style.transform = 'scale(0.95)';
                    avatar.style.transition = 'transform 0.1s ease';

                    longPressTimer = setTimeout(() => {
                        // Pulse effect before triggering
                        avatar.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            avatar.style.transform = '';
                            startWiggleMode(profileId, avatar);
                        }, 100);
                    }, 600); // 600ms long press
                }, { passive: true });

                avatar.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                    avatar.style.transform = '';
                });

                avatar.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                    avatar.style.transform = '';
                });

                // Mouse events for desktop
                avatar.addEventListener('mousedown', () => {
                    // Add visual feedback immediately
                    avatar.style.transform = 'scale(0.95)';
                    avatar.style.transition = 'transform 0.1s ease';

                    longPressTimer = setTimeout(() => {
                        // Pulse effect before triggering
                        avatar.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            avatar.style.transform = '';
                            startWiggleMode(profileId, avatar);
                        }, 100);
                    }, 600);
                });

                avatar.addEventListener('mouseup', () => {
                    clearTimeout(longPressTimer);
                    avatar.style.transform = '';
                });

                avatar.addEventListener('mouseleave', () => {
                    clearTimeout(longPressTimer);
                    avatar.style.transform = '';
                });
            });
        }

        function startWiggleMode(profileId, avatarElement) {
            // Get position BEFORE re-rendering, as renderProfiles will remove avatarElement from DOM
            const rect = avatarElement.getBoundingClientRect();

            wiggleProfileId = profileId;
            renderProfiles();

            const menu = document.getElementById('context-menu');
            const backdrop = document.getElementById('context-menu-backdrop');

            // Find best position
            // Default: center horizontally relative to avatar
            const menuWidth = 160; // Min-width from CSS
            let left = rect.left + (rect.width / 2) - (menuWidth / 2);

            // Clamp to viewport edges (with 16px padding)
            const padding = 16;
            const maxLeft = window.innerWidth - menuWidth - padding;

            left = Math.max(padding, Math.min(left, maxLeft));

            // Position menu below the avatar
            menu.style.left = left + 'px';
            menu.style.top = (rect.bottom + 10) + 'px';

            backdrop.classList.remove('hidden');
            menu.classList.remove('hidden');
        }

        function cancelEditMode() {
            wiggleProfileId = null;
            document.getElementById('context-menu').classList.add('hidden');
            document.getElementById('context-menu-backdrop').classList.add('hidden');
            renderProfiles();
        }

        function handleRemoveUser() {
            if (wiggleProfileId === null) return;

            const data = getData();
            if (data.profiles.length <= 1) {
                showToast('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç”¨æˆ·ï¼');
                cancelEditMode();
                return;
            }

            // Open delete confirmation modal
            pendingDeleteUserId = wiggleProfileId;
            document.getElementById('context-menu').classList.add('hidden');
            document.getElementById('context-menu-backdrop').classList.add('hidden');
            document.getElementById('delete-user-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function openEditUserModal() {
            if (wiggleProfileId === null) return;

            const data = getData();
            const profile = data.profiles.find(p => String(p.id) === String(wiggleProfileId));
            if (!profile) return;

            editingProfileId = wiggleProfileId;
            document.getElementById('user-modal-title').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('new-user-name').value = profile.name;
            selectedAvatar = profile.avatar || 'owl';
            renderAvatarGrid();

            document.getElementById('context-menu').classList.add('hidden');
            document.getElementById('context-menu-backdrop').classList.add('hidden');
            wiggleProfileId = null;
            renderProfiles();

            document.getElementById('add-user-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        async function deleteProfile(id) {
            const data = getData();
            if (data.profiles.length <= 1) {
                showToast('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç”¨æˆ·ï¼');
                return;
            }

            // Find the profile to delete (for database sync)
            const profileToDelete = data.profiles.find(p => String(p.id) === String(id));
            if (!profileToDelete) {
                showToast('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·');
                return;
            }

            // Sync to database FIRST (before updating UI)
            const dbId = profileToDelete.dbId || profileToDelete.id;
            try {
                await BrushingMasterDB.deleteProfile(dbId);
                console.log('å·²ä»æ•°æ®åº“åˆ é™¤æ¡£æ¡ˆ:', profileToDelete.name);

                // Only update local data and UI AFTER successful DB delete
                data.profiles = data.profiles.filter(p => String(p.id) !== String(id));
                if (!data.profiles.some(p => p.active)) {
                    data.profiles[0].active = true;
                }
                saveData(data);
                renderProfiles();
                showToast('è§’è‰²å·²åˆ é™¤', 'success');
            } catch (error) {
                console.error('ä»æ•°æ®åº“åˆ é™¤æ¡£æ¡ˆå¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                throw error; // Re-throw so confirmDeleteUser knows it failed
            }
        }

        let pendingDeleteUserId = null;

        function openDeleteUserModal(id) {
            pendingDeleteUserId = id;
            document.getElementById('delete-user-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteUserModal() {
            pendingDeleteUserId = null;
            wiggleProfileId = null; // Stop wiggle animation
            document.getElementById('delete-user-modal').classList.add('hidden');
            document.body.style.overflow = '';
            renderProfiles(); // Re-render to remove wiggle class
        }

        async function confirmDeleteUser() {
            if (pendingDeleteUserId !== null) {
                // Show loading state on delete button
                const deleteBtn = document.querySelector('#delete-user-modal button[onclick="confirmDeleteUser()"]');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>åˆ é™¤ä¸­...';
                deleteBtn.disabled = true;

                try {
                    await deleteProfile(pendingDeleteUserId);
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                } finally {
                    // Reset button state
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                }
            }
            wiggleProfileId = null;
            closeDeleteUserModal();
        }

        function renderAvatarGrid() {
            const grid = document.getElementById('avatar-grid');
            let html = '';

            availableAvatars.forEach(avatar => {
                const selectedClass = avatar.id === selectedAvatar ? 'selected' : '';
                html += `
                    <div class="avatar-option ${selectedClass}" onclick="selectAvatar('${avatar.id}')">
                        <img src="${avatar.file}" class="w-8 h-8 object-contain">
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function selectAvatar(avatarId) {
            selectedAvatar = avatarId;
            renderAvatarGrid();
        }

        function openAddUserModal() {
            editingProfileId = null;
            document.getElementById('user-modal-title').textContent = 'æ·»åŠ æ–°ç”¨æˆ·';
            document.getElementById('add-user-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('new-user-name').value = '';
            selectedAvatar = availableAvatars[Math.floor(Math.random() * availableAvatars.length)].id;
            renderAvatarGrid();
        }

        function handleAddUserClick() {
            const data = getData();
            if (data.profiles.length >= 5) {
                showToast('æœ€å¤šåªèƒ½æ·»åŠ 5ä¸ªç”¨æˆ·ï¼');
                return;
            }
            openAddUserModal();
        }

        function closeAddUserModal() {
            document.getElementById('add-user-modal').classList.add('hidden');
            document.body.style.overflow = '';
            editingProfileId = null;
        }

        async function confirmAddUser() {
            const name = document.getElementById('new-user-name').value.trim();
            if (!name) {
                showToast('è¯·è¾“å…¥ç”¨æˆ·åï¼');
                return;
            }

            // Show loading state on confirm button
            const confirmBtn = document.querySelector('#add-user-modal button[onclick="confirmAddUser()"]');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>åˆ›å»ºä¸­...';
            confirmBtn.disabled = true;

            const data = getData();
            const user = BrushingMasterDB.getCurrentUser();

            // Check for duplicate name (exclude current profile if editing)
            const duplicateProfile = data.profiles.find(p =>
                p.name.toLowerCase() === name.toLowerCase() &&
                (editingProfileId === null || String(p.id) !== String(editingProfileId))
            );
            if (duplicateProfile) {
                showToast('å·²å­˜åœ¨åŒåè§’è‰²ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°ï¼');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                return;
            }

            if (editingProfileId !== null) {
                // Editing existing user
                const profile = data.profiles.find(p => String(p.id) === String(editingProfileId));
                if (profile) {
                    profile.name = name;
                    profile.avatar = selectedAvatar;

                    // åŒæ­¥åˆ°æ•°æ®åº“
                    if (user && profile.dbId) {
                        try {
                            await BrushingMasterDB.updateProfile(profile.dbId, {
                                profile_name: name,
                                avatar_id: selectedAvatar
                            });
                            console.log('å·²åŒæ­¥åˆ°æ•°æ®åº“: æ›´æ–°æ¡£æ¡ˆ', name);
                        } catch (error) {
                            console.error('åŒæ­¥æ›´æ–°å¤±è´¥:', error);
                        }
                    }
                }
            } else {
                // Adding new user
                if (data.profiles.length >= 5) {
                    showToast('æœ€å¤šåªèƒ½æ·»åŠ 5ä¸ªç”¨æˆ·ï¼');
                    return;
                }
                const newId = Math.max(...data.profiles.map(p => p.id), 0) + 1;
                const newProfile = { id: newId, name: name, avatar: selectedAvatar, active: data.profiles.length === 0 };

                // åˆ›å»ºåˆ°æ•°æ®åº“
                if (user) {
                    try {
                        const dbProfile = await BrushingMasterDB.createProfile(user.id, name, selectedAvatar);
                        newProfile.dbId = dbProfile.id;
                        if (dbProfile.is_active) {
                            newProfile.active = true;
                            localStorage.setItem('activeProfileId', dbProfile.id);
                        }
                        console.log('å·²åˆ›å»ºæ•°æ®åº“æ¡£æ¡ˆ:', dbProfile);
                        showToast('è§’è‰²åˆ›å»ºæˆåŠŸï¼', 'success');
                    } catch (error) {
                        console.error('åˆ›å»ºæ•°æ®åº“æ¡£æ¡ˆå¤±è´¥:', error);
                        // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        let errorMsg = 'åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•';
                        if (error.message) {
                            if (error.message.includes('unique') || error.message.includes('duplicate')) {
                                errorMsg = 'è¯¥è§’è‰²åå·²å­˜åœ¨ï¼';
                            } else if (error.message.includes('violates foreign key')) {
                                errorMsg = 'è¯·å…ˆç¡®ä¿è´¦å·å·²æ­£ç¡®ç™»å½•';
                            } else {
                                console.log('é”™è¯¯è¯¦æƒ…:', error.message);
                            }
                        }
                        showToast(errorMsg);
                        // Reset button state
                        confirmBtn.innerHTML = originalText;
                        confirmBtn.disabled = false;
                        return;
                    }
                } else {
                    console.warn('æœªç™»å½•ï¼Œæ— æ³•åˆ›å»ºæ•°æ®åº“æ¡£æ¡ˆ');
                    showToast('è¯·å…ˆç™»å½•è´¦å·');
                    // Reset button state
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    return;
                }

                data.profiles.push(newProfile);
            }

            saveData(data);
            // Reset button state before closing
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
            // Ensure wiggle mode is off for new profiles
            wiggleProfileId = null;
            renderProfiles();
            closeAddUserModal();
        }

        // ===== REMINDERS =====
        let currentReminderId = null;
        let pickerHour = 7;
        let pickerMinute = 30;
        let pickerAmPm = 'AM';

        function renderReminders() {
            const data = getData();
            const container = document.getElementById('reminders-container');
            let html = '';

            data.reminders.forEach(reminder => {
                html += `
                    <div class="relative overflow-hidden rounded-3xl" id="reminder-wrapper-${reminder.id}">
                        <div class="absolute right-0 top-0 bottom-0 w-20 bg-red-500 flex items-center justify-center rounded-3xl">
                            <button class="text-white font-black text-xs" onclick="deleteReminder(${reminder.id})">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </div>
                        <div class="kawaii-card flex justify-between items-center py-4 cursor-pointer bg-white transition-transform reminder-swipeable" 
                             data-reminder-id="${reminder.id}"
                             style="transform: translateX(0);">
                            <div class="flex items-center gap-4">
                                <i class="fas ${reminder.icon} ${reminder.iconColor} text-xl w-6 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-black uppercase">${reminder.name}</div>
                                    <div class="text-xs font-bold text-gray-400">${reminder.time}</div>
                                </div>
                            </div>
                            <div class="kawaii-switch ${reminder.enabled ? 'on' : ''} kawaii-switch-green" 
                                 onclick="event.stopPropagation(); toggleReminder(${reminder.id})"
                                 ontouchstart="event.stopPropagation();"
                                 ontouchend="event.stopPropagation(); toggleReminder(${reminder.id});">
                                <div class="kawaii-switch-toggle"></div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (data.reminders.length < 3) {
                html += `
                    <div class="kawaii-card flex justify-between items-center py-4 opacity-50 cursor-pointer active:bg-gray-50 transition-colors" onclick="openReminderEditModal(null)">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-plus text-gray-400 text-xl"></i>
                            <span class="text-sm font-black uppercase text-gray-400">æ·»åŠ æé†’</span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            initSwipeHandlers();
        }

        function toggleReminder(id) {
            const data = getData();
            const reminder = data.reminders.find(r => r.id === id);
            if (reminder) {
                reminder.enabled = !reminder.enabled;
                saveData(data);
                renderReminders();
            }
        }

        function deleteReminder(id) {
            const data = getData();
            data.reminders = data.reminders.filter(r => r.id !== id);
            saveData(data);
            renderReminders();
        }

        // ===== REMINDER EDIT MODAL =====
        let editReminderId = null;
        let editHour = 7;
        let editMinute = 30;
        let editAmPm = 'AM';

        function openReminderEditModal(id) {
            const data = getData();

            if (id === null) {
                // Add new reminder mode
                editReminderId = null;
                document.getElementById('edit-reminder-name').value = '';
                editHour = 12;
                editMinute = 0;
                editAmPm = 'PM';
                document.getElementById('reminder-edit-title').textContent = 'æ·»åŠ æé†’';
            } else {
                // Edit existing reminder mode
                const reminder = data.reminders.find(r => r.id === id);
                if (!reminder) return;

                editReminderId = id;
                document.getElementById('edit-reminder-name').value = reminder.name;
                const timeParts = reminder.time.match(/(\d+):(\d+)\s*(AM|PM)/);
                editHour = parseInt(timeParts[1]);
                editMinute = parseInt(timeParts[2]);
                editAmPm = timeParts[3];
                document.getElementById('reminder-edit-title').textContent = 'ç¼–è¾‘æé†’';
            }

            updateEditTimeDisplay();
            document.getElementById('reminder-edit-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeReminderEditModal() {
            editReminderId = null;
            document.getElementById('reminder-edit-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function adjustEditTime(type, delta) {
            if (type === 'hour') {
                editHour += delta;
                if (editHour > 12) editHour = 1;
                if (editHour < 1) editHour = 12;
            } else {
                editMinute += delta * 5;
                if (editMinute >= 60) editMinute = 0;
                if (editMinute < 0) editMinute = 55;
            }
            updateEditTimeDisplay();
        }

        function toggleEditAmPm() {
            editAmPm = editAmPm === 'AM' ? 'PM' : 'AM';
            updateEditTimeDisplay();
        }

        function updateEditTimeDisplay() {
            document.getElementById('edit-picker-hour').textContent = String(editHour).padStart(2, '0');
            document.getElementById('edit-picker-minute').textContent = String(editMinute).padStart(2, '0');
            document.getElementById('edit-picker-ampm').textContent = editAmPm;
        }

        function confirmReminderEdit() {
            const name = document.getElementById('edit-reminder-name').value.trim();
            if (!name) {
                // Use toast instead of alert for consistency
                document.getElementById('edit-reminder-name').classList.add('border-red-500', 'border-[4px]');
                setTimeout(() => {
                    document.getElementById('edit-reminder-name').classList.remove('border-red-500', 'border-[4px]');
                }, 1500);
                return;
            }

            const timeStr = `${String(editHour).padStart(2, '0')}:${String(editMinute).padStart(2, '0')} ${editAmPm}`;
            const data = getData();

            if (editReminderId === null) {
                // Add new reminder
                const icons = ['fa-bell', 'fa-clock', 'fa-star'];
                const colors = ['text-purple-500', 'text-green-500', 'text-red-500'];
                const newId = data.reminders.length > 0 ? Math.max(...data.reminders.map(r => r.id)) + 1 : 1;
                const iconIndex = data.reminders.length % icons.length;

                data.reminders.push({
                    id: newId,
                    name: name,
                    time: timeStr,
                    icon: icons[iconIndex],
                    iconColor: colors[iconIndex],
                    enabled: true
                });
            } else {
                // Edit existing reminder
                const reminder = data.reminders.find(r => r.id === editReminderId);
                if (reminder) {
                    reminder.name = name;
                    reminder.time = timeStr;
                }
            }

            saveData(data);
            renderReminders();
            closeReminderEditModal();
        }

        // Swipe to delete handlers - separates tap from swipe
        function initSwipeHandlers() {
            const swipeables = document.querySelectorAll('.reminder-swipeable');
            swipeables.forEach(el => {
                let startX = 0;
                let currentX = 0;
                let hasMoved = false;
                let isDragging = false;
                const MOVE_THRESHOLD = 10; // pixels - movement below this is considered a tap

                // Touch events
                let touchedOnSwitch = false;
                el.addEventListener('touchstart', (e) => {
                    // Check if touched on toggle switch
                    touchedOnSwitch = e.target.closest('.kawaii-switch') !== null;
                    if (touchedOnSwitch) return; // Don't track drag for switch touches

                    startX = e.touches[0].clientX;
                    currentX = startX;
                    hasMoved = false;
                    isDragging = true;
                    el.style.transition = 'none';
                }, { passive: true });

                el.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    const diff = currentX - startX;
                    if (Math.abs(diff) > MOVE_THRESHOLD) {
                        hasMoved = true;
                    }
                    if (diff < 0 && diff > -80) {
                        el.style.transform = `translateX(${diff}px)`;
                    }
                }, { passive: true });

                el.addEventListener('touchend', () => {
                    if (touchedOnSwitch) {
                        touchedOnSwitch = false;
                        return; // Skip - switch handles its own touch
                    }
                    isDragging = false;
                    el.style.transition = 'transform 0.3s ease';
                    const diff = currentX - startX;

                    if (!hasMoved) {
                        // It was a tap - open edit modal
                        const reminderId = el.dataset.reminderId;
                        if (reminderId) {
                            openReminderEditModal(parseInt(reminderId));
                        }
                        el.style.transform = 'translateX(0)';
                    } else if (diff < -40) {
                        // Swiped left enough - show delete
                        el.style.transform = 'translateX(-80px)';
                    } else {
                        // Not enough swipe - reset
                        el.style.transform = 'translateX(0)';
                    }
                });

                // Mouse events for desktop testing
                let clickedOnSwitch = false;
                el.addEventListener('mousedown', (e) => {
                    // Check if clicked on toggle switch
                    clickedOnSwitch = e.target.closest('.kawaii-switch') !== null;
                    if (clickedOnSwitch) return; // Don't track drag for switch clicks

                    startX = e.clientX;
                    currentX = startX;
                    hasMoved = false;
                    isDragging = true;
                    el.style.transition = 'none';
                    e.preventDefault();
                });

                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    currentX = e.clientX;
                    const diff = currentX - startX;
                    if (Math.abs(diff) > MOVE_THRESHOLD) {
                        hasMoved = true;
                    }
                    if (diff < 0 && diff > -80) {
                        el.style.transform = `translateX(${diff}px)`;
                    }
                };

                const handleMouseUp = () => {
                    if (clickedOnSwitch) {
                        clickedOnSwitch = false;
                        return; // Skip - switch handles its own click
                    }
                    if (!isDragging) return;
                    isDragging = false;
                    el.style.transition = 'transform 0.3s ease';
                    const diff = currentX - startX;

                    if (!hasMoved) {
                        // It was a click - open edit modal
                        const reminderId = el.dataset.reminderId;
                        if (reminderId) {
                            openReminderEditModal(parseInt(reminderId));
                        }
                        el.style.transform = 'translateX(0)';
                    } else if (diff < -40) {
                        // Swiped left enough - show delete
                        el.style.transform = 'translateX(-80px)';
                    } else {
                        // Not enough swipe - reset
                        el.style.transform = 'translateX(0)';
                    }
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        function openTimePickerForReminder(id) {
            const data = getData();
            const reminder = data.reminders.find(r => r.id === id);
            if (reminder) {
                currentReminderId = id;
                // Convert AM/PM time to 24h format for native input
                const timeParts = reminder.time.match(/(\d+):(\d+)\s*(AM|PM)/);
                let hour = parseInt(timeParts[1]);
                const minute = parseInt(timeParts[2]);
                const ampm = timeParts[3];

                if (ampm === 'PM' && hour !== 12) hour += 12;
                if (ampm === 'AM' && hour === 12) hour = 0;

                const timeValue = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                document.getElementById('native-time-picker').value = timeValue;
                document.getElementById('time-picker-title').textContent = 'ç¼–è¾‘æé†’æ—¶é—´';
                document.getElementById('time-picker-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function openTimePickerForNewReminder() {
            currentReminderId = null;
            document.getElementById('native-time-picker').value = '12:00';
            document.getElementById('time-picker-title').textContent = 'æ·»åŠ æ–°æé†’';
            document.getElementById('time-picker-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeTimePickerModal() {
            document.getElementById('time-picker-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Quick time preset function
        function setQuickTime(time) {
            document.getElementById('native-time-picker').value = time;
        }

        // Convert 24h time to AM/PM format for storage
        function formatTimeForStorage(time24) {
            const [hourStr, minuteStr] = time24.split(':');
            let hour = parseInt(hourStr);
            const minute = minuteStr;
            const ampm = hour >= 12 ? 'PM' : 'AM';

            if (hour === 0) hour = 12;
            else if (hour > 12) hour -= 12;

            return `${String(hour).padStart(2, '0')}:${minute} ${ampm}`;
        }

        function confirmTimePicker() {
            const time24 = document.getElementById('native-time-picker').value;
            if (!time24) {
                showToast('è¯·é€‰æ‹©æ—¶é—´ï¼');
                return;
            }

            const timeStr = formatTimeForStorage(time24);
            const data = getData();

            if (currentReminderId) {
                const reminder = data.reminders.find(r => r.id === currentReminderId);
                if (reminder) reminder.time = timeStr;
            } else {
                const newId = data.reminders.length > 0 ? Math.max(...data.reminders.map(r => r.id)) + 1 : 1;
                const icons = [
                    { icon: 'fa-sun', color: 'text-yellow-500' },
                    { icon: 'fa-moon', color: 'text-blue-500' },
                    { icon: 'fa-star', color: 'text-purple-500' }
                ];
                const iconData = icons[data.reminders.length] || icons[0];
                data.reminders.push({
                    id: newId,
                    name: `æé†’ ${newId}`,
                    time: timeStr,
                    icon: iconData.icon,
                    iconColor: iconData.color,
                    enabled: true
                });
            }

            saveData(data);
            renderReminders();
            closeTimePickerModal();
        }

        // ===== DURATION SELECTOR =====
        function toggleDurationSelector() {
            const selector = document.getElementById('duration-selector');
            selector.classList.toggle('hidden');
        }

        function initDurationSelector() {
            const data = getData();
            document.getElementById('current-duration').textContent = `${data.defaultDuration} åˆ†é’Ÿ`;

            document.querySelectorAll('.duration-option').forEach(opt => {
                const duration = parseInt(opt.dataset.duration);
                if (duration === data.defaultDuration) {
                    opt.classList.add('border-[var(--accent-yellow)]', 'border-[4px]');
                } else {
                    opt.classList.remove('border-[var(--accent-yellow)]', 'border-[4px]');
                }
                opt.onclick = (e) => {
                    e.stopPropagation();
                    selectDuration(duration);
                };
            });
        }

        function selectDuration(duration) {
            const data = getData();
            data.defaultDuration = duration;
            saveData(data);
            document.getElementById('current-duration').textContent = `${duration} åˆ†é’Ÿ`;
            document.querySelectorAll('.duration-option').forEach(opt => {
                if (parseInt(opt.dataset.duration) === duration) {
                    opt.classList.add('border-[var(--accent-yellow)]', 'border-[4px]');
                } else {
                    opt.classList.remove('border-[var(--accent-yellow)]', 'border-[4px]');
                }
            });
            // Collapse selector after selection
            document.getElementById('duration-selector').classList.add('hidden');
        }

        // Click outside to collapse duration selector
        document.addEventListener('click', function (e) {
            const durationCard = document.querySelector('[onclick="toggleDurationSelector()"]');
            const selector = document.getElementById('duration-selector');
            if (durationCard && !durationCard.contains(e.target) && !selector.classList.contains('hidden')) {
                selector.classList.add('hidden');
            }
        });

        // ===== FAQ =====
        function toggleFAQ() {
            const content = document.getElementById('faq-content');
            const icon = document.getElementById('faq-icon');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        // ===== TOAST FUNCTION =====
        function showToast(message, type = 'warning') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastMessage.textContent = message;

            // Set icon based on type
            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle text-[var(--primary-green)] text-xl';
            } else {
                toastIcon.className = 'fas fa-exclamation-circle text-[#333] text-xl';
            }

            toast.classList.remove('opacity-0', 'scale-95');
            toast.classList.add('opacity-100', 'scale-100');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'scale-100');
                toast.classList.add('opacity-0', 'scale-95');
            }, 2000);
        }

        // ===== INIT =====
        // ä»æ•°æ®åº“åŒæ­¥æ¡£æ¡ˆæ•°æ®
        async function syncProfilesFromDB() {
            try {
                const user = BrushingMasterDB.getCurrentUser();
                if (!user) {
                    // No user logged in, just render local data
                    renderProfiles();
                    return;
                }

                const dbProfiles = await BrushingMasterDB.getAllProfiles(user.id);
                console.log('ä»æ•°æ®åº“åŒæ­¥æ¡£æ¡ˆ:', dbProfiles);

                const localData = getData();
                // è½¬æ¢æ•°æ®åº“æ ¼å¼ä¸ºæœ¬åœ°æ ¼å¼
                localData.profiles = dbProfiles.map(p => ({
                    id: p.id,
                    dbId: p.id,
                    name: p.profile_name,
                    avatar: p.avatar_id,
                    active: p.is_active,
                    total_xp: p.total_xp || 0,
                    diamonds: p.diamonds || 0,
                    streak_days: p.streak_days || 0,
                    total_sessions: p.total_sessions || 0,
                    total_brush_minutes: p.total_brush_minutes || 0
                }));

                // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ¡£æ¡ˆè¢«æ¿€æ´»
                if (localData.profiles.length > 0 && !localData.profiles.some(p => p.active)) {
                    console.log('æ²¡æœ‰æ¿€æ´»çš„æ¡£æ¡ˆï¼Œè‡ªåŠ¨æ¿€æ´»ç¬¬ä¸€ä¸ª');
                    localData.profiles[0].active = true;
                    // åŒæ­¥æ¿€æ´»çŠ¶æ€åˆ°æ•°æ®åº“
                    try {
                        await BrushingMasterDB.setActiveProfile(user.id, localData.profiles[0].id);
                    } catch (e) {
                        console.error('åŒæ­¥æ¿€æ´»çŠ¶æ€å¤±è´¥:', e);
                    }
                }

                saveData(localData);
                renderProfiles();

                // è®¾ç½®æ´»è·ƒæ¡£æ¡ˆID
                const activeProfile = localData.profiles.find(p => p.active);
                if (activeProfile) {
                    localStorage.setItem('activeProfileId', activeProfile.id);
                } else {
                    localStorage.removeItem('activeProfileId');
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å¼•æ ‡è®°
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'create_guide' && localData.profiles.length === 0) {
                    showCreateProfileGuide();
                }

            } catch (error) {
                console.error('åŒæ­¥æ¡£æ¡ˆå¤±è´¥:', error);
                // On error, still render from local data to remove skeleton
                renderProfiles();
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºè§’è‰²æŒ‡å¼•
        function showCreateProfileGuide() {
            // ç­‰å¾…DOMæ¸²æŸ“
            setTimeout(() => {
                const addBtn = document.getElementById('add-user-btn');
                if (!addBtn) return;

                const rect = addBtn.getBoundingClientRect();

                // åˆ›å»ºæµ®åŠ¨çš„æ‰‹æŒ‡æŒ‡å¼•
                const guide = document.createElement('div');
                guide.className = 'fixed inset-0 z-50 pointer-events-none flex flex-col bg-black/50 overflow-hidden';

                // è®¡ç®—ä½ç½®ï¼šæ”¾åœ¨æŒ‰é’®ä¸‹æ–¹
                const left = rect.left + rect.width / 2;
                const top = rect.bottom + 10;

                guide.innerHTML = `
                    <div class="absolute flex flex-col items-center gap-2 animate-bounce transition-all duration-300" 
                         style="left: ${left}px; top: ${top}px; transform: translateX(-50%);">
                        <i class="fas fa-hand-point-up text-5xl text-white drop-shadow-md"></i>
                        <span class="bg-white px-3 py-1 rounded-lg font-black text-xs shadow-lg text-[var(--primary-green)] whitespace-nowrap">ç‚¹å‡»æ·»åŠ æˆå‘˜</span>
                    </div>
                    <!-- é«˜äº®åŒºåŸŸï¼ˆå¯é€‰ï¼‰ï¼šä½¿ç”¨ box-shadow æ¨¡æ‹ŸæŒ–ç©ºæ•ˆæœ -->
                    <div class="absolute inset-0 pointer-events-none" 
                         style="background: radial-gradient(circle at ${left}px ${rect.top + rect.height / 2}px, transparent 40px, rgba(0,0,0,0.5) 45px);">
                    </div>
                `;
                document.body.appendChild(guide);

                // ç‚¹å‡»ä»»æ„å¤„ç§»é™¤é®ç½©
                setTimeout(() => {
                    document.addEventListener('click', () => guide.remove(), { once: true });
                }, 100);
            }, 300); // ç¨å¾®å»¶è¿Ÿç¡®ä¿æ¸²æŸ“å®Œæˆ
        }

        // ===== INIT =====
        window.addEventListener('load', async () => {
            // First sync from database, then render
            await syncProfilesFromDB();

            // Render other components
            renderReminders();
            initDurationSelector();
        });

        // Hide scroll hints after user scrolls
        const scrollContainers = document.querySelectorAll('.scroll-container');
        scrollContainers.forEach(container => {
            container.addEventListener('scroll', () => {
                const hint = container.parentElement.querySelector('.scroll-hint-right');
                if (hint && container.scrollLeft > 20) {
                    hint.style.opacity = '0';
                }
            }, { passive: true });
        });

        // ===== é€€å‡ºç™»å½• =====
        function confirmLogout() {
            document.getElementById('logout-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeLogoutModal() {
            document.getElementById('logout-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function executeLogout() {
            // æ¸…é™¤ç™»å½•ä¿¡æ¯
            localStorage.removeItem('brushing_user');
            // æ˜¾ç¤ºæç¤º
            showToast('å·²é€€å‡ºç™»å½•');
            // å»¶è¿Ÿè·³è½¬åˆ°ç™»å½•é¡µ
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 500);
        }
    </script>

</body>

</html>