<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <title>Login - Brushing Master</title>
</head>

<body class="h-screen flex flex-col items-center justify-center p-6 bg-[var(--bg-light)] safe-area-all no-scroll">

    <!-- Loading Overlay - 必须在 body 顶层以确保全屏覆盖 -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 z-[9999]" style="display: none;">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
            <div
                class="bg-white p-6 rounded-3xl border-4 border-[#333] shadow-[8px_8px_0_#333] flex flex-col items-center min-w-[120px]">
                <i class="fas fa-spinner fa-spin text-4xl text-[var(--primary-green)]"></i>
                <p class="mt-3 font-bold text-[#333] text-center whitespace-nowrap">登录中...</p>
            </div>
        </div>
    </div>

    <!-- Brand Header -->
    <div class="text-center mb-8">
        <div
            class="w-32 h-32 mx-auto mb-4 p-4 rounded-full bg-[var(--secondary-green)] border-4 border-[#333] flex items-center justify-center shadow-[8px_8px_0_#333]">
            <img src="owl_mascot.svg" class="w-3/4 h-3/4 object-contain drop-shadow-[4px_4px_0_rgba(0,0,0,0.2)]" />
        </div>
        <h1 class="text-4xl font-black uppercase tracking-tighter text-[#333] mb-1">Brushing<br>Master</h1>
        <p class="text-sm font-bold text-gray-500">让刷牙变成超级游戏！</p>
    </div>

    <!-- Login Form -->
    <div class="w-full max-w-sm">
        <!-- Error Message -->
        <div id="errorMessage"
            class="hidden mb-4 p-3 bg-red-100 border-4 border-red-500 rounded-2xl text-red-700 text-sm font-bold text-center">
        </div>

        <div class="mb-4">
            <label class="block text-xs font-black uppercase text-gray-500 mb-2 ml-2">账号</label>
            <div class="kawaii-card p-0 flex items-center overflow-hidden h-14 bg-white">
                <div
                    class="w-12 h-full bg-gray-100 border-r-4 border-[#333] flex items-center justify-center text-gray-400">
                    <i class="fas fa-user text-xl"></i>
                </div>
                <input type="text" id="accountInput" placeholder="输入账号" inputmode="text" autocomplete="username"
                    autocapitalize="none" enterkeyhint="next"
                    class="flex-1 h-full px-4 font-bold text-lg outline-none text-[#333] placeholder-gray-300">
            </div>
        </div>

        <div class="mb-8">
            <label class="block text-xs font-black uppercase text-gray-500 mb-2 ml-2">密码</label>
            <div class="kawaii-card p-0 flex items-center overflow-hidden h-14 bg-white">
                <div
                    class="w-12 h-full bg-gray-100 border-r-4 border-[#333] flex items-center justify-center text-gray-400">
                    <i class="fas fa-lock text-xl"></i>
                </div>
                <input type="password" id="passwordInput" placeholder="••••••••" autocomplete="current-password"
                    enterkeyhint="go"
                    class="flex-1 h-full px-4 font-bold text-lg outline-none text-[#333] placeholder-gray-300">
            </div>
        </div>

        <button id="loginButton"
            class="kawaii-button kawaii-button-primary w-full py-4 text-xl mb-6 shadow-[8px_8px_0_#333] active:shadow-[2px_2px_0_#333] active:translate-y-1 active:translate-x-1 transition-all">
            登录游戏
        </button>

    </div>

    <!-- Decorative Elements -->
    <div class="fixed top-10 left-[-20px] transform rotate-12 opacity-20 pointer-events-none">
        <i class="fas fa-tooth text-6xl text-blue-300"></i>
    </div>
    <div class="fixed bottom-10 right-[-20px] transform -rotate-12 opacity-20 pointer-events-none">
        <i class="fas fa-star text-6xl text-yellow-300"></i>
    </div>

    <script>
        // ==========================================
        // Memfire (Supabase) 配置
        // ==========================================
        const SUPABASE_URL = 'https://d555hb0g91htqli40010.baseapi.memfiredb.com';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImV4cCI6MzM0MzI4MDA0NCwiaWF0IjoxNzY2NDgwMDQ0LCJpc3MiOiJzdXBhYmFzZSJ9.KvoeBCiyrUNKBP7PDDLyMvl6Wc0POZR-HDaiFHPcgiI';

        // 初始化 Supabase 客户端 (使用不同变量名避免与 window.supabase 冲突)
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM 元素
        const accountInput = document.getElementById('accountInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const errorMessage = document.getElementById('errorMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // 显示错误信息
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        // 显示/隐藏加载状态
        function setLoading(isLoading) {
            if (isLoading) {
                loadingOverlay.style.display = 'block';
                loadingOverlay.classList.remove('hidden');
                loginButton.disabled = true;
            } else {
                loadingOverlay.style.display = 'none';
                loadingOverlay.classList.add('hidden');
                loginButton.disabled = false;
            }
        }

        // 登录处理 - 使用自定义 users 表验证
        async function handleLogin() {
            const account = accountInput.value.trim();
            const password = passwordInput.value;

            // 验证输入
            if (!account) {
                showError('请输入账号');
                return;
            }
            if (!password) {
                showError('请输入密码');
                return;
            }

            setLoading(true);

            try {
                console.log('正在登录...', { account });

                // 查询 users 表验证账号密码
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('account', account)
                    .eq('password', password)
                    .single();

                console.log('查询结果:', { data, error });

                if (error) {
                    console.error('查询错误:', error);
                    if (error.code === 'PGRST116') {
                        // 没有找到匹配的记录
                        throw new Error('账号或密码错误');
                    }
                    throw error;
                }

                if (!data) {
                    throw new Error('账号或密码错误');
                }

                // 登录成功，清除旧账号的 profile 数据
                localStorage.removeItem('activeProfileId');

                // 保存用户信息到 localStorage
                localStorage.setItem('brushing_user', JSON.stringify({
                    id: data.id,
                    account: data.account,
                    display_name: data.display_name,
                    avatar_url: data.avatar_url,
                    login_time: new Date().toISOString()
                }));

                // 跳转到主页
                window.location.href = 'home.html';

            } catch (error) {
                console.error('登录失败:', error);

                // 显示友好的错误信息
                let errorMsg = '登录失败，请重试';
                if (error.message) {
                    if (error.message.includes('账号或密码错误')) {
                        errorMsg = '账号或密码错误';
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMsg = '网络错误，请检查网络连接';
                    } else {
                        errorMsg = error.message;
                    }
                }
                showError(errorMsg);
            } finally {
                setLoading(false);
            }
        }

        // 绑定事件 - click 事件在移动端也会触发
        loginButton.addEventListener('click', handleLogin);

        // 按回车键登录
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        // 检查关键依赖是否加载成功
        window.addEventListener('load', () => {
            if (typeof window.supabase === 'undefined') {
                showError('网络加载失败，请检查网络连接后刷新页面');
                loginButton.disabled = true;
                loginButton.textContent = '网络未连接';
                console.error('Supabase SDK 加载失败');
            } else {
                console.log('所有依赖加载成功');
            }
        });

        // 检查是否已登录
        function checkExistingSession() {
            const user = localStorage.getItem('brushing_user');
            if (user) {
                // 已登录，跳转到主页
                window.location.href = 'home.html';
            }
        }

        // 页面加载时检查登录状态
        checkExistingSession();
    </script>

</body>

</html>