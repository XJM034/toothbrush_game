<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="auth_guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <script src="supabase_client.js"></script>
    <title>Collection - Brushing Master</title>
</head>

<body class="app-shell safe-area-top pt-12 bg-[var(--bg-light)]">

    <header class="px-6 flex items-center justify-between mb-4 flex-shrink-0">
        <button class="kawaii-button kawaii-button-yellow p-3 rounded-full w-10 h-10 flex items-center justify-center"
            onclick="location.href='home.html'">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="text-2xl font-black uppercase">我的收藏</h1>
        <!-- Diamond Balance -->
        <div
            class="flex items-center gap-2 bg-white px-4 py-1.5 rounded-full border-4 border-[#333] shadow-[4px_4px_0_#333] min-w-[100px] justify-center">
            <i class="fas fa-coins text-yellow-400 text-lg"></i>
            <span class="font-black text-xl text-[#333]" id="diamond-balance">0</span>
        </div>
    </header>

    <!-- Tabs -->
    <div class="px-6 flex gap-2 mb-8" id="tabs">
        <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-xs" data-tab="skins">皮肤</button>
        <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-xs border-opacity-50"
            data-tab="achievements">成就</button>
    </div>

    <!-- Skins Grid -->
    <div class="app-scroll px-6 pb-20" id="skins-content">
        <div class="grid grid-cols-3 gap-6" id="skins-grid">
            <!-- Unlocked Skins -->
            <div class="flex flex-col items-center gap-2 skin-item cursor-pointer" data-skin="owl">
                <div
                    class="w-full aspect-square kawaii-card bg-amber-50 flex items-center justify-center overflow-hidden">
                    <img src="SkinSet/owl.png" class="w-full h-full object-cover" />
                </div>
                <span class="text-xs font-black uppercase">猫头鹰</span>
            </div>

            <div class="flex flex-col items-center gap-2 skin-item cursor-pointer" data-skin="cat">
                <div
                    class="w-full aspect-square kawaii-card bg-pink-50 flex items-center justify-center overflow-hidden">
                    <img src="SkinSet/cat.png" class="w-full h-full object-cover" />
                </div>
                <span class="text-xs font-black uppercase">小猫咪</span>
            </div>

            <div class="flex flex-col items-center gap-2 skin-item cursor-pointer" data-skin="dog">
                <div
                    class="w-full aspect-square kawaii-card bg-orange-50 flex items-center justify-center overflow-hidden">
                    <img src="SkinSet/dog.png" class="w-full h-full object-cover" />
                </div>
                <span class="text-xs font-black uppercase">小狗狗</span>
            </div>

            <div class="flex flex-col items-center gap-2 skin-item cursor-pointer" data-skin="rabbit">
                <div
                    class="w-full aspect-square kawaii-card bg-blue-50 flex items-center justify-center overflow-hidden">
                    <img src="SkinSet/rabbit.png" class="w-full h-full object-cover" />
                </div>
                <span class="text-xs font-black uppercase">小兔子</span>
            </div>

            <!-- Locked Skins (placeholders for future) -->
            <div class="flex flex-col items-center gap-2 opacity-60" data-skin="mystery1">
                <div
                    class="w-full aspect-square kawaii-card bg-gray-100 flex items-center justify-center text-3xl grayscale">
                    <i class="fas fa-question text-gray-400"></i>
                </div>
                <span class="text-xs font-black uppercase">???</span>
            </div>

            <div class="flex flex-col items-center gap-2 opacity-60" data-skin="mystery2">
                <div
                    class="w-full aspect-square kawaii-card bg-gray-100 flex items-center justify-center text-3xl grayscale">
                    <i class="fas fa-question text-gray-400"></i>
                </div>
                <span class="text-xs font-black uppercase">???</span>
            </div>
        </div>
    </div>

    <!-- Achievement Details Modal -->
    <div id="achievement-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden relative">
            <div class="p-6">
                <!-- Achievement Icon -->
                <div class="text-center mb-4">
                    <div id="modal-ach-icon-container"
                        class="w-24 h-24 mx-auto mb-4 rounded-3xl border-4 border-[#333] flex items-center justify-center text-5xl">
                        <!-- Icon injected -->
                    </div>
                    <h2 class="text-xl font-black" id="modal-ach-name">成就名称</h2>
                    <div id="modal-ach-status"
                        class="mt-2 inline-block px-3 py-1 bg-gray-100 rounded-full text-xs font-bold text-gray-500">
                        未解锁
                    </div>
                </div>

                <!-- Description -->
                <div class="kawaii-card bg-gray-50 p-4 mb-6 text-center">
                    <p class="text-sm text-gray-600 mb-2" id="modal-ach-desc">成就介绍</p>
                    <div class="mt-3 pt-3 border-t-2 border-gray-200">
                        <span class="text-xs font-black text-gray-400 uppercase">解锁条件</span>
                        <p class="text-sm font-bold text-[#333] mt-1" id="modal-ach-condition">条件描述</p>
                    </div>
                </div>

                <!-- Close Button -->
                <button class="kawaii-button kawaii-button-primary w-full py-3 text-sm"
                    onclick="closeAchievementModal()">关闭</button>
            </div>
        </div>
    </div>
    <!-- Achievements Grid (Hidden by default) -->
    <div class="app-scroll px-6 pb-20 hidden" id="achievements-content">
        <div class="grid grid-cols-1 gap-4" id="achievements-grid">
            <!-- 成就将由 JavaScript 动态生成 -->
        </div>
    </div>

    <!-- Skin Selection Modal -->
    <div id="skin-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <!-- Skin Preview -->
                <div class="text-center mb-4">
                    <div id="modal-skin-icon"
                        class="w-24 h-24 mx-auto mb-4 rounded-3xl border-4 border-[#333] flex items-center justify-center text-5xl">
                        <!-- Icon will be injected -->
                    </div>
                    <h2 class="text-xl font-black" id="modal-skin-name">皮肤名称</h2>
                </div>

                <!-- Skin Description -->
                <div class="kawaii-card bg-gray-50 p-4 mb-6">
                    <p class="text-sm text-gray-600 text-center" id="modal-skin-desc">皮肤介绍</p>
                </div>

                <!-- Buttons -->
                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closeSkinModal()">取消</button>
                    <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-sm"
                        onclick="confirmSkinSelection()">确认选择</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-16 left-1/2 -translate-x-1/2 z-[300] opacity-0 scale-95 transition-all duration-300 pointer-events-none">
        <div class="kawaii-card bg-[var(--accent-yellow)] px-6 py-3 flex items-center gap-3 border-[#333]">
            <i class="fas fa-check-circle text-[var(--primary-green)] text-xl" id="toast-icon"></i>
            <span class="font-black text-sm" id="toast-message">操作成功！</span>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchase-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div
            class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden">
            <div class="p-6">
                <!-- Icon -->
                <div class="text-center mb-4">
                    <div id="purchase-modal-icon"
                        class="w-24 h-24 mx-auto mb-4 rounded-3xl border-4 border-[#333] flex items-center justify-center overflow-hidden bg-cyan-50">
                    </div>
                    <h3 class="font-black text-xl" id="purchase-modal-name">皮肤名称</h3>
                </div>

                <!-- Price Info -->
                <div class="kawaii-card bg-yellow-50 p-4 mb-4 text-center border-4 border-[#333] rounded-2xl">
                    <p class="text-sm font-bold text-gray-500 mb-2">解锁需要</p>
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i class="fas fa-coins text-3xl text-yellow-400 drop-shadow-md"></i>
                        <span class="text-4xl font-black text-[#333]" id="purchase-modal-price">10</span>
                    </div>
                    <div
                        class="inline-block bg-white px-3 py-1 rounded-full border-2 border-[#333] text-xs font-bold text-gray-500">
                        当前拥有: <span id="purchase-modal-balance" class="text-yellow-600">0</span> 金币
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm"
                        onclick="closePurchaseModal()">取消</button>
                    <button class="flex-1 kawaii-button kawaii-button-yellow py-3 text-sm" id="confirm-purchase-btn"
                        onclick="confirmPurchase()">
                        <i class="fas fa-gem mr-1"></i>确认兑换
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SKIN DATA =====
        const skinData = {
            owl: {
                name: '猫头鹰',
                desc: '智慧的化身，夜视能力让细菌无所遏形！是我们最可靠的伙伴！',
                icon: 'SkinSet/owl.png',
                bgColor: 'bg-amber-50',
                isImage: true,
                unlocked: true,  // 默认皮肤，所有用户都有
                price: 0  // 免费
            },
            cat: {
                name: '小猫咪',
                desc: '优雅又可爱的小猫咪，用猫爪般的灵巧清洁每一颗牙齿！',
                icon: 'SkinSet/cat.png',
                bgColor: 'bg-pink-50',
                isImage: true,
                unlocked: false,
                price: 10  // 10钻石
            },
            dog: {
                name: '小狗狗',
                desc: '忠诚勇敢的小狗狗，用坚定的毅力守护牙齿健康！',
                icon: 'SkinSet/dog.png',
                bgColor: 'bg-orange-50',
                isImage: true,
                unlocked: false,
                price: 10  // 10钻石
            },
            rabbit: {
                name: '小兔子',
                desc: '活泼可爱的小兔子，蹦蹦跳跳地消灭所有细菌！',
                icon: 'SkinSet/rabbit.png',
                bgColor: 'bg-blue-50',
                isImage: true,
                unlocked: false,
                price: 15  // 15钻石
            },
            mystery1: {
                name: '???',
                desc: '神秘皮肤，等待你来解锁！',
                icon: 'fa-question',
                bgColor: 'bg-gray-100',
                isImage: false,
                unlocked: false,
                price: 20  // 20钻石
            },
            mystery2: {
                name: '???',
                desc: '神秘皮肤，等待你来解锁！',
                icon: 'fa-question',
                bgColor: 'bg-gray-100',
                isImage: false,
                unlocked: false,
                price: 20  // 20钻石
            }
        };

        // ===== ACHIEVEMENT DATA =====
        const achievementData = {
            newbie: {
                name: '刷牙新手',
                desc: '欢迎加入刷牙特工队！这是你迈向健康牙齿的第一步。',
                condition: '完成首次刷牙',
                icon: 'fa-medal',
                color: 'text-yellow-500',
                bgColor: 'bg-green-100',
                unlocked: false  // 默认为 false，从数据库加载
            },
            streak7: {
                name: '连续7天',
                desc: '坚持就是胜利！你已经连续一周保护了牙齿。',
                condition: '连续刷牙7天',
                icon: 'fa-calendar-check',
                color: 'text-blue-500',
                bgColor: 'bg-blue-100',
                unlocked: false
            },
            germbuster: {
                name: '细菌克星',
                desc: '细菌看到你都瑟瑟发抖！你是牙齿的守护神。',
                condition: '累计消灭1000个细菌',
                icon: 'fa-trophy',
                color: 'text-purple-500',
                bgColor: 'bg-purple-100',
                unlocked: false
            },
            streak30: {
                name: '连续30天',
                desc: '太棒了！刷牙已经成为了你的好习惯。',
                condition: '连续刷牙30天',
                icon: 'fa-fire',
                color: 'text-gray-400',
                bgColor: 'bg-gray-100',
                unlocked: false
            },
            master: {
                name: '刷牙大师',
                desc: '你的刷牙技巧已经达到了大师级别！',
                condition: '通过所有关卡',
                icon: 'fa-star',
                color: 'text-gray-400',
                bgColor: 'bg-gray-100',
                unlocked: false
            },
            champion: {
                name: '全勤冠军',
                desc: '风雨无阻，你是最勤奋的刷牙小冠军！',
                condition: '连续刷牙60天',
                icon: 'fa-gem',
                color: 'text-gray-400',
                bgColor: 'bg-gray-100',
                unlocked: false
            },
            king: {
                name: '刷牙王者',
                desc: '至高无上的荣耀，只有最顶尖的刷牙特工才能获得！',
                condition: '获得所有其他成就',
                icon: 'fa-crown',
                color: 'text-gray-400',
                bgColor: 'bg-gray-100',
                unlocked: false
            },
            super: {
                name: '超级刷手',
                desc: '超越极限，你的速度和准确度无人能敌！',
                condition: '单次评分达到SS',
                icon: 'fa-rocket',
                color: 'text-gray-400',
                bgColor: 'bg-gray-100',
                unlocked: false
            }
        };

        // State
        let currentSelectedSkin = localStorage.getItem('selectedSkin') || 'owl';
        let pendingSkinId = null;

        // ===== TAB SWITCHING =====
        const tabs = document.querySelectorAll('#tabs button');
        const skinsContent = document.getElementById('skins-content');
        const achievementsContent = document.getElementById('achievements-content');

        tabs.forEach(tab => {
            tab.onclick = () => {
                tabs.forEach(t => {
                    t.classList.remove('kawaii-button-yellow');
                    t.classList.add('kawaii-button-primary', 'border-opacity-50');
                });
                tab.classList.remove('kawaii-button-primary', 'border-opacity-50');
                tab.classList.add('kawaii-button-yellow');

                const progressLabel = document.getElementById('progress-label');
                const progressValue = document.getElementById('progress-value');
                const progressBar = document.getElementById('progress-bar');

                if (tab.dataset.tab === 'skins') {
                    skinsContent.classList.remove('hidden');
                    achievementsContent.classList.add('hidden');
                    progressLabel.textContent = '收藏进度';
                    // 使用动态数据
                    if (window.progressData && window.progressData.skins) {
                        const { unlocked, total } = window.progressData.skins;
                        progressValue.textContent = `${unlocked}/${total}`;
                        progressBar.style.width = `${(unlocked / total) * 100}%`;
                    }
                } else {
                    skinsContent.classList.add('hidden');
                    achievementsContent.classList.remove('hidden');
                    progressLabel.textContent = '成就进度';
                    // 使用动态数据
                    if (window.progressData && window.progressData.achievements) {
                        const { unlocked, total } = window.progressData.achievements;
                        progressValue.textContent = `${unlocked}/${total}`;
                        progressBar.style.width = `${(unlocked / total) * 100}%`;
                    }
                }
            };
        });

        // ===== SKIN SELECTION =====
        function updateSkinSelectionUI() {
            const skinItems = document.querySelectorAll('.skin-item');
            skinItems.forEach(item => {
                const skinId = item.dataset.skin;
                const card = item.querySelector('.kawaii-card');

                if (skinId === currentSelectedSkin) {
                    item.classList.add('selected');
                    card.classList.add('border-[var(--accent-yellow)]', 'border-[6px]');
                } else {
                    item.classList.remove('selected');
                    card.classList.remove('border-[var(--accent-yellow)]', 'border-[6px]');
                }
            });
        }

        function openSkinModal(skinId) {
            const skin = skinData[skinId];
            if (!skin || !skin.unlocked) return;

            pendingSkinId = skinId;

            // Update modal content
            const iconContainer = document.getElementById('modal-skin-icon');
            iconContainer.className = `w-24 h-24 mx-auto mb-4 rounded-3xl border-4 border-[#333] flex items-center justify-center text-5xl ${skin.bgColor}`;

            if (skin.isImage) {
                iconContainer.innerHTML = `<img src="${skin.icon}" class="w-2/3 h-2/3 object-contain" />`;
            } else {
                iconContainer.innerHTML = `<i class="fas ${skin.icon}"></i>`;
            }

            document.getElementById('modal-skin-name').textContent = skin.name;
            document.getElementById('modal-skin-desc').textContent = skin.desc;

            // Show modal
            document.getElementById('skin-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSkinModal() {
            document.getElementById('skin-modal').classList.add('hidden');
            document.body.style.overflow = '';
            pendingSkinId = null;
        }

        function confirmSkinSelection() {
            if (!pendingSkinId) return;

            currentSelectedSkin = pendingSkinId;
            localStorage.setItem('selectedSkin', currentSelectedSkin);

            updateSkinSelectionUI();
            closeSkinModal();
            showToast(`已选择「${skinData[currentSelectedSkin].name}」为默认皮肤`);
        }

        // ===== PURCHASE MODAL =====
        let pendingPurchaseSkinId = null;
        let currentDiamondBalance = 0;

        function openPurchaseModal(skinId) {
            const skin = skinData[skinId];
            if (!skin || skin.unlocked) return;

            pendingPurchaseSkinId = skinId;

            // Sync balance from DOM in case variable is stale
            const balanceEl = document.getElementById('diamond-balance');
            if (balanceEl) {
                currentDiamondBalance = parseInt(balanceEl.textContent) || 0;
            }

            // Update modal content
            const iconContainer = document.getElementById('purchase-modal-icon');
            if (skin.isImage) {
                iconContainer.innerHTML = `<img src="${skin.icon}" class="w-full h-full object-cover" />`;
            } else {
                iconContainer.innerHTML = `<i class="fas ${skin.icon} text-4xl text-gray-400"></i>`;
            }

            document.getElementById('purchase-modal-name').textContent = skin.name;
            document.getElementById('purchase-modal-price').textContent = skin.price;
            document.getElementById('purchase-modal-balance').textContent = currentDiamondBalance;

            // Check if can afford
            const confirmBtn = document.getElementById('confirm-purchase-btn');
            if (currentDiamondBalance >= skin.price) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                confirmBtn.classList.add('kawaii-button-yellow');
                confirmBtn.innerHTML = '<i class="fas fa-coins mr-1"></i>确认兑换';
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                confirmBtn.classList.remove('kawaii-button-yellow');
                confirmBtn.innerHTML = '<i class="fas fa-lock mr-1"></i>余额不足';
            }

            document.getElementById('purchase-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closePurchaseModal() {
            document.getElementById('purchase-modal').classList.add('hidden');
            document.body.style.overflow = '';
            pendingPurchaseSkinId = null;
        }

        async function confirmPurchase() {
            if (!pendingPurchaseSkinId) return;

            const skin = skinData[pendingPurchaseSkinId];
            if (!skin || currentDiamondBalance < skin.price) {
                showToast('金币不足！', 'error');
                return;
            }

            const confirmBtn = document.getElementById('confirm-purchase-btn');
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>兑换中...';
            confirmBtn.disabled = true;

            try {
                const profileId = localStorage.getItem('activeProfileId');
                if (!profileId) throw new Error('未找到用户档案');

                // Deduct diamonds
                await BrushingMasterDB.updateDiamonds(profileId, -skin.price);

                // Add skin to user
                await BrushingMasterDB.addUserSkin(profileId, pendingPurchaseSkinId, 'purchase');

                // Update local state
                currentDiamondBalance -= skin.price;
                skinData[pendingPurchaseSkinId].unlocked = true;

                // Update UI
                document.getElementById('diamond-balance').textContent = currentDiamondBalance;
                updateSkinsUI();

                // Update cached profile for home page
                const cachedProfile = localStorage.getItem('cachedActiveProfile');
                if (cachedProfile) {
                    const profileData = JSON.parse(cachedProfile);
                    profileData.diamonds = currentDiamondBalance;
                    localStorage.setItem('cachedActiveProfile', JSON.stringify(profileData));
                    console.log('✅ 档案缓存已更新（购买后）');
                }

                closePurchaseModal();
                showToast(`成功解锁「${skin.name}」！`, 'success');

            } catch (error) {
                console.error('兑换失败:', error);
                showToast('兑换失败，请重试', 'error');
            } finally {
                confirmBtn.innerHTML = '<i class="fas fa-coins mr-1"></i>确认兑换';
                confirmBtn.disabled = false;
            }
        }

        // ===== ACHIEVEMENT MODAL =====
        function openAchievementModal(achId) {
            const ach = achievementData[achId];
            if (!ach) return;

            // Update modal content
            const iconContainer = document.getElementById('modal-ach-icon-container');
            const statusBadge = document.getElementById('modal-ach-status');

            // Icon Style
            if (ach.unlocked) {
                iconContainer.className = `w-24 h-24 mx-auto mb-4 rounded-3xl border-4 border-[#333] flex items-center justify-center text-5xl ${ach.bgColor} ${ach.color}`;
                iconContainer.innerHTML = `<i class="fas ${ach.icon}"></i>`;

                statusBadge.textContent = '已获得';
                statusBadge.className = 'mt-2 inline-block px-3 py-1 bg-green-100 rounded-full text-xs font-bold text-green-600';
            } else {
                iconContainer.className = `w-24 h-24 mx-auto mb-4 rounded-3xl border-4 border-[#333] flex items-center justify-center text-5xl bg-gray-100 text-gray-300`;
                iconContainer.innerHTML = `<div class="relative"><i class="fas ${ach.icon}"></i><i class="fas fa-lock absolute -bottom-2 -right-2 text-2xl text-gray-400"></i></div>`;

                statusBadge.textContent = '未解锁';
                statusBadge.className = 'mt-2 inline-block px-3 py-1 bg-gray-100 rounded-full text-xs font-bold text-gray-500';
            }

            document.getElementById('modal-ach-name').textContent = ach.name;
            document.getElementById('modal-ach-desc').textContent = ach.desc || '？？？';
            document.getElementById('modal-ach-condition').textContent = ach.condition;

            // Add locking style for condition if locked
            const conditionEl = document.getElementById('modal-ach-condition');
            if (!ach.unlocked) {
                conditionEl.classList.add('text-red-500');
            } else {
                conditionEl.classList.remove('text-red-500');
            }

            // Show modal
            document.getElementById('achievement-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAchievementModal() {
            document.getElementById('achievement-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // ===== TOAST =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'scale-95');
            toast.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'scale-100');
                toast.classList.add('opacity-0', 'scale-95');
            }, 2000);
        }

        // ===== DATABASE LOADING =====
        async function loadCollectionData() {
            const profileId = localStorage.getItem('activeProfileId');
            if (!profileId) {
                console.log('No profile ID, using default data');
                return;
            }

            try {
                // 加载用户拥有的皮肤
                const userSkins = await BrushingMasterDB.getUserSkins(profileId);
                const ownedSkinIds = userSkins.map(s => s.skin_id);
                console.log('用户拥有的皮肤:', ownedSkinIds);

                // 更新皮肤解锁状态（owl 始终解锁作为默认皮肤）
                Object.keys(skinData).forEach(skinId => {
                    if (skinId === 'owl') {
                        skinData[skinId].unlocked = true;  // 默认皮肤始终解锁
                    } else {
                        skinData[skinId].unlocked = ownedSkinIds.includes(skinId);
                    }
                });

                // 加载用户成就
                const userAchievements = await BrushingMasterDB.getUserAchievements(profileId);
                const unlockedAchIds = userAchievements.filter(a => a.is_unlocked).map(a => a.achievement_id);
                console.log('用户解锁的成就:', unlockedAchIds);

                // 更新成就解锁状态
                Object.keys(achievementData).forEach(achId => {
                    achievementData[achId].unlocked = unlockedAchIds.includes(achId);
                });

                // 加载用户钻石余额
                try {
                    const profileData = await BrushingMasterDB.getDiamonds(profileId);
                    currentDiamondBalance = profileData.diamonds || 0;
                    document.getElementById('diamond-balance').textContent = currentDiamondBalance;
                    console.log('用户金币余额:', currentDiamondBalance);
                } catch (err) {
                    console.error('加载金币余额失败:', err);
                }

                // 更新UI
                updateSkinsUI();
                updateAchievementsUI();
                updateProgressBars();

            } catch (error) {
                console.error('加载收藏数据失败:', error);
            }
        }

        // 更新皮肤UI
        function updateSkinsUI() {
            const skinsGrid = document.getElementById('skins-grid');
            let html = '';

            Object.entries(skinData).forEach(([id, skin]) => {
                const isUnlocked = skin.unlocked;

                if (isUnlocked) {
                    // Unlocked skin - clickable with full opacity
                    html += `
                        <div class="flex flex-col items-center gap-2 cursor-pointer skin-item" data-skin="${id}">
                            <div class="w-full aspect-square kawaii-card ${skin.bgColor} flex items-center justify-center overflow-hidden relative">
                                ${skin.isImage
                            ? `<img src="${skin.icon}" class="w-full h-full object-cover" />`
                            : `<i class="fas ${skin.icon} text-3xl"></i>`
                        }
                            </div>
                            <span class="text-xs font-black uppercase">${skin.name}</span>
                        </div>
                    `;
                } else {
                    // Locked skin - show purchase button
                    html += `
                        <div class="flex flex-col items-center gap-2 purchasable-skin" data-skin="${id}">
                            <div class="w-full aspect-square kawaii-card bg-gray-100 flex items-center justify-center overflow-hidden relative cursor-pointer" onclick="openPurchaseModal('${id}')">
                                ${skin.isImage
                            ? `<img src="${skin.icon}" class="w-full h-full object-cover opacity-40 grayscale" />`
                            : `<i class="fas fa-question text-gray-400 text-3xl"></i>`
                        }
                                <div class="absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center">
                                    <div class="bg-yellow-500 text-white px-2 py-1 rounded-full text-xs font-black flex items-center gap-1">
                                        <i class="fas fa-coins"></i>
                                        <span>${skin.price}</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-xs font-black uppercase text-gray-400">${skin.name}</span>
                        </div>
                    `;
                }
            });

            skinsGrid.innerHTML = html;

            // 重新绑定点击事件（已解锁的皮肤）
            document.querySelectorAll('.skin-item').forEach(item => {
                item.onclick = () => {
                    const skinId = item.dataset.skin;
                    if (!skinData[skinId]?.unlocked) return;
                    openSkinModal(skinId);
                };
            });
        }

        // 更新成就UI
        function updateAchievementsUI() {
            const achGrid = document.getElementById('achievements-grid');
            let html = '';

            Object.entries(achievementData).forEach(([id, ach]) => {
                const isUnlocked = ach.unlocked;
                const opacityClass = isUnlocked ? '' : 'opacity-50';
                const colorClass = isUnlocked ? ach.color : 'text-gray-400';
                const bgColorClass = isUnlocked ? ach.bgColor : 'bg-gray-100';
                const grayscaleClass = isUnlocked ? '' : 'grayscale';

                html += `
                    <div class="flex items-center gap-4 kawaii-card p-4 achievement-item cursor-pointer ${opacityClass} ${grayscaleClass}" data-achievement="${id}">
                        <div class="w-12 h-12 ${bgColorClass} rounded-2xl border-3 border-[#333] flex items-center justify-center ${colorClass}">
                            <i class="fas ${ach.icon} text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-sm">${ach.name}</div>
                            <div class="text-xs text-gray-400">${ach.condition}</div>
                        </div>
                        ${isUnlocked ? '<i class="fas fa-check-circle text-[var(--primary-green)]"></i>' : '<i class="fas fa-lock text-gray-300"></i>'}
                    </div>
                `;
            });

            achGrid.innerHTML = html;

            // 重新绑定点击事件
            document.querySelectorAll('.achievement-item').forEach(item => {
                item.onclick = () => {
                    const achId = item.dataset.achievement;
                    openAchievementModal(achId);
                };
            });
        }

        // 更新进度条
        function updateProgressBars() {
            const unlockedSkins = Object.values(skinData).filter(s => s.unlocked).length;
            const totalSkins = Object.keys(skinData).length;
            const unlockedAch = Object.values(achievementData).filter(a => a.unlocked).length;
            const totalAch = Object.keys(achievementData).length;

            // 保存进度数据供 tab 切换使用
            window.progressData = {
                skins: { unlocked: unlockedSkins, total: totalSkins },
                achievements: { unlocked: unlockedAch, total: totalAch }
            };

            // 默认显示皮肤进度
            const progressLabel = document.getElementById('progress-label');
            const progressValue = document.getElementById('progress-value');
            const progressBar = document.getElementById('progress-bar');

            progressLabel.textContent = '收藏进度';
            progressValue.textContent = `${unlockedSkins}/${totalSkins}`;
            progressBar.style.width = `${(unlockedSkins / totalSkins) * 100}%`;
        }

        // ===== INIT =====
        // Bind click events to skin items
        const skinItems = document.querySelectorAll('.skin-item');
        skinItems.forEach(item => {
            item.onclick = () => {
                const skinId = item.dataset.skin;
                // Only allow selection for unlocked items
                if (item.classList.contains('opacity-60')) return;
                openSkinModal(skinId);
            };
        });

        // Bind click events to achievement items
        const achItems = document.querySelectorAll('.achievement-item');
        achItems.forEach(item => {
            item.onclick = () => {
                const achId = item.dataset.achievement;
                openAchievementModal(achId);
            };
        });

        // Initialize selection UI based on localStorage
        updateSkinSelectionUI();

        // 显示加载状态，等待数据库加载完成后再显示实际内容
        // 不要在数据加载前调用 updateSkinsUI()，否则会显示错误的锁定状态
        document.getElementById('skins-grid').innerHTML = '<div class="col-span-3 text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2 text-sm font-bold">加载中...</p></div>';
        document.getElementById('achievements-grid').innerHTML = '<div class="col-span-1 text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2 text-sm font-bold">加载中...</p></div>';

        // Load data from database immediately (not waiting for window load)
        loadCollectionData();
    </script>

    <!-- Progress Summary -->
    <div class="p-6 bg-white border-t-4 border-[#333] flex-shrink-0">
        <div class="justify-between items-center mb-2 flex">
            <span class="font-black text-xs" id="progress-label">收藏进度</span>
            <span class="font-black text-xs text-[var(--primary-green)]" id="progress-value">-/-</span>
        </div>
        <div class="kawaii-progress-bg">
            <div class="kawaii-progress-fill" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>

</body>

</html>