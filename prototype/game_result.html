<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="auth_guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <script src="supabase_client.js"></script>
    <title>Result - Brushing Master</title>
</head>

<body
    class="h-screen bg-[var(--primary-green)] flex flex-col pt-8 px-6 items-center text-center safe-area-top safe-area-bottom no-scroll">

    <header class="mb-4">
        <div class="text-white text-5xl mb-2 drop-shadow-[4px_4px_0_#333]">
            <i class="fas fa-award"></i>
        </div>
        <h1 class="text-3xl font-black text-white uppercase drop-shadow-[4px_4px_0_#333]">å¤ªæ£’äº†ï¼</h1>
        <p class="font-black text-white text-opacity-80 uppercase text-xs mt-1">ä½ ä»Šå¤©å¸®åŠ©äº†å°çŒ«å¤´é¹°ï¼</p>
    </header>

    <div class="w-full flex-1 flex flex-col gap-4 min-h-0">
        <!-- XP Earned Banner -->
        <div class="kawaii-card bg-white py-3 flex items-center justify-center gap-3">
            <i class="fas fa-bolt text-2xl text-[var(--accent-yellow)]"></i>
            <div class="text-left">
                <span class="text-[10px] font-black text-gray-400 uppercase">è·å¾—ç»éªŒ</span>
                <div class="flex items-baseline gap-1">
                    <span class="text-2xl font-black text-[var(--primary-green)]" id="xp-earned">+50</span>
                    <span class="text-sm font-bold text-gray-500">XP</span>
                </div>
            </div>
            <div id="streak-bonus"
                class="hidden ml-2 px-2 py-1 bg-[var(--accent-yellow)] rounded-full text-xs font-black text-[#333]">
                +è¿ç»­å¥–åŠ±
            </div>
        </div>

        <!-- Stats -->
        <div class="kawaii-card grid grid-cols-2 gap-4 py-3">
            <div class="flex flex-col border-r-4 border-[#333] border-dashed">
                <span class="text-[10px] font-black text-gray-400">å‡»è´¥ç»†èŒ</span>
                <span class="text-xl font-black" id="germs-killed">42</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] font-black text-gray-400">è¿ç»­å¤©æ•°</span>
                <span class="text-xl font-black" id="streak-days">5 å¤©</span>
            </div>
        </div>

        <!-- Reward Drop -->
        <div id="reward-container"
            class="kawaii-card bg-[var(--accent-yellow)] p-4 relative overflow-hidden flex-1 min-h-0 flex flex-col items-center justify-center">
            <div class="absolute -top-4 -left-4 text-white opacity-20 text-6xl transform -rotate-12">
                <i class="fas fa-gift"></i>
            </div>
            <h3 class="font-black text-base mb-2 text-[#333] uppercase" id="reward-title">è§£é”æ–°çš®è‚¤ï¼</h3>
            <div id="reward-icon"
                class="w-20 h-20 bg-white border-4 border-[#333] rounded-3xl flex items-center justify-center mb-2 shadow-[4px_4px_0_#333] overflow-hidden">
                <i class="fas fa-feather text-4xl text-[#333]"></i>
            </div>
            <span class="font-black text-xs text-[#333] uppercase" id="reward-name">ç¿¡ç¿ ç¾½æ¯›</span>
        </div>
    </div>

    <div class="w-full flex flex-col gap-3 py-4">
        <button class="kawaii-button kawaii-button-yellow w-full py-3 text-base"
            onclick="location.href='photo_edit.html'">
            <i class="fas fa-paint-brush mr-2"></i> è£…é¥°ç…§ç‰‡
        </button>
        <button class="kawaii-button kawaii-button-primary w-full py-3 text-base" onclick="goHome()">
            <i class="fas fa-home mr-2"></i> è¿”å›ä¸»é¡µ
        </button>
    </div>

    <script>
        // ===== REWARD SYSTEM CONFIGURATION =====
        const XP_REWARDS = {
            1: 30,  // 1åˆ†é’Ÿåˆ·ç‰™
            2: 50,  // 2åˆ†é’Ÿåˆ·ç‰™
            3: 80   // 3åˆ†é’Ÿåˆ·ç‰™
        };
        const STREAK_BONUS = 10;  // æ¯è¿ç»­1å¤©é¢å¤–åŠ æˆ
        const GERM_XP_RATE = 0.1; // æ¯10ä¸ªç»†èŒ +1 XP
        const MAX_GERM_XP = 50;   // å‡»è´¥ç»†èŒXPä¸Šé™

        // çš®è‚¤æ‰è½åº“
        const SKIN_DROPS = [
            { id: 'owl', name: 'çŒ«å¤´é¹°', icon: 'SkinSet/owl.png', rarity: 'common' },
            { id: 'cat', name: 'å°çŒ«å’ª', icon: 'SkinSet/cat.png', rarity: 'rare' },
            { id: 'dog', name: 'å°ç‹—ç‹—', icon: 'SkinSet/dog.png', rarity: 'rare' },
            { id: 'rabbit', name: 'å°å…”å­', icon: 'SkinSet/rabbit.png', rarity: 'epic' }
        ];

        // å…¨å±€çŠ¶æ€
        let currentProfile = null;
        let sessionData = null;

        // è·å–æ¸¸æˆç»“æœæ•°æ®
        function getGameResult() {
            const result = sessionStorage.getItem('lastGameResult');
            if (result) {
                return JSON.parse(result);
            }
            return {
                duration: 2,
                germsKilled: Math.floor(Math.random() * 50) + 30,
                streakDays: Math.floor(Math.random() * 10) + 1
            };
        }

        // è®¡ç®—XP
        function calculateXP(duration, germsKilled, streakDays) {
            let baseXP = XP_REWARDS[duration] || 50;
            let streakXP = streakDays > 1 ? (streakDays - 1) * STREAK_BONUS : 0;
            let germXP = Math.min(Math.floor(germsKilled * GERM_XP_RATE), MAX_GERM_XP);
            return {
                base: baseXP,
                streak: streakXP,
                germs: germXP,
                total: baseXP + streakXP + germXP
            };
        }

        // éšæœºçš®è‚¤æ‰è½
        function rollSkinDrop(ownedSkinIds) {
            if (Math.random() > 0.2) return null;
            const available = SKIN_DROPS.filter(s => !ownedSkinIds.includes(s.id));
            if (available.length === 0) return null;
            return available[Math.floor(Math.random() * available.length)];
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initResultPage() {
            const result = getGameResult();
            const xp = calculateXP(result.duration, result.germsKilled, result.streakDays);

            // æ›´æ–°XPæ˜¾ç¤º
            document.getElementById('xp-earned').textContent = `+${xp.total}`;
            if (xp.streak > 0) {
                document.getElementById('streak-bonus').classList.remove('hidden');
                document.getElementById('streak-bonus').textContent = `+${xp.streak} è¿ç»­`;
            }

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('germs-killed').textContent = result.germsKilled;
            document.getElementById('streak-days').textContent = `${result.streakDays} å¤©`;

            // å°è¯•ä»æ•°æ®åº“åŠ è½½æ•°æ®
            let ownedSkinIds = ['owl'];
            let skinDrop = null;

            try {
                const profileId = localStorage.getItem('activeProfileId');
                console.log('ğŸ® æ¸¸æˆç»“æœ - activeProfileId:', profileId);

                if (profileId) {
                    // è·å–ç”¨æˆ·æ‹¥æœ‰çš„çš®è‚¤
                    const userSkins = await BrushingMasterDB.getUserSkins(profileId);
                    console.log('ğŸ¨ ç”¨æˆ·çš®è‚¤:', userSkins);
                    ownedSkinIds = userSkins.map(s => s.skin_id);

                    // è®¡ç®—çš®è‚¤æ‰è½
                    skinDrop = rollSkinDrop(ownedSkinIds);

                    // ä¿å­˜åˆ·ç‰™ä¼šè¯åˆ°æ•°æ®åº“
                    console.log('ğŸ’¾ æ­£åœ¨ä¿å­˜åˆ·ç‰™ä¼šè¯...', { profileId, result, xp, skinDrop });
                    await saveBrushingSession(profileId, result, xp, skinDrop);
                    console.log('âœ… åˆ·ç‰™ä¼šè¯ä¿å­˜æˆåŠŸ');

                    // æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
                    console.log('ğŸ“ æ­£åœ¨æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ...');
                    await updateUserProfileInDB(profileId, result, xp);
                    console.log('âœ… ç”¨æˆ·æ¡£æ¡ˆæ›´æ–°æˆåŠŸ');

                    // å¦‚æœæœ‰çš®è‚¤æ‰è½ï¼Œæ·»åŠ åˆ°æ•°æ®åº“
                    if (skinDrop) {
                        console.log('ğŸ æ­£åœ¨ä¿å­˜çš®è‚¤æ‰è½...');
                        await BrushingMasterDB.addUserSkin(profileId, skinDrop.id, 'drop');
                        console.log('âœ… çš®è‚¤æ‰è½ä¿å­˜æˆåŠŸ');
                    }

                    // æ£€æŸ¥æˆå°±
                    await checkAchievements(profileId, result, xp);
                } else {
                    console.error('âŒ æ²¡æœ‰æ‰¾åˆ° activeProfileIdï¼Œæ— æ³•ä¿å­˜åˆ°æ•°æ®åº“');
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜æ•°æ®åˆ°åç«¯å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                // é™çº§åˆ° localStorage
                fallbackToLocalStorage(xp);
            }

            // æ›´æ–°æ‰è½æ˜¾ç¤º
            updateRewardDisplay(skinDrop, xp);
        }

        // ä¿å­˜åˆ·ç‰™ä¼šè¯åˆ°æ•°æ®åº“
        async function saveBrushingSession(profileId, result, xp, skinDrop) {
            const supabase = BrushingMasterDB.getSupabaseClient();
            const { data, error } = await supabase
                .from('brushing_sessions')
                .insert({
                    profile_id: profileId,
                    duration_minutes: result.duration,
                    germs_killed: result.germsKilled,
                    base_xp: xp.base,
                    streak_bonus_xp: xp.streak,
                    germ_bonus_xp: xp.germs,
                    total_xp: xp.total,
                    skin_drop: skinDrop?.id || null,
                    streak_at_session: result.streakDays,
                    completed_at: new Date().toISOString()
                })
                .select()
                .single();

            if (error) throw error;
            console.log('åˆ·ç‰™ä¼šè¯å·²ä¿å­˜:', data);
            return data;
        }

        // æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
        async function updateUserProfileInDB(profileId, result, xp) {
            const supabase = BrushingMasterDB.getSupabaseClient();

            // å…ˆè·å–å½“å‰æ¡£æ¡ˆ
            const { data: profile, error: fetchError } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', profileId)
                .single();

            if (fetchError) throw fetchError;

            // è®¡ç®—æ–°çš„XPå’Œç­‰çº§
            let newCurrentXP = (profile.current_xp || 0) + xp.total;
            let newLevel = profile.level || 1;
            let newTotalXP = (profile.total_xp || 0) + xp.total;

            // æ£€æŸ¥å‡çº§
            let maxXP = BrushingMasterDB.getMaxXPForLevel(newLevel);
            while (newCurrentXP >= maxXP) {
                newCurrentXP -= maxXP;
                newLevel++;
                maxXP = BrushingMasterDB.getMaxXPForLevel(newLevel);
            }

            // æ›´æ–°è¿ç»­å¤©æ•°
            const today = new Date().toISOString().split('T')[0];
            let newStreakDays = profile.streak_days || 0;
            let newLongestStreak = profile.longest_streak || 0;

            if (profile.last_brush_date !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                if (profile.last_brush_date === yesterdayStr) {
                    newStreakDays++;
                } else {
                    newStreakDays = 1;
                }

                if (newStreakDays > newLongestStreak) {
                    newLongestStreak = newStreakDays;
                }
            }

            // æ›´æ–°æ¡£æ¡ˆ
            const { data, error } = await supabase
                .from('user_profiles')
                .update({
                    level: newLevel,
                    current_xp: newCurrentXP,
                    total_xp: newTotalXP,
                    streak_days: newStreakDays,
                    longest_streak: newLongestStreak,
                    last_brush_date: today,
                    total_sessions: (profile.total_sessions || 0) + 1,
                    total_germs_killed: (profile.total_germs_killed || 0) + result.germsKilled,
                    total_brush_minutes: (profile.total_brush_minutes || 0) + result.duration
                })
                .eq('id', profileId)
                .select()
                .single();

            if (error) throw error;
            console.log('æ¡£æ¡ˆå·²æ›´æ–°:', data);
            return data;
        }

        // æ£€æŸ¥æˆå°±
        async function checkAchievements(profileId, result, xp) {
            try {
                const supabase = BrushingMasterDB.getSupabaseClient();

                // è·å–æ›´æ–°åçš„æ¡£æ¡ˆ
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', profileId)
                    .single();

                if (!profile) return;

                // æ£€æŸ¥æ–°æ‰‹æˆå°±
                if (profile.total_sessions === 1) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'newbie');
                }

                // æ£€æŸ¥è¿ç»­å¤©æ•°æˆå°±
                if (profile.streak_days >= 7) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'streak7');
                }
                if (profile.streak_days >= 30) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'streak30');
                }
                if (profile.streak_days >= 60) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'streak60');
                }

                // æ£€æŸ¥ç»†èŒæˆå°±
                if (profile.total_germs_killed >= 1000) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'germbuster');
                }
                if (profile.total_germs_killed >= 10000) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'germlord');
                }

                // æ£€æŸ¥ç­‰çº§æˆå°±
                if (profile.level >= 10) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'master');
                }
                if (profile.level >= 20) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'legend');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æˆå°±å¤±è´¥:', error);
            }
        }

        // é™çº§åˆ° localStorage
        function fallbackToLocalStorage(xp) {
            const settings = JSON.parse(localStorage.getItem('brushingMasterSettings')) || { profiles: [] };
            const activeProfile = settings.profiles.find(p => p.active);
            if (activeProfile) {
                activeProfile.currentXP = (activeProfile.currentXP || 0) + xp.total;
                while (activeProfile.currentXP >= (activeProfile.maxXP || 100)) {
                    activeProfile.currentXP -= activeProfile.maxXP || 100;
                    activeProfile.level = (activeProfile.level || 1) + 1;
                    activeProfile.maxXP = 100 + (activeProfile.level - 1) * 50;
                }
                localStorage.setItem('brushingMasterSettings', JSON.stringify(settings));
            }
        }

        // æ›´æ–°å¥–åŠ±æ˜¾ç¤º
        function updateRewardDisplay(skinDrop, xp) {
            if (skinDrop) {
                document.getElementById('reward-title').textContent = 'è§£é”æ–°çš®è‚¤ï¼';
                document.getElementById('reward-icon').innerHTML = `<img src="${skinDrop.icon}" class="w-full h-full object-cover" />`;
                document.getElementById('reward-name').textContent = skinDrop.name;
            } else {
                document.getElementById('reward-container').classList.remove('bg-[var(--accent-yellow)]');
                document.getElementById('reward-container').classList.add('bg-blue-100');
                document.getElementById('reward-title').textContent = 'ç»éªŒè·å–ï¼';
                document.getElementById('reward-icon').innerHTML = `<i class="fas fa-star text-4xl text-[var(--accent-yellow)]"></i>`;
                document.getElementById('reward-name').textContent = `${xp.total} XP`;
            }
        }

        // è¿”å›ä¸»é¡µ
        function goHome() {
            sessionStorage.removeItem('lastGameResult');
            location.href = 'home.html';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', initResultPage);
    </script>

</body>

</html>