<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="auth_guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <script src="supabase_client.js"></script>
    <title>Result - Brushing Master</title>
</head>

<body
    class="app-shell bg-[var(--primary-green)] safe-area-top safe-area-bottom px-6 pt-8 text-center">

    <header class="mb-4 flex-shrink-0">
        <div class="text-white text-5xl mb-2 drop-shadow-[4px_4px_0_#333]">
            <i class="fas fa-award"></i>
        </div>
        <h1 class="text-3xl font-black text-white uppercase drop-shadow-[4px_4px_0_#333]">å¤ªæ£’äº†ï¼</h1>
        <p class="font-black text-white text-opacity-80 uppercase text-xs mt-1">ä½ ä»Šå¤©å¸®åŠ©äº†å°çŒ«å¤´é¹°ï¼</p>
    </header>

    <div class="app-scroll flex flex-col gap-4 min-h-0">
        <!-- Rewards Earned Banner -->
        <div class="kawaii-card bg-white py-3 flex items-center justify-center gap-6">
            <!-- Points -->
            <div class="flex items-center gap-2">
                <i class="fas fa-bolt text-2xl text-[var(--accent-yellow)]"></i>
                <div class="text-left">
                    <span class="text-[10px] font-black text-gray-400 uppercase">è·å¾—ç§¯åˆ†</span>
                    <div class="flex items-baseline gap-1">
                        <span class="text-2xl font-black text-[var(--primary-green)]" id="points-earned">+50</span>
                    </div>
                </div>
            </div>
            <!-- Coins -->
            <div class="flex items-center gap-2">
                <i class="fas fa-coins text-2xl text-yellow-400"></i>
                <div class="text-left">
                    <span class="text-[10px] font-black text-gray-400 uppercase">è·å¾—é‡‘å¸</span>
                    <div class="flex items-baseline gap-1">
                        <span class="text-2xl font-black text-yellow-500" id="coins-earned">+3</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Streak Bonus (if any) -->
        <div id="streak-bonus" class="hidden kawaii-card bg-amber-50 py-2 px-4 flex items-center justify-center gap-2">
            <i class="fas fa-fire text-orange-500"></i>
            <span class="font-black text-sm text-orange-600" id="streak-bonus-text">è¿ç»­ 5 å¤©ï¼+10 é¢å¤–ç§¯åˆ†</span>
        </div>

        <!-- Stats -->
        <div class="kawaii-card grid grid-cols-2 gap-4 py-3">
            <div class="flex flex-col border-r-4 border-[#333] border-dashed">
                <span class="text-[10px] font-black text-gray-400">å‡»è´¥ç»†èŒ</span>
                <span class="text-xl font-black" id="germs-killed">42</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] font-black text-gray-400">è¿ç»­å¤©æ•°</span>
                <span class="text-xl font-black" id="streak-days">5 å¤©</span>
            </div>
        </div>

        <!-- Shop Hint Card -->
        <div id="reward-container"
            class="kawaii-card bg-gradient-to-br from-yellow-100 to-orange-100 p-4 relative overflow-hidden flex-1 min-h-0 flex flex-col items-center justify-center cursor-pointer hidden"
            onclick="location.href='collection.html'">
            <div class="absolute -top-4 -left-4 text-yellow-300 opacity-30 text-6xl transform -rotate-12">
                <i class="fas fa-coins"></i>
            </div>
            <h3 class="font-black text-base mb-2 text-[#333] uppercase">å‰å¾€å•†åº—</h3>
            <div id="reward-icon"
                class="w-16 h-16 bg-white border-4 border-[#333] rounded-2xl flex items-center justify-center mb-2 shadow-[4px_4px_0_#333]">
                <i class="fas fa-store text-3xl text-yellow-500"></i>
            </div>
            <span class="font-black text-xs text-gray-500">ç”¨é‡‘å¸å…‘æ¢æ–°çš®è‚¤å’Œè´´çº¸</span>
            <div class="flex items-center gap-1 mt-2 text-yellow-600">
                <span class="text-xs font-bold">ç‚¹å‡»è¿›å…¥</span>
                <i class="fas fa-chevron-right text-xs"></i>
            </div>
        </div>
    </div>

    <!-- Bottom CTA - sticky with safe area -->
    <div class="sticky-bottom-safe flex flex-col gap-3 pt-4 bg-[var(--primary-green)] flex-shrink-0">
        <button class="kawaii-button kawaii-button-yellow w-full py-3 text-base"
            onclick="location.href='photo_edit.html'">
            <i class="fas fa-paint-brush mr-2"></i> è£…é¥°ç…§ç‰‡
        </button>
        <button class="kawaii-button kawaii-button-primary w-full py-3 text-base" onclick="goHome()">
            <i class="fas fa-home mr-2"></i> è¿”å›ä¸»é¡µ
        </button>
    </div>

    <script>
        // ===== REWARD SYSTEM CONFIGURATION =====
        // ç§¯åˆ†å¥–åŠ±ï¼ˆæ ¹æ®æ—¶é•¿ï¼‰
        const POINTS_REWARDS = {
            1: 30,  // 1åˆ†é’Ÿåˆ·ç‰™
            2: 50,  // 2åˆ†é’Ÿåˆ·ç‰™
            3: 80   // 3åˆ†é’Ÿåˆ·ç‰™
        };
        const STREAK_BONUS = 10;  // æ¯è¿ç»­1å¤©é¢å¤–åŠ æˆ
        const GERM_POINTS_RATE = 0.1; // æ¯10ä¸ªç»†èŒ +1 ç§¯åˆ†
        const MAX_GERM_POINTS = 50;   // å‡»è´¥ç»†èŒç§¯åˆ†ä¸Šé™

        // é‡‘å¸å¥–åŠ±ï¼ˆæ ¹æ®æ—¶é•¿ï¼‰
        const COIN_REWARDS = {
            1: 1,   // 1åˆ†é’Ÿ: 1é‡‘å¸
            2: 2,   // 2åˆ†é’Ÿ: 2é‡‘å¸
            3: 3    // 3åˆ†é’Ÿ: 3é‡‘å¸
        };
        const GERM_COIN_RATE = 0.05; // æ¯20ä¸ªç»†èŒ +1 é‡‘å¸
        const MAX_GERM_COINS = 5;    // å‡»è´¥ç»†èŒé‡‘å¸ä¸Šé™

        // å…¨å±€çŠ¶æ€
        let currentProfile = null;
        let sessionData = null;

        // è·å–æ¸¸æˆç»“æœæ•°æ®
        function getGameResult() {
            const result = sessionStorage.getItem('lastGameResult');
            if (result) {
                const parsed = JSON.parse(result);
                // å¦‚æœæœ‰çœŸå®æ¸¸æˆåˆ†æ•°ï¼Œä½¿ç”¨å®ƒ
                // æ–°å¢å­—æ®µ: score, successCount, totalBrushTime, accuracy, durationMs
                console.log('[GameResult] è§£ææ¸¸æˆæ•°æ®:', parsed);
                return parsed;
            }
            return {
                duration: 2,
                germsKilled: Math.floor(Math.random() * 50) + 30,
                streakDays: Math.floor(Math.random() * 10) + 1
            };
        }

        // è®¡ç®—ç§¯åˆ†
        function calculatePoints(duration, germsKilled, streakDays) {
            let basePoints = POINTS_REWARDS[duration] || 50;
            let streakPoints = streakDays > 1 ? (streakDays - 1) * STREAK_BONUS : 0;
            let germPoints = Math.min(Math.floor(germsKilled * GERM_POINTS_RATE), MAX_GERM_POINTS);
            return {
                base: basePoints,
                streak: streakPoints,
                germs: germPoints,
                total: basePoints + streakPoints + germPoints
            };
        }

        // è®¡ç®—é‡‘å¸
        function calculateCoins(duration, germsKilled) {
            let baseCoins = COIN_REWARDS[duration] || 1;
            let germCoins = Math.min(Math.floor(germsKilled * GERM_COIN_RATE), MAX_GERM_COINS);
            return {
                base: baseCoins,
                germs: germCoins,
                total: baseCoins + germCoins
            };
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initResultPage() {
            const result = getGameResult();

            // å¦‚æœæœ‰çœŸå®æ¸¸æˆåˆ†æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
            let points;
            if (result.score !== undefined) {
                // ä½¿ç”¨çœŸå®æ¸¸æˆåˆ†æ•°
                const streakPoints = result.streakDays > 1 ? (result.streakDays - 1) * STREAK_BONUS : 0;
                points = {
                    base: result.score,
                    streak: streakPoints,
                    germs: 0,
                    total: result.score + streakPoints
                };
                console.log('[GameResult] ä½¿ç”¨çœŸå®æ¸¸æˆåˆ†æ•°:', result.score);
            } else {
                // ä½¿ç”¨è®¡ç®—çš„åˆ†æ•°
                points = calculatePoints(result.duration, result.germsKilled, result.streakDays);
            }

            const coins = calculateCoins(result.duration, result.germsKilled);

            // æ›´æ–°ç§¯åˆ†å’Œé‡‘å¸æ˜¾ç¤º
            document.getElementById('points-earned').textContent = `+${points.total}`;
            document.getElementById('coins-earned').textContent = `+${coins.total}`;

            // æ˜¾ç¤ºè¿ç»­å¥–åŠ±
            if (points.streak > 0) {
                document.getElementById('streak-bonus').classList.remove('hidden');
                document.getElementById('streak-bonus-text').textContent =
                    `è¿ç»­ ${result.streakDays} å¤©ï¼+${points.streak} é¢å¤–ç§¯åˆ†`;
            }

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('germs-killed').textContent = result.germsKilled;
            document.getElementById('streak-days').textContent = `${result.streakDays} å¤©`;

            try {
                const profileId = localStorage.getItem('activeProfileId');
                console.log('ğŸ® æ¸¸æˆç»“æœ - activeProfileId:', profileId);

                if (profileId) {
                    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºå•†åº—å¼•å¯¼
                    const supabase = BrushingMasterDB.getSupabaseClient();
                    const { data: profile } = await supabase
                        .from('user_profiles')
                        .select('diamonds') // æ•°æ®åº“å­—æ®µä»ä¸º diamonds
                        .eq('id', profileId)
                        .single();

                    const currentBalance = profile ? (profile.diamonds || 0) : 0;
                    const totalBalance = currentBalance + coins.total;

                    // åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘å¸è´­ä¹°è‡³å°‘ä¸€ä¸ªçš®è‚¤
                    // çš®è‚¤ä»·æ ¼: 10, 15, 20
                    if (totalBalance >= 10) {
                        document.getElementById('reward-container').classList.remove('hidden');
                    } else {
                        document.getElementById('reward-container').classList.add('hidden');
                    }

                    // ä¿å­˜åˆ·ç‰™ä¼šè¯åˆ°æ•°æ®åº“
                    console.log('ğŸ’¾ æ­£åœ¨ä¿å­˜åˆ·ç‰™ä¼šè¯...', { profileId, result, points, coins });
                    await saveBrushingSession(profileId, result, points, coins);
                    console.log('âœ… åˆ·ç‰™ä¼šè¯ä¿å­˜æˆåŠŸ');

                    // æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆï¼ˆç§¯åˆ†å’Œé‡‘å¸ï¼‰
                    console.log('ğŸ“ æ­£åœ¨æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ...');
                    await updateUserProfileInDB(profileId, result, points, coins);
                    console.log('âœ… ç”¨æˆ·æ¡£æ¡ˆæ›´æ–°æˆåŠŸ');

                    // æ£€æŸ¥æˆå°±
                    await checkAchievements(profileId, result, points);
                } else {
                    console.error('âŒ æ²¡æœ‰æ‰¾åˆ° activeProfileIdï¼Œæ— æ³•ä¿å­˜åˆ°æ•°æ®åº“');
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜æ•°æ®åˆ°åç«¯å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                // é™çº§åˆ° localStorage
                fallbackToLocalStorage(points, coins);
            }
        }

        // ä¿å­˜åˆ·ç‰™ä¼šè¯åˆ°æ•°æ®åº“
        async function saveBrushingSession(profileId, result, points, coins) {
            const supabase = BrushingMasterDB.getSupabaseClient();
            const { data, error } = await supabase
                .from('brushing_sessions')
                .insert({
                    profile_id: profileId,
                    duration_minutes: result.duration,
                    germs_killed: result.germsKilled,
                    base_xp: points.base,
                    streak_bonus_xp: points.streak,
                    germ_bonus_xp: points.germs,
                    total_xp: points.total,
                    diamonds_earned: coins.total, // æ•°æ®åº“æš‚æ—¶ä¿ç•™ diamonds_earned å­—æ®µå
                    streak_at_session: result.streakDays,
                    completed_at: new Date().toISOString()
                })
                .select()
                .single();

            if (error) throw error;
            console.log('åˆ·ç‰™ä¼šè¯å·²ä¿å­˜:', data);
            return data;
        }

        // æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆï¼ˆç§¯åˆ†å’Œé‡‘å¸ï¼‰
        async function updateUserProfileInDB(profileId, result, points, coins) {
            const supabase = BrushingMasterDB.getSupabaseClient();

            // å…ˆè·å–å½“å‰æ¡£æ¡ˆ
            const { data: profile, error: fetchError } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('id', profileId)
                .single();

            if (fetchError) throw fetchError;

            // è®¡ç®—æ–°çš„æ€»ç§¯åˆ†å’Œé‡‘å¸ï¼ˆä¸å†æœ‰ç­‰çº§æ¦‚å¿µï¼‰
            let newTotalXP = (profile.total_xp || 0) + points.total;
            let newDiamonds = (profile.diamonds || 0) + coins.total; // DB uses diamonds

            // æ›´æ–°è¿ç»­å¤©æ•°
            const today = new Date().toISOString().split('T')[0];
            let newStreakDays = profile.streak_days || 0;
            let newLongestStreak = profile.longest_streak || 0;

            if (profile.last_brush_date !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                if (profile.last_brush_date === yesterdayStr) {
                    newStreakDays++;
                } else {
                    newStreakDays = 1;
                }

                if (newStreakDays > newLongestStreak) {
                    newLongestStreak = newStreakDays;
                }
            }

            // æ›´æ–°æ¡£æ¡ˆï¼ˆç§»é™¤levelå’Œcurrent_xpï¼‰
            const { data, error } = await supabase
                .from('user_profiles')
                .update({
                    total_xp: newTotalXP,
                    diamonds: newDiamonds,
                    streak_days: newStreakDays,
                    longest_streak: newLongestStreak,
                    last_brush_date: today,
                    total_sessions: (profile.total_sessions || 0) + 1,
                    total_germs_killed: (profile.total_germs_killed || 0) + result.germsKilled,
                    total_brush_minutes: (profile.total_brush_minutes || 0) + result.duration
                })
                .eq('id', profileId)
                .select()
                .single();

            if (error) throw error;
            console.log('æ¡£æ¡ˆå·²æ›´æ–°:', data);

            // æ›´æ–°ç¼“å­˜ä¾›ä¸»é¡µä½¿ç”¨
            if (data) {
                const cacheData = {
                    id: data.id,
                    profile_name: data.profile_name,
                    avatar_id: data.avatar_id,
                    total_xp: data.total_xp || 0,
                    diamonds: data.diamonds || 0,
                    streak_days: data.streak_days || 0,
                    total_sessions: data.total_sessions || 0,
                    total_brush_minutes: data.total_brush_minutes || 0
                };
                localStorage.setItem('cachedActiveProfile', JSON.stringify(cacheData));
                console.log('âœ… æ¡£æ¡ˆç¼“å­˜å·²æ›´æ–°');
            }

            return data;
        }

        // æ£€æŸ¥æˆå°±
        async function checkAchievements(profileId, result, points) {
            try {
                const supabase = BrushingMasterDB.getSupabaseClient();

                // è·å–æ›´æ–°åçš„æ¡£æ¡ˆ
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', profileId)
                    .single();

                if (!profile) return;

                // æ£€æŸ¥æ–°æ‰‹æˆå°±
                if (profile.total_sessions === 1) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'newbie');
                }

                // æ£€æŸ¥è¿ç»­å¤©æ•°æˆå°±
                if (profile.streak_days >= 7) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'streak7');
                }
                if (profile.streak_days >= 30) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'streak30');
                }
                if (profile.streak_days >= 60) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'streak60');
                }

                // æ£€æŸ¥ç»†èŒæˆå°±
                if (profile.total_germs_killed >= 1000) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'germbuster');
                }
                if (profile.total_germs_killed >= 10000) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'germlord');
                }

                // æ£€æŸ¥ç§¯åˆ†é‡Œç¨‹ç¢‘æˆå°±ï¼ˆä»£æ›¿ç­‰çº§æˆå°±ï¼‰
                if (profile.total_xp >= 1000) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'master');
                }
                if (profile.total_xp >= 5000) {
                    await BrushingMasterDB.unlockAchievement(profileId, 'legend');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æˆå°±å¤±è´¥:', error);
            }
        }

        // é™çº§åˆ° localStorage
        function fallbackToLocalStorage(points, coins) {
            const settings = JSON.parse(localStorage.getItem('brushingMasterSettings')) || { profiles: [] };
            const activeProfile = settings.profiles.find(p => p.active);
            if (activeProfile) {
                activeProfile.totalPoints = (activeProfile.totalPoints || 0) + points.total;
                activeProfile.diamonds = (activeProfile.diamonds || 0) + coins.total;
                localStorage.setItem('brushingMasterSettings', JSON.stringify(settings));
            }
        }

        // è¿”å›ä¸»é¡µ
        function goHome() {
            sessionStorage.removeItem('lastGameResult');
            location.href = 'home.html';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', initResultPage);
    </script>

</body>

</html>