<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="auth_guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <script src="supabase_client.js"></script>
    <title>Decorate - Brushing Master</title>
    <style>
        /* Transform-based slider for circular navigation */
        .photo-slider {
            display: flex;
            transition: transform 0.3s ease-out;
        }

        .photo-slide {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .sticker-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: visible;
            touch-action: none;
        }

        .sticker {
            pointer-events: auto;
            touch-action: none;
            user-select: none;
            cursor: grab;
            position: relative;
        }

        .sticker.dragging {
            cursor: grabbing;
            z-index: 100;
        }

        .sticker .delete-btn {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 28px;
            height: 28px;
            background: #ff4757;
            border: 2px solid #333;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            line-height: 28px;
            text-align: center;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            /* Prevent button from scaling with sticker */
            transform-origin: center;
        }

        .sticker .scale-btn {
            position: absolute;
            width: 28px;
            height: 28px;
            background: var(--primary-green);
            border: 2px solid #333;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            line-height: 24px;
            text-align: center;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .sticker .scale-btn.minus {
            bottom: -4px;
            left: -4px;
        }

        .sticker .scale-btn.plus {
            bottom: -4px;
            right: -4px;
        }

        .sticker.selected .delete-btn,
        .sticker.selected .scale-btn {
            display: flex;
        }

        .sticker.selected {
            outline: 3px dashed #ff4757;
            outline-offset: 2px;
        }

        /* Save Modal Styles */
        .save-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .save-modal-overlay.active {
            display: flex;
        }

        .save-modal {
            max-width: 360px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .photo-select-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .photo-select-item {
            position: relative;
            aspect-ratio: 1;
            border: 4px solid var(--stroke-dark);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-select-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-select-item.selected {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px var(--secondary-green);
        }

        .photo-select-item .check-indicator {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: var(--primary-green);
            border: 3px solid var(--stroke-dark);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .photo-select-item.selected .check-indicator {
            display: flex;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-sticker {
            position: absolute;
            pointer-events: none;
        }

        /* Save success modal animation */
        @keyframes bounce-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .animate-bounce-in {
            animation: bounce-in 0.4s ease-out;
        }
    </style>
</head>

<body class="h-screen flex flex-col pt-10 bg-[#F8F9FA] safe-area-top safe-area-bottom no-scroll">

    <!-- Save Modal Overlay -->
    <div id="save-modal" class="save-modal-overlay">
        <div class="kawaii-card save-modal">
            <h2 class="text-lg font-black text-center mb-4">é€‰æ‹©è¦ä¿å­˜çš„ç…§ç‰‡</h2>
            <p class="text-xs text-gray-500 text-center mb-4">ç‚¹å‡»é€‰æ‹©ï¼Œå¯å¤šé€‰</p>
            <div class="photo-select-grid" id="photo-select-grid">
                <div class="photo-select-item selected" data-index="0" onclick="togglePhotoSelection(0)">
                    <div class="preview-container" id="preview-0"></div>
                    <div class="check-indicator"><i class="fas fa-check"></i></div>
                </div>
                <div class="photo-select-item selected" data-index="1" onclick="togglePhotoSelection(1)">
                    <div class="preview-container" id="preview-1"></div>
                    <div class="check-indicator"><i class="fas fa-check"></i></div>
                </div>
                <div class="photo-select-item selected" data-index="2" onclick="togglePhotoSelection(2)">
                    <div class="preview-container" id="preview-2"></div>
                    <div class="check-indicator"><i class="fas fa-check"></i></div>
                </div>
                <div class="photo-select-item selected" data-index="3" onclick="togglePhotoSelection(3)">
                    <div class="preview-container" id="preview-3"></div>
                    <div class="check-indicator"><i class="fas fa-check"></i></div>
                </div>
                <div class="photo-select-item selected" data-index="4" onclick="togglePhotoSelection(4)">
                    <div class="preview-container" id="preview-4"></div>
                    <div class="check-indicator"><i class="fas fa-check"></i></div>
                </div>
                <div class="photo-select-item selected" data-index="5" onclick="togglePhotoSelection(5)">
                    <div class="preview-container" id="preview-5"></div>
                    <div class="check-indicator"><i class="fas fa-check"></i></div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button class="kawaii-button kawaii-button-yellow flex-1 text-sm py-2"
                    onclick="closeSaveModal()">å–æ¶ˆ</button>
                <button class="kawaii-button kawaii-button-primary flex-1 text-sm py-2"
                    onclick="confirmSave()">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div id="cancel-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-6">
        <div class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] p-6">
            <div class="text-center mb-4">
                <div class="text-5xl mb-3">âš ï¸</div>
                <h2 class="text-lg font-black mb-2">ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ</h2>
                <p class="text-sm text-gray-500">ç…§ç‰‡å°†ä¸ä¼šä¿å­˜ï¼Œä¸”æ— æ³•æ‰¾å›ã€‚</p>
            </div>
            <div class="flex gap-3">
                <button class="flex-1 kawaii-button kawaii-button-yellow py-2 text-sm" onclick="closeCancelModal()">
                    ç»§ç»­ç¼–è¾‘
                </button>
                <button class="flex-1 kawaii-button kawaii-button-red py-2 text-sm" onclick="location.href='home.html'">
                    ç¡®è®¤å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Save Success Modal -->
    <div id="save-success-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[600] p-6">
        <div class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] p-6 transform animate-bounce-in">
            <div class="text-center mb-4">
                <div class="text-6xl mb-3">ğŸ‰</div>
                <h2 class="text-xl font-black mb-2 text-[var(--primary-green)]">æ“ä½œå®Œæˆï¼</h2>
                <p class="text-sm text-gray-500" id="save-success-msg">å·²ä¿å­˜ <span id="save-success-count" class="font-black text-[var(--primary-green)]">0</span> å¼ ç…§ç‰‡åˆ°ç›¸å†Œ</p>
            </div>
            <button class="w-full kawaii-button kawaii-button-primary py-3 text-sm font-black" onclick="closeSaveSuccessModal()">
                <i class="fas fa-check mr-2"></i>å®Œæˆ
            </button>
        </div>
    </div>

    <!-- iOS Photo Preview Modal -->
    <div id="ios-preview-modal" class="fixed inset-0 bg-black z-[500] hidden flex flex-col">
        <div class="flex items-center justify-between p-4 bg-black/80">
            <span class="text-white font-bold" id="ios-preview-counter">1 / 1</span>
            <span class="text-white text-sm" id="ios-saved-hint">é•¿æŒ‰å›¾ç‰‡ä¿å­˜</span>
            <button onclick="closeIosPreview()" class="text-white text-2xl px-2">&times;</button>
        </div>
        <div class="flex-1 flex items-center justify-center overflow-auto p-4 relative">
            <!-- iOS é•¿æŒ‰ä¿å­˜éœ€è¦: -webkit-touch-callout:default, user-select:auto -->
            <img id="ios-preview-image" src="" class="max-w-full max-h-full object-contain rounded-2xl"
                 style="-webkit-touch-callout: default; -webkit-user-select: auto; user-select: auto;" />
            <!-- ä¿å­˜æˆåŠŸæç¤ºï¼ˆè¦†ç›–åœ¨å›¾ç‰‡ä¸Šï¼‰ -->
            <div id="ios-save-success-hint" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
                <div class="bg-black/70 rounded-3xl px-8 py-6 text-center">
                    <div class="text-5xl mb-2">âœ…</div>
                    <p class="text-white font-bold" id="ios-hint-text">ç¬¬ 1 å¼  å·²ä¿å­˜</p>
                    <p class="text-white/70 text-sm">ç…§ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ</p>
                </div>
            </div>
        </div>
        <div class="p-4 bg-black/80">
            <p class="text-white text-center text-sm mb-3 opacity-80" id="ios-instruction">
                <i class="fas fa-hand-pointer mr-1"></i>é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ â†’ é€‰æ‹©"ä¿å­˜åˆ°'ç…§ç‰‡'"
            </p>
            <div class="flex justify-center gap-3">
                <button onclick="iosPrevPhoto()" class="kawaii-button kawaii-button-yellow px-5 py-2 text-sm" id="ios-prev-btn">
                    <i class="fas fa-chevron-left mr-1"></i>ä¸Šä¸€å¼ 
                </button>
                <button onclick="iosNextPhoto()" class="kawaii-button kawaii-button-primary px-5 py-2 text-sm" id="ios-next-btn">
                    ä¸‹ä¸€å¼ <i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function confirmCancel() {
            document.getElementById('cancel-modal').classList.remove('hidden');
        }
        function closeCancelModal() {
            document.getElementById('cancel-modal').classList.add('hidden');
        }
    </script>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-20 left-1/2 -translate-x-1/2 z-50 opacity-0 scale-95 transition-all duration-300 pointer-events-none">
        <div class="kawaii-card bg-[var(--accent-yellow)] px-6 py-3 flex items-center gap-3 border-[#333]">
            <i class="fas fa-check-circle text-[var(--primary-green)] text-xl"></i>
            <span class="font-black text-sm" id="toast-message">æ“ä½œæˆåŠŸï¼</span>
        </div>
    </div>

    <header class="px-6 flex justify-between items-center mb-3">
        <button class="kawaii-button kawaii-button-red px-4 py-2 text-xs" onclick="confirmCancel()">
            å–æ¶ˆ
        </button>
        <h1 class="text-lg font-black">çŒ«å¤´é¹°è£…é¥°</h1>
        <button class="kawaii-button kawaii-button-primary px-4 py-2 text-xs" onclick="openSaveModal()">ä¿å­˜</button>
    </header>

    <!-- Photo Canvas with Transform-based Gallery -->
    <!-- min-h-0 is critical: allows flex item to shrink below its content size -->
    <div class="flex-1 px-6 pb-4 relative min-h-0 overflow-hidden">
        <div class="w-full h-full bg-gray-200 border-8 border-white rounded-[40px] shadow-xl overflow-hidden relative"
            id="photo-canvas">

            <!-- Photo Slider Container -->
            <div class="photo-slider w-full h-full" id="photo-slider">
                <!-- Clone of Photo 6 (for seamless left wrap) -->
                <div class="photo-slide clone" data-index="5">
                    <img src="Sample_ima/253f045d3eb5a143a1ee7c38b8188829.jpg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer"></div>
                </div>
                <!-- Photo 1 -->
                <div class="photo-slide" data-index="0">
                    <img src="Sample_ima/c663572b869502bf0cb4ca2e9db3d787.jpeg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer" id="sticker-layer-0"></div>
                </div>
                <!-- Photo 2 -->
                <div class="photo-slide" data-index="1">
                    <img src="Sample_ima/03ddc3251a33a2da3ac190b368c3e6e6.jpg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer" id="sticker-layer-1"></div>
                </div>
                <!-- Photo 3 -->
                <div class="photo-slide" data-index="2">
                    <img src="Sample_ima/9ad1c9c090e4b32d700bdda8a1179f95.jpg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer" id="sticker-layer-2"></div>
                </div>
                <!-- Photo 4 -->
                <div class="photo-slide" data-index="3">
                    <img src="Sample_ima/ba3c9719f84490a9e2257a0ed01d3faa.jpg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer" id="sticker-layer-3"></div>
                </div>
                <!-- Photo 5 -->
                <div class="photo-slide" data-index="4">
                    <img src="Sample_ima/f3bd68d0920e6f239d00e877d49d1878.jpg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer" id="sticker-layer-4"></div>
                </div>
                <!-- Photo 6 -->
                <div class="photo-slide" data-index="5">
                    <img src="Sample_ima/253f045d3eb5a143a1ee7c38b8188829.jpg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer" id="sticker-layer-5"></div>
                </div>
                <!-- Clone of Photo 1 (for seamless right wrap) -->
                <div class="photo-slide clone" data-index="0">
                    <img src="Sample_ima/c663572b869502bf0cb4ca2e9db3d787.jpeg" class="w-full h-full object-cover"
                        draggable="false" />
                    <div class="sticker-layer"></div>
                </div>
            </div>

            <!-- Swipe Hint (shows briefly on load) -->
            <div id="swipe-hint"
                class="absolute inset-0 flex items-center justify-center bg-black/30 z-30 transition-opacity duration-500 pointer-events-none">
                <div class="text-white text-center">
                    <div class="flex items-center justify-center gap-4">
                        <i class="fas fa-chevron-left text-2xl animate-pulse"></i>
                        <i class="fas fa-hand-pointer text-4xl"></i>
                        <i class="fas fa-chevron-right text-2xl animate-pulse"></i>
                    </div>
                    <p class="mt-2 font-black text-sm">å·¦å³æ»‘åŠ¨åˆ‡æ¢ç…§ç‰‡</p>
                </div>
            </div>

            <!-- Pagination Dots -->
            <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 z-10" id="pagination-dots">
                <div class="p-2 cursor-pointer" data-index="0">
                    <div class="w-3 h-3 rounded-full bg-white border-2 border-[#333] dot active"></div>
                </div>
                <div class="p-2 cursor-pointer" data-index="1">
                    <div class="w-3 h-3 rounded-full bg-white/50 border-2 border-[#333] dot"></div>
                </div>
                <div class="p-2 cursor-pointer" data-index="2">
                    <div class="w-3 h-3 rounded-full bg-white/50 border-2 border-[#333] dot"></div>
                </div>
                <div class="p-2 cursor-pointer" data-index="3">
                    <div class="w-3 h-3 rounded-full bg-white/50 border-2 border-[#333] dot"></div>
                </div>
                <div class="p-2 cursor-pointer" data-index="4">
                    <div class="w-3 h-3 rounded-full bg-white/50 border-2 border-[#333] dot"></div>
                </div>
                <div class="p-2 cursor-pointer" data-index="5">
                    <div class="w-3 h-3 rounded-full bg-white/50 border-2 border-[#333] dot"></div>
                </div>
            </div>

            <!-- Photo Counter -->
            <div class="absolute top-4 right-4 bg-black/50 text-white text-xs font-black px-3 py-1 rounded-full z-10">
                <span id="photo-counter">1</span> / 6
            </div>
        </div>
    </div>

    <!-- Sticker Tray -->
    <div class="p-4 pt-3 pb-2 bg-white border-t-4 border-[#333] mt-6 rounded-t-[32px]">
        <!-- Sticker usage hint -->
        <p class="text-xs text-gray-400 mb-2 text-center">
            <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>
            ç‚¹å‡»æ·»åŠ è´´çº¸ Â· æ‹–åŠ¨ç§»åŠ¨ Â· ç‚¹å‡» +/- ç¼©æ”¾ Â· ç‚¹å‡» Ã— åˆ é™¤
        </p>
        <div class="flex gap-3 overflow-x-auto pt-1 pb-2 relative" id="sticker-tray">
            <div class="flex-shrink-0 w-14 h-14 kawaii-card flex items-center justify-center text-2xl cursor-pointer active:scale-95 transition-transform sticker-btn"
                data-sticker="â­ï¸">â­ï¸</div>
            <div class="flex-shrink-0 w-14 h-14 kawaii-card flex items-center justify-center text-2xl cursor-pointer active:scale-95 transition-transform sticker-btn"
                data-sticker="ğŸ’–">ğŸ’–</div>
            <div class="flex-shrink-0 w-14 h-14 kawaii-card flex items-center justify-center text-2xl cursor-pointer active:scale-95 transition-transform sticker-btn"
                data-sticker="âœ¨">âœ¨</div>
            <div class="flex-shrink-0 w-14 h-14 kawaii-card flex items-center justify-center text-2xl cursor-pointer active:scale-95 transition-transform sticker-btn"
                data-sticker="ğŸŒˆ">ğŸŒˆ</div>
            <div class="flex-shrink-0 w-14 h-14 kawaii-card flex items-center justify-center text-2xl cursor-pointer active:scale-95 transition-transform sticker-btn"
                data-sticker="ğŸ§">ğŸ§</div>
            <div
                class="flex-shrink-0 w-14 h-14 kawaii-card bg-gray-100 border-dashed flex items-center justify-center text-gray-400">
                <i class="fas fa-lock text-sm"></i>
            </div>

        </div>

        <script>
            // ===== PHOTO GALLERY STATE (INFINITE CAROUSEL) =====
            let currentSlidePosition = 1;
            const totalPhotos = 6;
            const slider = document.getElementById('photo-slider');
            const dots = document.querySelectorAll('.dot');
            const dotWrappers = document.querySelectorAll('#pagination-dots > div[data-index]');
            const counter = document.getElementById('photo-counter');
            const canvas = document.getElementById('photo-canvas');

            // Initialize slider at position 1 (the real photo 1)
            slider.style.transform = `translateX(-${currentSlidePosition * 100}%)`;

            // Hide swipe hint after 2 seconds
            setTimeout(() => {
                const hint = document.getElementById('swipe-hint');
                if (hint) {
                    hint.classList.add('opacity-0');
                    setTimeout(() => hint.remove(), 500);
                }
            }, 2000);

            // Get real photo index (0-5) from slide position (0-7)
            // Added bounds checking to prevent -1/6 display bug
            function getRealIndex(position) {
                // Clamp position to valid range first
                if (position < 0) position = 0;
                if (position > 7) position = 7;

                if (position === 0) return 5;
                if (position === 7) return 0;
                return position - 1;
            }

            // Update UI (dots and counter) based on current position
            function updateUI() {
                const realIndex = getRealIndex(currentSlidePosition);
                counter.textContent = realIndex + 1;

                dots.forEach((dot, i) => {
                    if (i === realIndex) {
                        dot.classList.add('bg-white');
                        dot.classList.remove('bg-white/50');
                    } else {
                        dot.classList.remove('bg-white');
                        dot.classList.add('bg-white/50');
                    }
                });
            }

            // Update slider transform with animation
            // Added isAnimating lock to prevent race conditions
            let isAnimating = false;

            function updateSlider(animate = true) {
                if (animate) {
                    slider.style.transition = 'transform 0.3s ease-out';
                    isAnimating = true;

                    // Fallback: if transitionend doesn't fire within 400ms, force handle it
                    setTimeout(() => {
                        if (isAnimating) {
                            handleTransitionEnd();
                            isAnimating = false;
                        }
                    }, 400);
                } else {
                    slider.style.transition = 'none';
                }
                slider.style.transform = `translateX(-${currentSlidePosition * 100}%)`;
                updateUI();
            }

            // Handle jump-back after reaching clone slides
            function handleTransitionEnd() {
                isAnimating = false;

                if (currentSlidePosition === 0) {
                    currentSlidePosition = 6;
                    updateSlider(false);
                } else if (currentSlidePosition === 7) {
                    currentSlidePosition = 1;
                    updateSlider(false);
                }

                // Safety: ensure position is always valid (1-6)
                if (currentSlidePosition < 1) {
                    currentSlidePosition = 1;
                    updateSlider(false);
                } else if (currentSlidePosition > 6) {
                    currentSlidePosition = 6;
                    updateSlider(false);
                }
            }

            slider.addEventListener('transitionend', handleTransitionEnd);

            // Go to next photo (seamless) - with lock check
            function nextPhoto() {
                if (isAnimating) return; // Prevent rapid clicks
                currentSlidePosition++;
                updateSlider(true);
            }

            // Go to previous photo (seamless) - with lock check
            function prevPhoto() {
                if (isAnimating) return; // Prevent rapid clicks
                currentSlidePosition--;
                updateSlider(true);
            }

            // Go to specific photo (by real index 0-5)
            function goToPhoto(realIndex) {
                if (isAnimating) return;
                currentSlidePosition = realIndex + 1;
                updateSlider(true);
            }

            // ===== TOUCH SWIPE FOR GALLERY =====
            let touchStartX = 0;
            let touchCurrentX = 0;
            let isSwiping = false;

            canvas.addEventListener('touchstart', (e) => {
                if (e.target.closest('.sticker')) return;
                touchStartX = e.touches[0].clientX;
                touchCurrentX = touchStartX;
                isSwiping = true;
                slider.style.transition = 'none';
            }, { passive: true });

            canvas.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                touchCurrentX = e.touches[0].clientX;
                const diff = touchCurrentX - touchStartX;
                const baseOffset = -currentSlidePosition * 100;
                const dragOffset = (diff / canvas.offsetWidth) * 100;
                slider.style.transform = `translateX(${baseOffset + dragOffset}%)`;
            }, { passive: true });

            canvas.addEventListener('touchend', (e) => {
                if (!isSwiping) return;
                isSwiping = false;
                slider.style.transition = 'transform 0.3s ease-out';
                const diff = touchCurrentX - touchStartX;
                const swipeThreshold = 50;

                if (diff < -swipeThreshold) {
                    nextPhoto();
                } else if (diff > swipeThreshold) {
                    prevPhoto();
                } else {
                    updateSlider(true);
                }
            });

            // ===== MOUSE DRAG FOR DESKTOP =====
            let mouseStartX = 0;
            let mouseCurrentX = 0;
            let isMouseDragging = false;

            canvas.addEventListener('mousedown', (e) => {
                if (e.target.closest('.sticker')) return;
                mouseStartX = e.clientX;
                mouseCurrentX = mouseStartX;
                isMouseDragging = true;
                slider.style.transition = 'none';
                canvas.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isMouseDragging) return;
                mouseCurrentX = e.clientX;
                const diff = mouseCurrentX - mouseStartX;
                const baseOffset = -currentSlidePosition * 100;
                const dragOffset = (diff / canvas.offsetWidth) * 100;
                slider.style.transform = `translateX(${baseOffset + dragOffset}%)`;
            });

            document.addEventListener('mouseup', (e) => {
                if (!isMouseDragging) return;
                isMouseDragging = false;
                slider.style.transition = 'transform 0.3s ease-out';
                canvas.style.cursor = '';
                const diff = mouseCurrentX - mouseStartX;
                const swipeThreshold = 50;

                if (diff < -swipeThreshold) {
                    nextPhoto();
                } else if (diff > swipeThreshold) {
                    prevPhoto();
                } else {
                    updateSlider(true);
                }
            });

            // Dot click navigation
            dotWrappers.forEach(wrapper => {
                wrapper.onclick = () => {
                    goToPhoto(parseInt(wrapper.dataset.index));
                };
            });

            // ===== TOAST FUNCTION =====
            function showToast(message) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('opacity-0', 'scale-95');
                toast.classList.add('opacity-100', 'scale-100');
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'scale-100');
                    toast.classList.add('opacity-0', 'scale-95');
                }, 2000);
            }

            // ===== PHOTO SOURCES (åŠ¨æ€åŠ è½½æŠ“æ‹ç…§ç‰‡) =====
            const defaultPhotoSources = [
                'Sample_ima/c663572b869502bf0cb4ca2e9db3d787.jpeg',
                'Sample_ima/03ddc3251a33a2da3ac190b368c3e6e6.jpg',
                'Sample_ima/9ad1c9c090e4b32d700bdda8a1179f95.jpg',
                'Sample_ima/ba3c9719f84490a9e2257a0ed01d3faa.jpg',
                'Sample_ima/f3bd68d0920e6f239d00e877d49d1878.jpg',
                'Sample_ima/253f045d3eb5a143a1ee7c38b8188829.jpg'
            ];

            // ä» sessionStorage åŠ è½½æŠ“æ‹ç…§ç‰‡ï¼Œä¸è¶³ç”¨é»˜è®¤å›¾ç‰‡è¡¥é½
            let photoSources = [...defaultPhotoSources];

            function loadCapturedPhotos() {
                try {
                    const capturedPhotosJson = sessionStorage.getItem('capturedPhotos');
                    if (capturedPhotosJson) {
                        const capturedPhotos = JSON.parse(capturedPhotosJson);
                        console.log('[PhotoEdit] åŠ è½½æŠ“æ‹ç…§ç‰‡:', capturedPhotos.length, 'å¼ ');

                        // ç”¨æŠ“æ‹ç…§ç‰‡æ›¿æ¢é»˜è®¤ç…§ç‰‡
                        for (let i = 0; i < 6; i++) {
                            if (capturedPhotos[i]) {
                                photoSources[i] = capturedPhotos[i];
                            }
                        }

                        // æ›´æ–° slider ä¸­çš„å›¾ç‰‡
                        updateSliderPhotos();
                    } else {
                        console.log('[PhotoEdit] æ²¡æœ‰æŠ“æ‹ç…§ç‰‡ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡');
                    }
                } catch (e) {
                    console.error('[PhotoEdit] åŠ è½½æŠ“æ‹ç…§ç‰‡å¤±è´¥:', e);
                }
            }

            function updateSliderPhotos() {
                const slides = document.querySelectorAll('.photo-slide');
                slides.forEach(slide => {
                    const index = parseInt(slide.dataset.index);
                    if (!isNaN(index) && index >= 0 && index < 6) {
                        const img = slide.querySelector('img');
                        if (img && photoSources[index]) {
                            img.src = photoSources[index];
                        }
                    }
                });
            }

            // ===== SAVE MODAL FUNCTIONS =====

            function openSaveModal() {
                // First, deselect all stickers to hide controls
                deselectAllStickers();

                // Generate preview for each photo with stickers
                for (let i = 0; i < 6; i++) {
                    const previewContainer = document.getElementById(`preview-${i}`);
                    previewContainer.innerHTML = '';

                    // Add base photo
                    const img = document.createElement('img');
                    img.src = photoSources[i];
                    previewContainer.appendChild(img);

                    // Clone stickers from the actual sticker layer
                    const stickerLayer = document.getElementById(`sticker-layer-${i}`);
                    if (stickerLayer) {
                        const stickers = stickerLayer.querySelectorAll('.sticker');
                        stickers.forEach(sticker => {
                            const stickerClone = document.createElement('div');
                            stickerClone.className = 'preview-sticker';
                            // Get only the emoji text (first text node), not button text
                            const emojiText = sticker.childNodes[0]?.textContent?.trim() || sticker.dataset.sticker || '';
                            stickerClone.textContent = emojiText;
                            stickerClone.style.top = sticker.style.top;
                            stickerClone.style.left = sticker.style.left;
                            stickerClone.style.fontSize = '16px'; // Scale down for thumbnail
                            stickerClone.style.transform = sticker.style.transform || 'scale(1)';
                            previewContainer.appendChild(stickerClone);
                        });
                    }
                }

                document.getElementById('save-modal').classList.add('active');
            }

            function closeSaveModal() {
                document.getElementById('save-modal').classList.remove('active');
            }

            function togglePhotoSelection(index) {
                const items = document.querySelectorAll('.photo-select-item');
                items[index].classList.toggle('selected');
            }

            // iOS é¢„è§ˆç›¸å…³çŠ¶æ€
            let iosPreviewPhotos = [];
            let iosCurrentIndex = 0;
            let iosSavedIndicesSet = new Set(); // è¿½è¸ªç”¨æˆ·é•¿æŒ‰è¿‡å“ªäº›ç…§ç‰‡ç´¢å¼•

            // æ£€æµ‹æ˜¯å¦æ˜¯ iOS
            function isIOS() {
                return /iPhone|iPad|iPod/i.test(navigator.userAgent);
            }

            async function confirmSave() {
                const selectedItems = document.querySelectorAll('.photo-select-item.selected');
                const count = selectedItems.length;
                if (count === 0) {
                    showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ ç…§ç‰‡');
                    return;
                }

                closeSaveModal();
                showToast('æ­£åœ¨ç”Ÿæˆç…§ç‰‡...');

                // æ”¶é›†é€‰ä¸­çš„ç…§ç‰‡ç´¢å¼•
                const selectedIndices = [];
                selectedItems.forEach(item => {
                    selectedIndices.push(parseInt(item.dataset.index));
                });

                if (isIOS()) {
                    // iOS: ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡ï¼Œç„¶åæ˜¾ç¤ºé¢„è§ˆè®©ç”¨æˆ·é€å¼ ç‚¹å‡»ä¿å­˜
                    iosPreviewPhotos = [];
                    for (const index of selectedIndices) {
                        try {
                            const dataUrl = await generatePhotoDataUrl(index);
                            iosPreviewPhotos.push(dataUrl);
                        } catch (e) {
                            console.error(`ç”Ÿæˆç…§ç‰‡ ${index + 1} å¤±è´¥:`, e);
                        }
                    }

                    if (iosPreviewPhotos.length > 0) {
                        showIosPreview();
                    } else {
                        showToast('ç”Ÿæˆç…§ç‰‡å¤±è´¥');
                    }
                } else {
                    // é iOS: ç›´æ¥ä¸‹è½½
                    let savedCount = 0;
                    for (const index of selectedIndices) {
                        try {
                            await downloadPhoto(index);
                            savedCount++;
                            // æ¯å¼ ç…§ç‰‡ä¹‹é—´ç¨å¾®å»¶è¿Ÿï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
                            await new Promise(r => setTimeout(r, 300));
                        } catch (e) {
                            console.error(`ä¿å­˜ç…§ç‰‡ ${index + 1} å¤±è´¥:`, e);
                        }
                    }

                    // æ˜¾ç¤ºä¿å­˜æˆåŠŸå¼¹çª—
                    showSaveSuccessModal(savedCount);
                }
            }

            // iOS é¢„è§ˆæ¨¡å¼ - ç‚¹å‡»ä¿å­˜æŒ‰é’®è§¦å‘
            function showIosPreview() {
                iosCurrentIndex = 0;
                iosSavedIndicesSet.clear(); // é‡ç½®ä¿å­˜è¿½è¸ª
                updateIosPreview();
                document.getElementById('ios-preview-modal').classList.remove('hidden');
            }

            function closeIosPreview() {
                document.getElementById('ios-preview-modal').classList.add('hidden');
                const savedCount = iosSavedIndicesSet.size; // ç”¨æˆ·å®é™…é•¿æŒ‰ä¿å­˜çš„ç…§ç‰‡æ•°
                const totalPhotos = iosPreviewPhotos.length;
                iosPreviewPhotos = [];
                iosSavedIndicesSet.clear();
                // æ˜¾ç¤ºä¿å­˜å®Œæˆå¼¹çª—ï¼Œä½¿ç”¨å®é™…é•¿æŒ‰ä¿å­˜çš„æ•°é‡
                showIosSaveSuccessModal(savedCount, totalPhotos);
            }

            function updateIosPreview() {
                const img = document.getElementById('ios-preview-image');
                const counter = document.getElementById('ios-preview-counter');
                const prevBtn = document.getElementById('ios-prev-btn');
                const nextBtn = document.getElementById('ios-next-btn');
                const saveBtn = document.getElementById('ios-save-btn');

                img.src = iosPreviewPhotos[iosCurrentIndex];
                counter.textContent = `${iosCurrentIndex + 1} / ${iosPreviewPhotos.length}`;

                prevBtn.style.visibility = iosCurrentIndex > 0 ? 'visible' : 'hidden';

                // æœ€åä¸€å¼ æ—¶æ˜¾ç¤º"å®Œæˆ"
                if (iosCurrentIndex < iosPreviewPhotos.length - 1) {
                    nextBtn.innerHTML = 'ä¸‹ä¸€å¼ <i class="fas fa-chevron-right ml-2"></i>';
                } else {
                    nextBtn.innerHTML = '<i class="fas fa-check mr-2"></i>å®Œæˆ';
                }
            }

            function iosPrevPhoto() {
                if (iosCurrentIndex > 0) {
                    iosCurrentIndex--;
                    updateIosPreview();
                }
            }

            function iosNextPhoto() {
                if (iosCurrentIndex < iosPreviewPhotos.length - 1) {
                    iosCurrentIndex++;
                    updateIosPreview();
                } else {
                    closeIosPreview();
                }
            }

            // iOS ä¿å­˜å½“å‰å›¾ç‰‡ - æ‰“å¼€æ–°çª—å£è®©ç”¨æˆ·é•¿æŒ‰
            function iosSaveCurrentPhoto() {
                const dataUrl = iosPreviewPhotos[iosCurrentIndex];
                // åœ¨æ–°çª—å£ä¸­æ‰“å¼€å›¾ç‰‡ï¼Œç”¨æˆ·å¯ä»¥é•¿æŒ‰ä¿å­˜
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>é•¿æŒ‰ä¿å­˜å›¾ç‰‡</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 20px;
                                    background: #000;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: center;
                                    min-height: 100vh;
                                    box-sizing: border-box;
                                }
                                img {
                                    max-width: 100%;
                                    max-height: 80vh;
                                    -webkit-touch-callout: default;
                                    -webkit-user-select: auto;
                                }
                                p {
                                    color: white;
                                    text-align: center;
                                    margin-top: 20px;
                                    font-family: -apple-system, sans-serif;
                                }
                            </style>
                        </head>
                        <body>
                            <img src="${dataUrl}" />
                            <p>ğŸ‘† é•¿æŒ‰å›¾ç‰‡é€‰æ‹©"å­˜å‚¨å›¾åƒ"</p>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                    showToast(`å·²æ‰“å¼€ç¬¬ ${iosCurrentIndex + 1} å¼ ï¼Œè¯·é•¿æŒ‰ä¿å­˜`);
                } else {
                    // å¦‚æœå¼¹çª—è¢«æ‹¦æˆªï¼Œå°è¯•ç›´æ¥åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºæç¤º
                    showToast('è¯·é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜');
                }
            }

            // iOS é•¿æŒ‰ä¿å­˜æˆåŠŸæç¤ºï¼ˆä½¿ç”¨ touch äº‹ä»¶æ£€æµ‹é•¿æŒ‰ï¼‰
            (function setupIosSaveHint() {
                const previewImg = document.getElementById('ios-preview-image');
                const hint = document.getElementById('ios-save-success-hint');
                const hintText = document.getElementById('ios-hint-text');
                let hintTimeout = null;
                let longPressTimer = null;
                const LONG_PRESS_DURATION = 500; // iOS é•¿æŒ‰è§¦å‘æ—¶é—´çº¦ 500ms

                function showSaveHint(photoIndex) {
                    if (!hint) return;

                    // æ›´æ–°æç¤ºæ–‡å­—
                    if (hintText) {
                        hintText.textContent = `ç¬¬ ${photoIndex + 1} å¼  å·²ä¿å­˜`;
                    }

                    // æ˜¾ç¤ºä¿å­˜æç¤º
                    hint.classList.remove('opacity-0');
                    hint.classList.add('opacity-100');

                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (hintTimeout) {
                        clearTimeout(hintTimeout);
                    }

                    // 2.5ç§’åè‡ªåŠ¨éšè—
                    hintTimeout = setTimeout(function() {
                        hint.classList.remove('opacity-100');
                        hint.classList.add('opacity-0');
                    }, 2500);
                }

                if (previewImg && hint) {
                    // æ–¹æ³•1: ä½¿ç”¨ touchstart/touchend æ£€æµ‹é•¿æŒ‰
                    previewImg.addEventListener('touchstart', function(e) {
                        // å¼€å§‹è®¡æ—¶ï¼Œå¦‚æœæŒç»­ 500ms åˆ™è®¤ä¸ºæ˜¯é•¿æŒ‰
                        longPressTimer = setTimeout(function() {
                            longPressTimer = null; // è®¡æ—¶å™¨å·²è§¦å‘
                            // é•¿æŒ‰è§¦å‘ - è®°å½•æ­¤ç…§ç‰‡å·²ä¿å­˜
                            iosSavedIndicesSet.add(iosCurrentIndex);
                            // æ˜¾ç¤ºä¿å­˜æç¤º
                            showSaveHint(iosCurrentIndex);
                        }, LONG_PRESS_DURATION);
                    }, { passive: true });

                    previewImg.addEventListener('touchend', function(e) {
                        // æ‰‹æŒ‡æŠ¬èµ·ï¼Œæ¸…é™¤è®¡æ—¶å™¨ï¼ˆå¦‚æœè¿˜æ²¡è§¦å‘çš„è¯ï¼‰
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                    }, { passive: true });

                    previewImg.addEventListener('touchmove', function(e) {
                        // æ‰‹æŒ‡ç§»åŠ¨ï¼Œå–æ¶ˆé•¿æŒ‰æ£€æµ‹
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                    }, { passive: true });

                    previewImg.addEventListener('touchcancel', function(e) {
                        // è§¦æ‘¸å–æ¶ˆï¼Œæ¸…é™¤è®¡æ—¶å™¨
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                    }, { passive: true });

                    // æ–¹æ³•2: contextmenu ä½œä¸ºå¤‡ç”¨ï¼ˆæ¡Œé¢æµè§ˆå™¨ï¼‰
                    previewImg.addEventListener('contextmenu', function(e) {
                        // è®°å½•å½“å‰ç…§ç‰‡å·²è¢«é•¿æŒ‰
                        iosSavedIndicesSet.add(iosCurrentIndex);
                        // ç«‹å³æ˜¾ç¤ºæç¤º
                        showSaveHint(iosCurrentIndex);
                    });
                }
            })();

            // æ˜¾ç¤ºä¿å­˜æˆåŠŸå¼¹çª—ï¼ˆkawaii é£æ ¼ï¼‰
            function showSaveSuccessModal(count) {
                const modal = document.getElementById('save-success-modal');
                const countEl = document.getElementById('save-success-count');
                countEl.textContent = count;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            function closeSaveSuccessModal() {
                const modal = document.getElementById('save-success-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                location.href = 'home.html';
            }

            // iOS ä¸“ç”¨ä¿å­˜å®Œæˆå¼¹çª—ï¼ˆæ˜¾ç¤ºå®é™…ä¿å­˜æ•°é‡ï¼‰
            function showIosSaveSuccessModal(savedCount, totalPhotos) {
                const modal = document.getElementById('save-success-modal');
                const countEl = document.getElementById('save-success-count');
                const msgEl = document.getElementById('save-success-msg');

                if (savedCount === 0) {
                    // ç”¨æˆ·æ²¡æœ‰é•¿æŒ‰ä»»ä½•ç…§ç‰‡
                    countEl.textContent = '0';
                    if (msgEl) {
                        msgEl.innerHTML = `æ‚¨æœªä¿å­˜ä»»ä½•ç…§ç‰‡<br><span class="text-xs text-gray-400">æç¤ºï¼šé•¿æŒ‰å›¾ç‰‡åé€‰æ‹©"ä¿å­˜åˆ°'ç…§ç‰‡'"</span>`;
                    }
                } else if (savedCount < totalPhotos) {
                    // ç”¨æˆ·åªä¿å­˜äº†éƒ¨åˆ†ç…§ç‰‡
                    countEl.textContent = savedCount;
                    if (msgEl) {
                        msgEl.innerHTML = `å·²æ“ä½œ <span class="font-black text-[var(--primary-green)]">${savedCount}</span> å¼ ç…§ç‰‡ï¼ˆå…± ${totalPhotos} å¼ ï¼‰`;
                    }
                } else {
                    // ç”¨æˆ·ä¿å­˜äº†æ‰€æœ‰ç…§ç‰‡
                    countEl.textContent = savedCount;
                    if (msgEl) {
                        msgEl.textContent = `å·²æ“ä½œ ${savedCount} å¼ ç…§ç‰‡`;
                    }
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            // ç”Ÿæˆç…§ç‰‡ Data URLï¼ˆå«è´´çº¸åˆæˆï¼‰
            async function generatePhotoDataUrl(photoIndex) {
                return new Promise((resolve, reject) => {
                    const slide = document.querySelector(`.photo-slide:not(.clone)[data-index="${photoIndex}"]`);
                    if (!slide) {
                        reject(new Error('æ‰¾ä¸åˆ°ç…§ç‰‡'));
                        return;
                    }

                    const stickerLayer = slide.querySelector('.sticker-layer');

                    // åˆ›å»º canvas åˆæˆç…§ç‰‡å’Œè´´çº¸
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // ä½¿ç”¨å›ºå®šå°ºå¯¸ï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
                    const targetWidth = 800;
                    const targetHeight = 1200;
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;

                    // ç»˜åˆ¶èƒŒæ™¯å›¾
                    const tempImg = new Image();
                    tempImg.crossOrigin = 'anonymous';
                    tempImg.onload = () => {
                        // è®¡ç®—è£å‰ªåŒºåŸŸï¼ˆcover æ¨¡å¼ï¼‰
                        const imgRatio = tempImg.width / tempImg.height;
                        const canvasRatio = targetWidth / targetHeight;

                        let sx = 0, sy = 0, sw = tempImg.width, sh = tempImg.height;
                        if (imgRatio > canvasRatio) {
                            sw = tempImg.height * canvasRatio;
                            sx = (tempImg.width - sw) / 2;
                        } else {
                            sh = tempImg.width / canvasRatio;
                            sy = (tempImg.height - sh) / 2;
                        }

                        ctx.drawImage(tempImg, sx, sy, sw, sh, 0, 0, targetWidth, targetHeight);

                        // ç»˜åˆ¶è´´çº¸
                        if (stickerLayer) {
                            const stickers = stickerLayer.querySelectorAll('.sticker');
                            const layerRect = stickerLayer.getBoundingClientRect();

                            // è®¡ç®— layer åˆ° canvas çš„ç¼©æ”¾æ¯”ä¾‹
                            const scaleX = targetWidth / layerRect.width;
                            const scaleY = targetHeight / layerRect.height;

                            stickers.forEach(sticker => {
                                const stickerRect = sticker.getBoundingClientRect();

                                // è·å–è´´çº¸å†…å®¹ï¼ˆåªå– emojiï¼Œä¸å«æŒ‰é’®ï¼‰
                                const emoji = sticker.childNodes[0]?.textContent?.trim() || '';
                                if (!emoji) return;

                                // è·å–è´´çº¸çš„ç”¨æˆ·ç¼©æ”¾æ¯”ä¾‹
                                const transform = sticker.style.transform || '';
                                const scaleMatch = transform.match(/scale\(([\d.]+)\)/);
                                const userScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;

                                // è®¡ç®—è´´çº¸åœ¨ canvas ä¸­çš„ä½ç½®ï¼ˆç›¸å¯¹äº layer å·¦ä¸Šè§’ï¼‰
                                const x = (stickerRect.left - layerRect.left) * scaleX;
                                const y = (stickerRect.top - layerRect.top) * scaleY;

                                // è®¡ç®—è´´çº¸åœ¨ canvas ä¸­çš„å­—å·
                                // è´´çº¸åŸºç¡€å¤§å°æ˜¯ text-5xl = 3rem = 48px
                                // å®é™…æ¸²æŸ“å¤§å° = 48px * userScale
                                // canvas ä¸Šçš„å¤§å° = å®é™…æ¸²æŸ“å¤§å° * scaleYï¼ˆä½¿ç”¨ Y æ–¹å‘ç¼©æ”¾ï¼Œå› ä¸º emoji é«˜åº¦æ›´é‡è¦ï¼‰
                                const baseFontSize = 48; // text-5xl = 3rem = 48px
                                const fontSize = Math.round(baseFontSize * userScale * scaleY);

                                ctx.font = `${fontSize}px sans-serif`;
                                ctx.textBaseline = 'top';
                                ctx.fillText(emoji, x, y);
                            });
                        }

                        // è¿”å› data URL
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(dataUrl);
                    };

                    tempImg.onerror = () => reject(new Error('åŠ è½½å›¾ç‰‡å¤±è´¥'));
                    tempImg.src = photoSources[photoIndex];
                });
            }

            // ä¸‹è½½ç…§ç‰‡ï¼ˆé iOSï¼‰
            async function downloadPhoto(photoIndex) {
                const dataUrl = await generatePhotoDataUrl(photoIndex);

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `brushing_photo_${photoIndex + 1}_${Date.now()}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            // ===== STICKER MANAGEMENT =====
            let selectedSticker = null;

            // Deselect all stickers
            function deselectAllStickers() {
                document.querySelectorAll('.sticker.selected').forEach(s => {
                    s.classList.remove('selected');
                });
                selectedSticker = null;
            }

            // Click outside stickers to deselect
            canvas.addEventListener('click', (e) => {
                if (!e.target.closest('.sticker')) {
                    deselectAllStickers();
                }
            });

            // Make sticker draggable with button-based scaling and delete
            function makeStickerDraggable(sticker, layer) {
                let offsetX = 0, offsetY = 0;
                let currentScale = 1;

                // Add delete button
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    sticker.remove();
                    selectedSticker = null;
                };
                sticker.appendChild(deleteBtn);

                // Add scale buttons (- and +)
                const minusBtn = document.createElement('div');
                minusBtn.className = 'scale-btn minus';
                minusBtn.innerHTML = 'âˆ’';
                sticker.appendChild(minusBtn);

                const plusBtn = document.createElement('div');
                plusBtn.className = 'scale-btn plus';
                plusBtn.innerHTML = '+';
                sticker.appendChild(plusBtn);

                // Function to update button sizes inversely to sticker scale
                function updateButtonScales() {
                    const inverseScale = 1 / currentScale;
                    deleteBtn.style.transform = `scale(${inverseScale})`;
                    minusBtn.style.transform = `scale(${inverseScale})`;
                    plusBtn.style.transform = `scale(${inverseScale})`;
                }

                minusBtn.onclick = (e) => {
                    e.stopPropagation();
                    currentScale = Math.max(0.5, currentScale - 0.2);
                    sticker.style.transform = `scale(${currentScale})`;
                    updateButtonScales();
                };

                plusBtn.onclick = (e) => {
                    e.stopPropagation();
                    currentScale = Math.min(3, currentScale + 0.2);
                    sticker.style.transform = `scale(${currentScale})`;
                    updateButtonScales();
                };

                // Touch events - only drag, no pinch zoom
                sticker.addEventListener('touchstart', (e) => {
                    // Don't prevent default on buttons
                    if (e.target.closest('.delete-btn') || e.target.closest('.scale-btn')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();

                    // Select sticker
                    deselectAllStickers();
                    sticker.classList.add('selected');
                    selectedSticker = sticker;

                    sticker.classList.add('dragging');
                    const touch = e.touches[0];
                    const rect = sticker.getBoundingClientRect();
                    offsetX = touch.clientX - rect.left;
                    offsetY = touch.clientY - rect.top;
                }, { passive: false });

                sticker.addEventListener('touchmove', (e) => {
                    if (e.target.closest('.delete-btn') || e.target.closest('.scale-btn')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();

                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        const layerRect = layer.getBoundingClientRect();
                        let newX = touch.clientX - layerRect.left - offsetX;
                        let newY = touch.clientY - layerRect.top - offsetY;
                        newX = Math.max(0, Math.min(newX, layerRect.width - sticker.offsetWidth));
                        newY = Math.max(0, Math.min(newY, layerRect.height - sticker.offsetHeight));
                        sticker.style.left = newX + 'px';
                        sticker.style.top = newY + 'px';
                    }
                }, { passive: false });

                sticker.addEventListener('touchend', (e) => {
                    sticker.classList.remove('dragging');
                });

                // Mouse events for desktop
                sticker.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.delete-btn') || e.target.closest('.scale-btn')) {
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();

                    deselectAllStickers();
                    sticker.classList.add('selected');
                    selectedSticker = sticker;

                    sticker.classList.add('dragging');
                    const rect = sticker.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;

                    const onMouseMove = (e) => {
                        const layerRect = layer.getBoundingClientRect();
                        let newX = e.clientX - layerRect.left - offsetX;
                        let newY = e.clientY - layerRect.top - offsetY;
                        newX = Math.max(0, Math.min(newX, layerRect.width - sticker.offsetWidth));
                        newY = Math.max(0, Math.min(newY, layerRect.height - sticker.offsetHeight));
                        sticker.style.left = newX + 'px';
                        sticker.style.top = newY + 'px';
                    };

                    const onMouseUp = () => {
                        sticker.classList.remove('dragging');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                // Mouse wheel zoom for desktop (keep this for desktop users)
                sticker.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    currentScale = Math.max(0.5, Math.min(3, currentScale + delta));
                    sticker.style.transform = `scale(${currentScale})`;
                    updateButtonScales();
                }, { passive: false });
            }

            // ===== STICKER BUTTON FUNCTIONALITY =====
            const stickerBtns = document.querySelectorAll('.sticker-btn');

            stickerBtns.forEach(btn => {
                btn.onclick = () => {
                    const stickerEmoji = btn.dataset.sticker;
                    const currentStickerLayer = document.getElementById(`sticker-layer-${getRealIndex(currentSlidePosition)}`);

                    const newSticker = document.createElement('div');
                    newSticker.textContent = stickerEmoji;
                    newSticker.className = 'sticker absolute text-5xl';

                    // Position randomly to avoid overlap
                    const randomTop = Math.floor(Math.random() * 60) + 10;
                    const randomLeft = Math.floor(Math.random() * 60) + 10;
                    newSticker.style.top = randomTop + '%';
                    newSticker.style.left = randomLeft + '%';

                    currentStickerLayer.appendChild(newSticker);
                    makeStickerDraggable(newSticker, currentStickerLayer);

                    // Select new sticker to show controls
                    deselectAllStickers();
                    newSticker.classList.add('selected');
                    selectedSticker = newSticker;

                    // Auto-hide controls after 2 seconds
                    setTimeout(() => {
                        if (selectedSticker === newSticker) {
                            deselectAllStickers();
                        }
                    }, 2000);

                    // Visual feedback
                    btn.classList.add('ring-4', 'ring-[var(--accent-yellow)]');
                    setTimeout(() => btn.classList.remove('ring-4', 'ring-[var(--accent-yellow)]'), 300);

                    showToast('ç‚¹å‡»è´´çº¸è°ƒæ•´ Â· æ‹–åŠ¨ç§»åŠ¨');
                };
            });
        </script>

        <button class="w-full kawaii-button kawaii-button-yellow mt-2 py-2 text-sm"
            onclick="showToast('åˆ†äº«åŠŸèƒ½ä»…åœ¨å®Œæ•´ç‰ˆä¸­å¯ç”¨ï¼')">
            <i class="fas fa-share-alt mr-2"></i> åˆ†äº«ç»™å¥½æœ‹å‹
        </button>
    </div>

    <script>
        // è´´çº¸ç›®å½•
        const ALL_STICKERS = {
            star: { id: 'star', emoji: 'â­ï¸', name: 'æ˜Ÿæ˜Ÿ' },
            heart: { id: 'heart', emoji: 'ğŸ’–', name: 'çˆ±å¿ƒ' },
            sparkle: { id: 'sparkle', emoji: 'âœ¨', name: 'é—ªå…‰' },
            rainbow: { id: 'rainbow', emoji: 'ğŸŒˆ', name: 'å½©è™¹' },
            cupcake: { id: 'cupcake', emoji: 'ğŸ§', name: 'è›‹ç³•' },
            crown: { id: 'crown', emoji: 'ğŸ‘‘', name: 'çš‡å† ' },
            unicorn: { id: 'unicorn', emoji: 'ğŸ¦„', name: 'ç‹¬è§’å…½' },
            moon: { id: 'moon', emoji: 'ğŸŒ™', name: 'æœˆäº®' },
            sun: { id: 'sun', emoji: 'â˜€ï¸', name: 'å¤ªé˜³' },
            flower: { id: 'flower', emoji: 'ğŸŒ¸', name: 'èŠ±æœµ' },
            butterfly: { id: 'butterfly', emoji: 'ğŸ¦‹', name: 'è´è¶' },
            rocket: { id: 'rocket', emoji: 'ğŸš€', name: 'ç«ç®­' }
        };

        // ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·è´´çº¸
        async function loadUserStickers() {
            const profileId = localStorage.getItem('activeProfileId');
            if (!profileId) {
                console.log('No profile ID, using default stickers');
                return;
            }

            try {
                const userStickers = await BrushingMasterDB.getUserStickers(profileId);
                const ownedStickerIds = userStickers.map(s => s.sticker_id);
                console.log('ç”¨æˆ·æ‹¥æœ‰çš„è´´çº¸:', ownedStickerIds);

                // æ›´æ–°è´´çº¸æ 
                updateStickerTray(ownedStickerIds);
            } catch (error) {
                console.error('åŠ è½½è´´çº¸å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è´´çº¸æ UI
        function updateStickerTray(ownedStickerIds) {
            const tray = document.getElementById('sticker-tray');
            let html = '';

            // æ˜¾ç¤ºå·²æ‹¥æœ‰çš„è´´çº¸
            Object.values(ALL_STICKERS).forEach(sticker => {
                if (ownedStickerIds.includes(sticker.id)) {
                    html += `
                        <div class="flex-shrink-0 w-14 h-14 kawaii-card flex items-center justify-center text-2xl cursor-pointer active:scale-95 transition-transform sticker-btn"
                            data-sticker="${sticker.emoji}">${sticker.emoji}</div>
                    `;
                }
            });

            // æ·»åŠ é”å®šçš„è´´çº¸å ä½ç¬¦
            const lockedCount = Math.max(0, 3 - (12 - ownedStickerIds.length));
            for (let i = ownedStickerIds.length; i < Math.min(ownedStickerIds.length + 2, 12); i++) {
                html += `
                    <div class="flex-shrink-0 w-14 h-14 kawaii-card bg-gray-100 border-dashed flex items-center justify-center text-gray-400">
                        <i class="fas fa-lock text-sm"></i>
                    </div>
                `;
            }

            tray.innerHTML = html;

            // é‡æ–°ç»‘å®šè´´çº¸ç‚¹å‡»äº‹ä»¶
            rebindStickerEvents();
        }

        // é‡æ–°ç»‘å®šè´´çº¸äº‹ä»¶
        function rebindStickerEvents() {
            const stickerBtns = document.querySelectorAll('.sticker-btn');
            stickerBtns.forEach(btn => {
                btn.onclick = () => {
                    const emoji = btn.dataset.sticker;
                    const slides = document.querySelectorAll('.photo-slide:not(.clone)');
                    const realIndex = getRealIndex(currentSlidePosition);
                    const currentSlide = slides[realIndex];
                    const currentStickerLayer = currentSlide?.querySelector('.sticker-layer');

                    if (!currentStickerLayer) return;

                    const newSticker = document.createElement('div');
                    newSticker.className = 'sticker text-5xl';
                    newSticker.textContent = emoji;
                    newSticker.innerHTML += `
                        <div class="delete-btn" onclick="event.stopPropagation(); this.parentElement.remove();"><i class="fas fa-times"></i></div>
                        <div class="scale-btn minus" onclick="event.stopPropagation(); scaleSticker(this.parentElement, 0.9);">âˆ’</div>
                        <div class="scale-btn plus" onclick="event.stopPropagation(); scaleSticker(this.parentElement, 1.1);">+</div>
                    `;
                    newSticker.dataset.scale = '1';

                    const randomTop = 20 + Math.random() * 50;
                    const randomLeft = 10 + Math.random() * 60;
                    newSticker.style.position = 'absolute';
                    newSticker.style.top = randomTop + '%';
                    newSticker.style.left = randomLeft + '%';

                    currentStickerLayer.appendChild(newSticker);
                    makeStickerDraggable(newSticker, currentStickerLayer);

                    deselectAllStickers();
                    newSticker.classList.add('selected');
                    selectedSticker = newSticker;

                    setTimeout(() => {
                        if (selectedSticker === newSticker) {
                            deselectAllStickers();
                        }
                    }, 2000);

                    btn.classList.add('ring-4', 'ring-[var(--accent-yellow)]');
                    setTimeout(() => btn.classList.remove('ring-4', 'ring-[var(--accent-yellow)]'), 300);

                    showToast('ç‚¹å‡»è´´çº¸è°ƒæ•´ Â· æ‹–åŠ¨ç§»åŠ¨');
                };
            });
        }

        // Initialize
        updateUI();
        loadUserStickers();
        loadCapturedPhotos(); // åŠ è½½æŠ“æ‹ç…§ç‰‡
    </script>

</body>

</html>