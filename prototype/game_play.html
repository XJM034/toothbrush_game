<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="auth_guard.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="shared_styles.css">
    <script src="mobile_fixes.js"></script>
    <title>Game - Brushing Master</title>
    <style>
        .camera-bg {
            background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://images.unsplash.com/photo-1542385151-54070a2f4dc1?q=80&w=1000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }

        .bacteria {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body class="h-screen camera-bg flex flex-col relative overflow-hidden safe-area-top">

    <!-- UI Overlays -->
    <div class="absolute inset-x-0 top-12 px-6 flex justify-between items-start pointer-events-none">
        <div class="kawaii-card bg-white p-3 flex items-center gap-3">
            <div class="text-xs font-black">
                <div class="text-xs text-gray-400 uppercase">能量值</div>
                <div class="text-[var(--primary-green)]" id="timer-display"></div>
            </div>
            <script>
                // 立即显示正确的初始时间和进度条（避免闪烁）
                (function () {
                    const dur = parseInt(localStorage.getItem('selectedDuration')) || 2;
                    document.getElementById('timer-display').textContent = dur + ':00';
                })();
            </script>
            <div class="w-24 kawaii-progress-bg">
                <div class="kawaii-progress-fill" id="progress-bar" style="width: 100%"></div>
            </div>
        </div>
        <div
            class="kawaii-button kawaii-button-red w-12 h-12 rounded-full flex items-center justify-center pointer-events-auto">
            <i class="fas fa-times"></i>
        </div>
    </div>

    <!-- Bacteria Targets -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <div class="grid grid-cols-2 gap-20">
            <div class="bacteria text-green-400 text-6xl drop-shadow-[0_4px_0_#333]">
                <i class="fas fa-virus"></i>
            </div>
            <div class="bacteria text-purple-400 text-7xl drop-shadow-[0_4px_0_#333]" style="animation-delay: 0.5s">
                <i class="fas fa-biohazard"></i>
            </div>
            <div class="bacteria text-yellow-400 text-5xl drop-shadow-[0_4px_0_#333]" style="animation-delay: 0.2s">
                <i class="fas fa-bacteria"></i>
            </div>
            <div class="bacteria text-green-300 text-6xl drop-shadow-[0_4px_0_#333]" style="animation-delay: 0.8s">
                <i class="fas fa-virus-slash"></i>
            </div>
        </div>
    </div>

    <!-- Face Guide -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
        <div class="w-64 h-80 border-4 border-dashed border-white opacity-40 rounded-[100px]"></div>
    </div>

    <!-- Bottom Action Info -->
    <div class="absolute inset-x-0 bottom-12 px-8">
        <div class="kawaii-card text-center py-4 bg-white bg-opacity-90">
            <div class="flex items-center justify-center gap-4 mb-2">
                <div
                    class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center overflow-hidden opacity-30">
                    <img src="owl_mascot.svg" class="w-2/3 h-2/3 object-contain" />
                </div>
                <div class="text-xl font-black text-[var(--primary-green)] uppercase">猫头鹰特训！</div>
                <div
                    class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center overflow-hidden opacity-30">
                    <img src="owl_mascot.svg" class="w-2/3 h-2/3 object-contain" />
                </div>
            </div>
            <p class="text-xs font-black uppercase text-gray-400">动起来！帮助小猫头鹰变强！</p>
        </div>
    </div>

    <!-- 退出确认弹框 -->
    <div id="exit-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-6">
        <div class="bg-white rounded-[32px] border-4 border-[#333] w-full max-w-sm shadow-[8px_8px_0_#333] overflow-hidden transform transition-all duration-300 scale-95 opacity-0"
            id="exit-modal-content">
            <div class="p-6">
                <!-- 警告图标 -->
                <div class="text-center mb-4">
                    <div
                        class="w-16 h-16 mx-auto bg-red-100 rounded-full border-4 border-[#333] flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                </div>

                <!-- 提示文字 -->
                <h2 class="text-xl font-black text-center mb-2">确定要退出吗？</h2>
                <p class="text-center text-gray-500 text-sm mb-6">本次刷牙进度将不会保存</p>

                <!-- 按钮 -->
                <div class="flex gap-4">
                    <button class="flex-1 kawaii-button kawaii-button-primary py-3 text-sm font-black"
                        onclick="closeExitModal()">继续刷牙</button>
                    <button class="flex-1 kawaii-button kawaii-button-red py-3 text-sm font-black"
                        onclick="confirmExit()">退出</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Effect (Mockup) -->
    <div class="absolute inset-0 bg-white opacity-0 transition-opacity pointer-events-none" id="flash"></div>

    <script>
        // ===== GAME SESSION STATE =====
        const selectedDuration = parseInt(localStorage.getItem('selectedDuration')) || 2; // 获取选择的时长
        let energyTime = selectedDuration * 60; // 转换为秒
        let germsKilled = 0;
        let lastGermKillTime = 0;

        const energyDisplay = document.querySelector('.text-\\[var\\(--primary-green\\)\\]');
        const progressFill = document.querySelector('.kawaii-progress-fill');
        const exitBtn = document.querySelector('.kawaii-button-red');

        exitBtn.onclick = () => {
            showExitModal();
        };

        // 退出确认弹框函数
        function showExitModal() {
            const modal = document.getElementById('exit-modal');
            const content = document.getElementById('exit-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeExitModal() {
            const modal = document.getElementById('exit-modal');
            const content = document.getElementById('exit-modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function confirmExit() {
            location.href = 'home.html';
        }

        // 模拟击败细菌（每2秒击败1-3个细菌）
        function simulateGermKill() {
            const now = Date.now();
            if (now - lastGermKillTime > 2000) {
                germsKilled += Math.floor(Math.random() * 3) + 1;
                lastGermKillTime = now;
            }
        }

        // 获取连续天数
        function getStreakDays() {
            const streak = localStorage.getItem('streakDays');
            return streak ? parseInt(streak) : 1;
        }

        // 更新连续天数
        function updateStreak() {
            const lastBrushDate = localStorage.getItem('lastBrushDate');
            const today = new Date().toISOString().split('T')[0];

            if (lastBrushDate === today) {
                // 今天已经刷过，不更新
                return getStreakDays();
            }

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            let streak = 1;
            if (lastBrushDate === yesterdayStr) {
                // 昨天刷过，连续天数+1
                streak = getStreakDays() + 1;
            }

            localStorage.setItem('streakDays', streak.toString());
            localStorage.setItem('lastBrushDate', today);
            return streak;
        }

        // 游戏结束，跳转到结果页
        function endGame() {
            const streakDays = updateStreak();

            // 保存游戏结果到 sessionStorage
            sessionStorage.setItem('lastGameResult', JSON.stringify({
                duration: selectedDuration,
                germsKilled: germsKilled,
                streakDays: streakDays
            }));

            location.href = 'game_result.html';
        }

        const timer = setInterval(() => {
            energyTime--;
            simulateGermKill(); // 模拟击败细菌

            const mins = Math.floor(energyTime / 60);
            const secs = energyTime % 60;
            energyDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            // 更新进度条
            const totalTime = selectedDuration * 60;
            const progress = (energyTime / totalTime) * 100;
            progressFill.style.width = `${progress}%`;

            if (energyTime <= 0) {
                clearInterval(timer);
                endGame();
            }
        }, 1000);

        // 演示模式：5秒后自动结束（方便测试）
        // 取消下面的注释可以快速测试
        // setTimeout(() => { germsKilled = 42; clearInterval(timer); endGame(); }, 5000);
    </script>

</body>

</html>